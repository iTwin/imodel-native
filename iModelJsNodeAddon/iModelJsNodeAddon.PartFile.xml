<?xml version="1.0" encoding="utf-8"?>

<BuildContext xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="../bsicommon/build/PartFile.xsd">

  <Part Name="MakePackages" BentleyBuildMakeFile="makePackages.mke" OnlyPlatforms="x64,LinuxX64,MacOSx64" PrgOutputDir="iModelJsNodeAddon">
    <SubProduct ProductName="iModelJsNodeAddon"/>
  </Part>

  <Product Name="iModelJsNodeAddon">
    <SubProduct ProductName="iModelJsNodeAddon-Windows" />
    <SubProduct ProductName="iModelJsNodeAddon-Linux" />
    <SubProduct ProductName="iModelJsNodeAddon-Darwin" />
  </Product>

  <Product Name="iModelJsNodeAddon-Windows">
    <SubPart PartName="iModelJsNodeAddonLib-Windows" LibType="Dynamic" />
    <SubPart PartName="iModelJsNodeAddonLibElectron-Windows" LibType="Dynamic" />
    <Directories DirectoryListName="iModelJsNodeAddonDeliveryList" />
  </Product>

  <Product Name="iModelJsNodeAddon-Linux">
    <SubPart PartName="iModelJsNodeAddonLib-Linux" LibType="Static" />
    <Directories DirectoryListName="iModelJsNodeAddonDeliveryList" />
  </Product>

  <Product Name="iModelJsNodeAddon-Darwin">
    <SubPart PartName="iModelJsNodeAddonLib-Darwin" LibType="Static" />
    <Directories DirectoryListName="iModelJsNodeAddonDeliveryList" />
  </Product>

  <ProductDirectoryList ListName="iModelJsNodeAddonDeliveryList">
    <ProductDirectory Name="AddonRoot" Path="Addon" />
    <ProductDirectory Name="iModelJsNode_node_module" RelativeTo="AddonRoot"/>
    <ProductDirectory Name="iModelJsNode_node_module" RelativeTo="AddonRoot" LibType="Static" />
    <ProductDirectory Name="SupportingFilesRoot" Path="Support" />
    <ProductDirectory Name="Assemblies" Path="" RelativeTo="SupportingFilesRoot"/>
    <ProductDirectory Name="Assemblies" Deliver="false" LibType="Static"/>
    <ProductDirectory Name="Assets" Path="Assets" RelativeTo="SupportingFilesRoot"/>
    <ProductDirectory Name="Assets" Path="Assets" RelativeTo="SupportingFilesRoot" LibType="Static"/>

    <ProductDirectory Name="PresentationRules" Path="PresentationRules" RelativeTo="SupportingFilesRoot"/>
    <ProductDirectory Name="PresentationRules" Path="PresentationRules" RelativeTo="SupportingFilesRoot" LibType="Static"/>

    <ProductDirectory Name="VendorNotices"  RelativeTo="SupportingFilesRoot" Path="Notices"/>
    <ProductDirectory Name="VendorNotices"  RelativeTo="SupportingFilesRoot" Path="Notices" LibType="static"/>
  </ProductDirectoryList>

  <!-- 
            *** ProductDirectoryName="iModelJsNode_node_module" ProductSubDirectory="<version>" ***
      
            *** Keep this consistent with makePackages.mke/py and imodeljs-core/nodeaddon/NodeAddon.ts. ***
      
      In the addon-creation parts below, the ProductSubDirectory name contains the version of nodejs that the addon requires.
      Downstream consumers expect the major_minor[_patch] formatting of the name.
      
  -->

  <Part Name="iModelJsNodeAddonLib-Mobile" BentleyBuildMakeFile="addon.mke" BentleyBuildMakeOptions="-dNODE_ADDON_API=iModelJs -dBUILD_AS_IMODELJS_LIBRARY=1" >
    <!-- Get the node-addon-api implementation from iModelJs, not from node! -->
    <SubPart PartName="iModelJs" PartFile="iModelJs" Repository="iModelJs"/>
    <SubPart PartName="iModelJsNodeAddonLibCommon"/>
    <Bindings>
        <Libs>Delivery/$(libprefix)imodeljs-addon-iModelJs$(libext)</Libs>
        <Assemblies>Delivery/$(shlibprefix)imodeljs-addon-iModelJs$(shlibext)</Assemblies>
        <Files ProductDirectoryName="Assets" ProductSubDirectory="PresentationRules">
        Delivery/PresentationRules/*.xml
      </Files>
    </Bindings>
  </Part>
  
  <Part Name="iModelJsNodeAddonLib-Windows" OnlyPlatforms="x64" ExcludeLibType="Static" BentleyBuildMakeFile="addon.mke" BentleyBuildMakeOptions="-dNODE_ADDON_API=node-addon-api" >
    <SubPart PartName="node-addon-api" Repository="Thirdparty-node-addon-api" PartFile="node-addon-api"/>
    <SubPart PartName="iModelJsNodeAddonLibCommon"/>
    <Bindings>
      <Files ProductDirectoryName="iModelJsNode_node_module" ProductSubDirectory="n_8_9">
        Delivery/iModelJsNodeAddon/node-addon-api/imodeljs.node
      </Files>
      <Files ProductDirectoryName="Assets" ProductSubDirectory="PresentationRules">
        Delivery/PresentationRules/*.xml
      </Files>
    </Bindings>
  </Part>

  <!-- NB: Keep this version number consistent with nodejs:node-gyp-electron -->
  <Part Name="iModelJsNodeAddonLibElectron-Windows" OnlyPlatforms="x64" ExcludeLibType="Static" BentleyBuildMakeFile="addon.mke" BentleyBuildMakeOptions="-dNODE_ADDON_API=electron-addon-api" >
    <SubPart PartName="electron-addon-api" Repository="Thirdparty-node-addon-api" PartFile="node-addon-api" />
    <SubPart PartName="iModelJsNodeAddonLibCommon"/>
    <Bindings>
      <!-- The ProductSubDirectory name determines the name of subdirectory created by makeImodelJsAddonPackages.mke, and that must match the version of electron node that is running. -->
      <Files ProductDirectoryName="iModelJsNode_node_module" ProductSubDirectory="e_1_6_11">
        Delivery/iModelJsNodeAddon/electron-addon-api/imodeljs.node
      </Files>
      <Files ProductDirectoryName="Assets" ProductSubDirectory="PresentationRules">
        Delivery/PresentationRules/*.xml
      </Files>
    </Bindings>
  </Part>

  <Part Name="iModelJsNodeAddonLib-Linux" OnlyPlatforms="Linux*" ExcludeLibType="Dynamic" BentleyBuildMakeFile="addon.mke" BentleyBuildMakeOptions="-dNODE_ADDON_API=node-addon-api" >
    <SubPart PartName="node-addon-api" Repository="Thirdparty-node-addon-api" PartFile="node-addon-api"/>
    <SubPart PartName="iModelJsNodeAddonLibCommon"/>
    <Bindings>
      <Files ProductDirectoryName="iModelJsNode_node_module" ProductSubDirectory="n_8_9">
        Delivery/iModelJsNodeAddon/node-addon-api/imodeljs.node
      </Files>
      <Files ProductDirectoryName="Assets" ProductSubDirectory="PresentationRules">
        Delivery/PresentationRules/*.xml
      </Files>	  
    </Bindings>
  </Part>

  <Part Name="iModelJsNodeAddonLib-Darwin" OnlyPlatforms="MacOSX64" ExcludeLibType="Dynamic" BentleyBuildMakeFile="addon.mke" BentleyBuildMakeOptions="-dNODE_ADDON_API=node-addon-api" >
    <SubPart PartName="node-addon-api" Repository="Thirdparty-node-addon-api" PartFile="node-addon-api"/>
    <SubPart PartName="iModelJsNodeAddonLibCommon"/>
    <Bindings>
      <Files ProductDirectoryName="iModelJsNode_node_module" ProductSubDirectory="n_8_9">
        Delivery/iModelJsNodeAddon/node-addon-api/imodeljs.node
      </Files>
      <Files ProductDirectoryName="Assets" ProductSubDirectory="PresentationRules">
        Delivery/PresentationRules/*.xml
      </Files>	  
    </Bindings>
  </Part>

<!-- This part builds our node native code addon -->
  <Part Name="iModelJsNodeAddonLibCommon">
    <SubPart PartName="DgnPlatformDLL" PartFile="DgnPlatform" Repository="DgnPlatform"/>
    <SubPart PartName="DgnPlatformSqlang" Repository="DgnPlatform" PartFile="DgnPlatform"/>
    <SubPart PartName="ECPresentation" PartFile="ECPresentation" Repository="ECPresentation"/>
    <SubPart PartName="ECObjectsNative"     PartFile="ECObjects"    Repository="ecobjects" />
    <SubPart PartName="RapidJson" PartFile="Libsrc-Nugets" Repository="bsicommon"/>
  </Part>

</BuildContext>
