<?xml version="1.0" encoding="utf-8"?>

<BuildContext xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="../bsicommon/build/PartFile.xsd">

  <Part Name="iModelJsNodeAddon.Dev" PrgOutputDir="iModelJsNodeAddon">
    <SubPart PartName="iModelCorePRG" PartFile="iModelCore/DgnPlatform/iModelCore" Repository="imodel02"/>
    <SubPart PartName="MakePackages"/>
  </Part>
  
  <Part Name="MakePackages" BentleyBuildMakeFile="makePackages.mke" OnlyPlatforms="x64,LinuxX64,MacOSx64" PrgOutputDir="iModelJsNodeAddon">
    <SubProduct ProductName="iModelJsNodeAddon"/>
  </Part>

  <Product Name="iModelJsNodeAddon">
    <SubProduct ProductName="iModelJsNodeAddon-Windows" />
    <SubProduct ProductName="iModelJsNodeAddon-Linux" />
    <SubProduct ProductName="iModelJsNodeAddon-Darwin" />
  </Product>

  <Product Name="iModelJsNodeAddon-Windows">
    <SubPart PartName="iModelJsNodeAddonLib-Windows" LibType="Dynamic" />
    <SubPart PartName="iModelJsNodeAddonLibElectron-Windows" LibType="Dynamic" />
    <Directories DirectoryListName="iModelJsNodeAddonDeliveryList" />
  </Product>

  <Product Name="iModelJsNodeAddon-Linux">
    <SubPart PartName="iModelJsNodeAddonLib-Linux" LibType="Static" />
    <SubPart PartName="iModelJsNodeAddonLibElectron-Linux" LibType="Static" />
    <Directories DirectoryListName="iModelJsNodeAddonDeliveryList" />
  </Product>

  <Product Name="iModelJsNodeAddon-Darwin">
    <SubPart PartName="iModelJsNodeAddonLib-Darwin" LibType="Static" />
    <SubPart PartName="iModelJsNodeAddonLibElectron-Darwin" LibType="Static" />
    <Directories DirectoryListName="iModelJsNodeAddonDeliveryList" />
  </Product>

  <ProductDirectoryList ListName="iModelJsNodeAddonDeliveryList">
    <ProductDirectory Name="AddonRoot" Path="Addon" />
    <ProductDirectory Name="iModelJsNode_node_module" RelativeTo="AddonRoot"/>
    <ProductDirectory Name="iModelJsNode_node_module" RelativeTo="AddonRoot" LibType="Static" />
    <ProductDirectory Name="SupportingFilesRoot" Path="Support" />
    <ProductDirectory Name="Assemblies" Path="" RelativeTo="SupportingFilesRoot"/>
    <ProductDirectory Name="Assemblies" Deliver="false" LibType="Static"/>
    <ProductDirectory Name="Assets" Path="Assets" RelativeTo="SupportingFilesRoot"/>
    <ProductDirectory Name="Assets" Path="Assets" RelativeTo="SupportingFilesRoot" LibType="Static"/>

    <ProductDirectory Name="PresentationRules" Path="PresentationRules" RelativeTo="SupportingFilesRoot"/>
    <ProductDirectory Name="PresentationRules" Path="PresentationRules" RelativeTo="SupportingFilesRoot" LibType="Static"/>

    <ProductDirectory Name="VendorNotices"  RelativeTo="SupportingFilesRoot" Path="Notices"/>
    <ProductDirectory Name="VendorNotices"  RelativeTo="SupportingFilesRoot" Path="Notices" LibType="static"/>
  </ProductDirectoryList>

  <!-- 
            *** ProductDirectoryName="iModelJsNode_node_module" ProductSubDirectory="<version>" ***
      
            *** Keep this consistent with makePackages.mke/py and imodeljs-core/nodeaddon/NodeAddon.ts. ***
      
      In the addon-creation parts below, the ProductSubDirectory name contains the version of nodejs that the addon requires.
      Downstream consumers expect the major_minor[_patch] formatting of the name.
      
  -->

  <Part Name="iModelJsNodeAddonLib-Mobile" BentleyBuildMakeFile="IModelJsNative.mke" BentleyBuildMakeOptions="-dNODE_ADDON_API=iModelJs -dBUILD_FOR_IMODELJS_MOBILE=1" >
    <!-- Get the node-addon-api (declaration) from iModelJs, not from node! -->
    <SubPart PartName="node-addon-api" PartFile="iModelJsMobile/iModelJsMobile" Repository="imodel02"/>
    <SubPart PartName="iModelJsNodeAddonLibCommon"/>
    <SubPart PartName="iModelJsNodeAddonSqlang"/>
    <Bindings>
        <Directory SourceName="Delivery/imodeljs-addon-iModelJs-objs" SubPartDirectory="imodeljs-addon-objs" />
        <Files SubPartDirectory="imodeljs-addon-build-tools">
            Delivery/IModelJsNative_input_libs.mki
        </Files>
        <Files ProductDirectoryName="Assets" ProductSubDirectory="PresentationRules">
            Delivery/PresentationRules/*.xml
        </Files>
    </Bindings>
  </Part>
  
  <Part Name="iModelJsNodeAddonLib-Windows" OnlyPlatforms="x64" ExcludeLibType="Static" BentleyBuildMakeFile="IModelJsNative.mke" BentleyBuildMakeOptions="-dNODE_ADDON_API=node-addon-api" >
    <SubPart PartName="node-addon-api" Repository="Thirdparty-node-addon-api" PartFile="node-addon-api"/>
    <SubPart PartName="iModelJsNodeAddonLibCommon"/>
    <SubPart PartName="iModelJsNodeAddonSqlang"/>
    <Bindings>
      <!-- KEEP THIS CONSISTENT WITH api_package\install-imodeljs-native.js -->
      <Files ProductDirectoryName="iModelJsNode_node_module" ProductSubDirectory="n_8">
        Delivery/iModelJsNodeAddon/node-addon-api/imodeljs.node
      </Files>
      <Files ProductDirectoryName="Assets" ProductSubDirectory="PresentationRules">
        Delivery/PresentationRules/*.xml
      </Files>
    </Bindings>
  </Part>

  <!-- NB: Keep this version number consistent with nodejs:node-gyp-electron -->
  <Part Name="iModelJsNodeAddonLibElectron-Windows" OnlyPlatforms="x64" ExcludeLibType="Static" BentleyBuildMakeFile="IModelJsNative.mke" BentleyBuildMakeOptions="-dNODE_ADDON_API=electron-addon-api" >
    <SubPart PartName="electron-addon-api" Repository="Thirdparty-node-addon-api" PartFile="node-addon-api" />
    <SubPart PartName="iModelJsNodeAddonLibCommon"/>
    <SubPart PartName="iModelJsNodeAddonSqlang"/>
    <Bindings>
      <!-- The ProductSubDirectory name determines the name of subdirectory created by makeImodelJsAddonPackages.mke, and that must match the version of electron node that is running. -->
      <!-- KEEP THIS CONSISTENT WITH api_package\install-imodeljs-native.js -->
      <Files ProductDirectoryName="iModelJsNode_node_module" ProductSubDirectory="e_2">
        Delivery/iModelJsNodeAddon/electron-addon-api/imodeljs.node
      </Files>
      <Files ProductDirectoryName="Assets" ProductSubDirectory="PresentationRules">
        Delivery/PresentationRules/*.xml
      </Files>
    </Bindings>
  </Part>

  <Part Name="iModelJsNodeAddonLib-Linux" OnlyPlatforms="Linux*" ExcludeLibType="Dynamic" BentleyBuildMakeFile="IModelJsNative.mke" BentleyBuildMakeOptions="-dNODE_ADDON_API=node-addon-api" >
    <SubPart PartName="node-addon-api" Repository="Thirdparty-node-addon-api" PartFile="node-addon-api"/>
    <SubPart PartName="iModelJsNodeAddonLibCommon"/>
    <SubPart PartName="iModelJsNodeAddonSqlang"/>
    <Bindings>
        <Files ProductDirectoryName="iModelJsNode_node_module" ProductSubDirectory="n_8">
        Delivery/iModelJsNodeAddon/node-addon-api/imodeljs.node
      </Files>
      <Files ProductDirectoryName="Assets" ProductSubDirectory="PresentationRules">
        Delivery/PresentationRules/*.xml
      </Files>	  
    </Bindings>
  </Part>

  <Part Name="iModelJsNodeAddonLibElectron-Linux" OnlyPlatforms="Linux*" ExcludeLibType="Dynamic" BentleyBuildMakeFile="IModelJsNative.mke" BentleyBuildMakeOptions="-dNODE_ADDON_API=electron-addon-api" >
    <SubPart PartName="electron-addon-api" Repository="Thirdparty-node-addon-api" PartFile="node-addon-api"/>
    <SubPart PartName="iModelJsNodeAddonLibCommon"/>
    <SubPart PartName="iModelJsNodeAddonSqlang"/>

    <!-- This calls the same MKE file, so cannot run at the same time, lest they fight over common output files. -->
    <SubPart PartName="iModelJsNodeAddonLib-Linux"/>
    
    <Bindings>
      <Files ProductDirectoryName="iModelJsNode_node_module" ProductSubDirectory="e_2">
        Delivery/iModelJsNodeAddon/electron-addon-api/imodeljs.node
      </Files>
      <Files ProductDirectoryName="Assets" ProductSubDirectory="PresentationRules">
        Delivery/PresentationRules/*.xml
      </Files>	  
    </Bindings>
  </Part>

  <Part Name="iModelJsNodeAddonLib-Darwin" OnlyPlatforms="MacOSX64" ExcludeLibType="Dynamic" BentleyBuildMakeFile="IModelJsNative.mke" BentleyBuildMakeOptions="-dNODE_ADDON_API=node-addon-api" >
    <SubPart PartName="node-addon-api" Repository="Thirdparty-node-addon-api" PartFile="node-addon-api"/>
    <SubPart PartName="iModelJsNodeAddonLibCommon"/>
    <SubPart PartName="iModelJsNodeAddonSqlang"/>
    <Bindings>
      <Files ProductDirectoryName="iModelJsNode_node_module" ProductSubDirectory="n_8">
        Delivery/iModelJsNodeAddon/node-addon-api/imodeljs.node
      </Files>
      <Files ProductDirectoryName="Assets" ProductSubDirectory="PresentationRules">
        Delivery/PresentationRules/*.xml
      </Files>	  
    </Bindings>
  </Part>

  <Part Name="iModelJsNodeAddonLibElectron-Darwin" OnlyPlatforms="MacOSX64" ExcludeLibType="Dynamic" BentleyBuildMakeFile="IModelJsNative.mke" BentleyBuildMakeOptions="-dNODE_ADDON_API=electron-addon-api" >
    <SubPart PartName="electron-addon-api" Repository="Thirdparty-node-addon-api" PartFile="node-addon-api"/>
    <SubPart PartName="iModelJsNodeAddonLibCommon"/>
    <SubPart PartName="iModelJsNodeAddonSqlang"/>
    <Bindings>
      <Files ProductDirectoryName="iModelJsNode_node_module" ProductSubDirectory="e_2">
        Delivery/iModelJsNodeAddon/electron-addon-api/imodeljs.node
      </Files>
      <Files ProductDirectoryName="Assets" ProductSubDirectory="PresentationRules">
        Delivery/PresentationRules/*.xml
      </Files>	  
    </Bindings>
  </Part>

  <Part Name="iModelJsNodeAddonSqlang" BentleyBuildMakeFile="${SrcRoot}bsicommon/sqlang/mki/XliffsToDb.mke" BentleyBuildMakeOptions="-dSQLANG_OutputDb=$(OutputRootDir)build/iModelJsNodeAddon/iModelJsNodeAddon_en.sqlang.db3 -dSQLANG_XliffWildcard=$(BuildContext)SubParts/xliffs/*.xliff">
    <SubPart PartName="iModelJsNodeAddonLibCommon" />
    <Bindings>
      <Files ProductDirectoryName="Assets" ProductSubDirectory="sqlang">Delivery/sqlang/iModelJsNodeAddon_en.sqlang.db3</Files>
    </Bindings>
  </Part>

  <!-- This part builds our node native code addon -->
  <Part Name="iModelJsNodeAddonLibCommon">
    <SubPart PartName="DgnPlatformDLL" PartFile="iModelCore/DgnPlatform/DgnPlatform" Repository="imodel02"/>
    <SubPart PartName="ECPresentation" PartFile="iModelCore/ECPresentation/ECPresentation" Repository="imodel02"/>
    <SubPart PartName="ECObjectsNative"     PartFile="iModelCore/ecobjects/ECObjects"    Repository="imodel02" />
    <SubPart PartName="BeRapidJson" PartFile="iModelCore/Bentley/Bentley" Repository="imodel02"/>
    <!-- <SubPart PartName="Licensing" PartFile="LicensingCrossPlatform" Repository="LicensingCrossPlatform" /> 
    Until we can integrate Licensing, add the dependency so that the dependencies are pulled in
    -->
    <SubPart PartName="WebServicesClient" PartFile="iModelCore/WSClient/WSClient" Repository="imodel02"/>
    <SubPart PartName="BeSecurity" PartFile="iModelCore/BeSecurity/BeSecurity" Repository="imodel02"/>
  </Part>
</BuildContext>
