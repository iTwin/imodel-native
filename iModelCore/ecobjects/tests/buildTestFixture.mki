#----------------------------------------------------------------------------------------
#
#  $Source: tests/buildTestFixture.mki $
#
#  $Copyright: (c) 2013 Bentley Systems, Incorporated. All rights reserved. $
#
#----------------------------------------------------------------------------------------
baseDir =   $(_MakeFilePath)

%include mdl.mki

# We don't want to run the test from the build location because the dependencies are not there.
GUNITTEST_NOEXEC = 1

#----------------------------------------------------------------------
#       Compile the unit tests
#----------------------------------------------------------------------
BEGTEST_NAME=$(programName)
BEGTEST_OUTPUT=$(OutputRootDir)build/$(BEGTEST_NAME)/
BEGTEST_DEPENDENCIES=$(baseDir)SeedData.prewire.mke
%include $(SrcBsiCommon)sharedmki/BuildUnitTests.mke

#----------------------------------------------------------------------
#       Compile the main and testfixture 
#----------------------------------------------------------------------
# Let all stand-alone tests share the same gtestmain and TestFixture objects.
o = $(OutputRootDir)build/ecobjects/buildTestFixture/

always:
    !~@mkdir $(o)

$(o)gtestmain.obj : $(SrcRoot)ecobjects/tests/gtestmain.cpp

$(o)TestFixture.obj : $(SrcRoot)ecobjects/tests/TestFixture/TestFixture.cpp

#----------------------------------------------------------------------------------------
#   Link the executable
#----------------------------------------------------------------------------------------
%undef CPchOpts
%undef CCPchOpts

GUNITTEST_OUT       = $(o)
GUNITTEST_NAME      = $(programName)
GUNITTEST_DEST      = $(o)
GUNITTEST_NTLIBS    = advapi32.lib ole32.lib
GUNITTEST_PATH      = $(o) 
GUNITTEST_SYMB      = $(o)
GTEST_MAIN_IS_SUPPLIED = 1

%include $(BuildContext)SubParts/google_gtest_mki/gtestobj.mki

LOCAL_GUNITTEST_OBJS + $(o)gtestmain.obj 
LOCAL_GUNITTEST_OBJS + $(o)TestFixture.obj
LOCAL_GUNITTEST_OBJS + $[@wildcard $(BEGTEST_OUTPUT)$(BEGTEST_NAME)/*.obj]
LOCAL_GUNITTEST_OBJS + $[@wildcard $(BuildContext)SubParts/Libs/*.lib]

%include $(SharedMki)gunittest.mki

always:
    @CreateSymLinks.py "$(BuildContext)Delivery\$(programName).exe=$(o)$(programName).exe"