<?xml version="1.0" encoding="utf-8"?>

<BuildContext xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="../bsicommon/build/PartFile.xsd" >

<!-- ///////////////////////////////////////////////////////////////////////////////////// -->
<!-- ///////////////////// Runtime Parts ///////////////////////////////////////////////// -->
<!-- / This section contains parts that make the ECF Runtime ///////////////////////////// -->
<!-- ///////////////////////////////////////////////////////////////////////////////////// -->

    <Part Name="Logging" ExcludeLibType="Static" ExcludePlatforms="MacOS*,WinRT*"> <!-- Trim off dynamic-only parts here so we don't have to download the (non-existant) partfiles) -->
        <SubPart PartName="LoggingNative"   PartFile="LoggingSDK"                           Repository="loggingsdk" /> 
    </Part>

    <!-- NOTE: Graphite uses "G" as an ApiNumber (library suffix) to disambiguate from Vancouver libraries -->
    <Part Name="ECObjectsNative" BentleyBuildMakeFile="src/ecobjects.mke" ApiNumber="B02">
        <SubPart PartName="PublicAPI" />
        <SubPart PartName="BentleyDll"      PartFile="Bentley"      Repository="Bentley" />
        <SubPart PartName="Logging" /> 
        <SubPart PartName="GeomDlls"        PartFile="geomlibs"     Repository="GeomLibs" />
        <SubPart PartName="GeomlibsSerialization" PartFile="geomlibs" Repository="GeomLibs" />
        <SubPart PartName="BeXmlDll"        PartFile="BeLibxml2"    Repository="libsrc-libxml2" />
        <SubPart PartName="StandardSchemasBim" PartFile="ECStandards"  Repository="ECStandards"/>
        <SubPart PartName="StandardSchemasV3" PartFile="ECStandards" Repository="ECStandards" />
        <SubPart PartName="V3ConversionSchemas" PartFile="ECStandards" Repository="ECStandards"/>
        <SubPart PartName="BeJsonCpp"           PartFile="BeJsonCpp"    Repository="Libsrc-JsonCpp"/>
        <SubPart PartName="rapidjson"       PartFile="rapidjson" Repository="Libsrc-RapidJson"/>
        <SubPart PartName="UnitsNative"        PartFile="Units"        Repository="Units" />
        <Bindings>
            <Libs>Delivery/$(libprefix)ECObjects$(libext)</Libs>
            <Assemblies>Delivery/$(shlibprefix)ECObjects$(ApiNumber)$(shlibext)</Assemblies>
            <Files ProductDirectoryName="PresentationRulesXsds" Required="false">Delivery/PresentationRuleSetSchema.xsd</Files>
        </Bindings>
    </Part>

    <Part Name="PublishedApi" BentleyBuildMakeFile="${SrcRoot}bsicommon/sharedmki/PublishApi.mke" BMakeOptions="+dPUBLISHAPI_DELIVERY_DIR=Delivery/PublishedApi +dPUBLISHAPI_VENDORAPI=json +dPUBLISHAPI_VENDORAPI2=rapidjson">
        <!-- While the published api does not depend on the library, this subpart is a quick and maintainable way to ensure that all needed public apis are in the buildcontext. -->
        <SubPart PartName="ECObjectsNative" />
        <Bindings>
            <Directory SubPartDirectory="PublishedAPI/ECObjects" SourceName="Delivery/PublishedAPI" ProductDirectoryName="PublishedAPI" Required="false"/>
        </Bindings>
    </Part>

    <Part Name="PublishedApi_Doc" DeferType="BuildDocs" BentleyBuildMakeFile="PublicApi/BuildPublishedDoc.mke">
        <RequiredRepository>bsitools-doxygen</RequiredRepository>
        <SubPart PartName="PublishedApi" />
        <Bindings>
            <Files ProductDirectoryName="PublishedApi_Doc" IfNotPresent="Warn" Required="false">Delivery/ECObjectsAPI.chm</Files>
        </Bindings>
    </Part>

    <!-- Bind my own PublicAPI into BuildContext/PublicAPI. Note that this part does not cause any sub-part PublicAPIs to be bound. -->
    <Part Name="PublicAPI" BentleyBuildMakeFile="ecobjects.prewire.mke">
        <Bindings>
            <PublicAPI Domain="ECObjects" />
            <PublicAPI Domain="ECPresentationRules" />
            <PublicAPI Domain="ECUnits" />
        </Bindings>
    </Part>

    <!-- This part enables the ECObjects unit tests to be built into the set of unit tests that run on multiple platforms. -->

    <Part Name="ECObjectsTestsBasicDependencies">
        <SubPart PartName="ECObjectsNative" />
    </Part>

    <Part Name="ECObjectsUnitTests" BentleyBuildMakeFile="../bsicommon/sharedmki/BuildPlatformUnitTests.mke" BMakeOptions="-dBEGTEST_INPUT=$(SrcRoot)ECObjects/test/ -dBEGTEST_NAME=ECObjects -dBEGTEST_DEPENDENCIES=$(SrcRoot)ECObjects/test/SeedData.prewire.mke">
        <SubPart PartName="TestDependencies"/>
        <SubPart PartName="PublishedApi"/>
    </Part>

    <!-- The following parts build the stand-alone ECObjects unit tests (from the same unit test source). -->
    <!-- ProductDirectoryNames below are listed in the BeGTest part file, in directory list: CollectionProduct -->

    <Part Name="ECObjectsTestsSeedData" BentleyBuildMakeFile="test/SeedData.prewire.mke">
        <Bindings>
            <Files SubPartDirectory="SeedData" ProductDirectoryName="ECObjectsTestSeedData">Delivery/SeedData/*xml</Files>
            <Files SubPartDirectory="SeedData/ur-PK" ProductDirectoryName="ECObjectsTestSeedDataPK">Delivery/SeedData/ur-PK/*xml</Files>
            <Files SubPartDirectory="SeedData/en-GB" ProductDirectoryName="ECObjectsTestSeedDataGB">Delivery/SeedData/en-GB/*xml</Files>
            <Files SubPartDirectory="SeedData/it" ProductDirectoryName="ECObjectsTestSeedDataIT">Delivery/SeedData/it/*xml</Files>
            <Files SubPartDirectory="SeedData/V3Conversion" ProductDirectoryName="ECObjectsTestSeedDataV3Conversion">Delivery/SeedData/V3Conversion/*xml</Files>
        </Bindings>
    </Part>

    <!-- We do not use a special logging config when running ecobjects tests. We use the default logging config found in begtest/gtest.
    <Part Name="ECObjectsTestLoggingConfig" BentleyBuildMakeFile="test/LoggingConfig.prewire.mke" ExcludePlatforms="Android*,Linux*,iOS*">
        <Bindings>
            <Files ProductDirectoryName="ECObjectsTestExe">Delivery/logging.config.xml</Files>
        </Bindings>
    </Part>
    -->

    <Part Name="TestDependencies" BentleyBuildMakeFile="test/prewire.mke">
        <SubPart PartName="GeomlibsSerialization" PartFile="geomlibs" Repository="GeomLibs" />
        <SubPart PartName="ECObjectsTestsBasicDependencies"/>
        <SubPart PartName="ECObjectsTestsSeedData"/>
        <SubPart PartName="Logging" />
        <!-- 
        <SubPart PartName="ECObjectsTestLoggingConfig"/>
        -->
        <Bindings>
            <Files ProductDirectoryName="UnitTests-IgnoreList" ProductSubDirectory="ECObjects" SubPartDirectory="UnitTests/ECObjects">Delivery/UnitTests/ignore_list.txt</Files>
        </Bindings>
    </Part>

    <Part Name="TestFixture" BentleyBuildMakeFile="test/BuildTests.mke" BentleyBuildMakeOptions="-dTestDir=TestFixture">
        <SubPart PartName="TestDependencies"/>
        <Bindings>
            <Directory ProductDirectoryName="UnitTests-Objects" ProductSubDirectory="ECObjects/TestFixture" SourceName="Delivery/UnitTests/Objects/TestFixture"/>
        </Bindings>
    </Part>

    <Part Name="PublishedTests" BentleyBuildMakeFile="test/BuildTests.mke" BentleyBuildMakeOptions="-dTestDir=Published -dIsPublished=1">
        <SubPart PartName="NonPublishedTests"/>
        <SubPart PartName="PublishedApi"/>
        <Bindings>
            <Directory ProductDirectoryName="UnitTests-Objects" ProductSubDirectory="ECObjects/Published" SourceName="Delivery/UnitTests/Objects/Published"/>
        </Bindings>
    </Part>

    <Part Name="NonPublishedTests" BentleyBuildMakeFile="test/BuildTests.mke" BentleyBuildMakeOptions="-dTestDir=NonPublished">
        <SubPart PartName="TestDependencies"/>
        <SubPart PartName="TestFixture"/>
        <Bindings>
            <Directory ProductDirectoryName="UnitTests-Objects" ProductSubDirectory="ECObjects/NonPublished" SourceName="Delivery/UnitTests/Objects/NonPublished"/>
        </Bindings>
    </Part>
<!--
    <Part Name="ScenarioTests" BentleyBuildMakeFile="test/BuildTests.mke" BentleyBuildMakeOptions="-dTestDir=Scenario -dIsPublished=1">
        <SubPart PartName="TestDependencies"/>
        <SubPart PartName="TestFixture"/>
        <Bindings>
            <Directory ProductDirectoryName="UnitTests-Objects" ProductSubDirectory="ECObjects/Scenario" SourceName="Delivery/UnitTests/Objects/Scenario"/>
        </Bindings>
    </Part>
    
    <Part Name="ECObjectsNonPublishedScenarioTests" BentleyBuildMakeFile="test/BuildTests.mke" BentleyBuildMakeOptions="-dTestDir=NonPublishedScenario">
        <SubPart PartName="TestDependencies"/>
        <SubPart PartName="TestFixture"/>
        <Bindings>
            <Directory ProductDirectoryName="UnitTests-Objects" ProductSubDirectory="ECObjects/NonPublishedScenario" SourceName="Delivery/UnitTests/Objects/NonPublishedScenario"/>
        </Bindings>
    </Part>
-->
    <Part Name="PerformanceTests" BentleyBuildMakeFile="test/BuildTests.mke" BentleyBuildMakeOptions="-dTestDir=Performance">
        <SubPart PartName="TestDependencies"/>
        <SubPart PartName="TestFixture"/>
        <Bindings>
            <Directory ProductDirectoryName="UnitTests-Objects" ProductSubDirectory="ECObjects/Performance" SourceName="Delivery/UnitTests/Objects/Performance"/>
        </Bindings>
    </Part>

    <!-- This part is the default test collection. It is included in MobileDgn's aggregate test collection. -->
    <Part Name="Tests">
        <SubPart PartName="PublishedTests" />
        <SubPart PartName="NonPublishedTests" />
        <!--    
        <SubPart PartName="ScenarioTests" />
        <SubPart PartName="NonPublishedScenarioTests" />
        -->
    </Part>

    <!-- Define a gtest program to run the tests. The Gtest and RunGtest parts are included in MobileDgn's Gtest-Aggregator and RunGtest-MobileDgnTests parts -->
    <Product Name="ECObjects-Tests">
        <SubPart Repository="BeGTest" PartFile="BeGTest" PartName="Base" />
        <SubPart PartName="Tests"/>
        <Directories DirectoryListName="CollectionProduct" Repository="BeGTest"  PartFile="BeGTest"/>
    </Product>

    <Part Name="Gtest" DeferType="BuildUnitTests" BentleyBuildMakeFile="${SrcRoot}BeGTest/gtest/buildGTest.mke" BentleyBuildMakeOptions="-dTEST_NAME=ECObjectsTest -dTEST_COLLECTION_PRODUCT=ECObjects-Tests" OnlyPlatforms="x86,x64,Linux*,MacOS*">
        <SubProduct ProductName="ECObjects-Tests"/>
        <SubPart PartName="Gtest-Tools" Repository="BeGTest" PartFile="BeGTest"/>
        <Bindings>
            <Files ProductDirectoryName="Gtest-NativeAssemblies">Delivery/Gtest/ECObjectsTest/Assemblies/*</Files>
            <Directory ProductDirectoryName="Gtest-Assets" SourceName="Delivery/Gtest/ECObjectsTest/Assets" />
        </Bindings>
    </Part>

    <Product Name="ECObjects-Gtest" >
        <SubPart PartName="Gtest"/>
        <Directories DirectoryListName="GtestProduct" Repository="BeGTest" PartFile="BeGTest"/>
    </Product>

    <Part Name="RunGtest" DeferType="RunUnitTests" BentleyBuildMakeFile="${SrcRoot}BeGTest/gtest/RunGTest.mke" BentleyBuildMakeOptions="-dGTEST_EXE=$(OutputRootDir)Product/ECObjects-Gtest/ECObjectsTest" OnlyPlatforms="x86,x64,MacOs*,Linux*">
        <SubProduct ProductName="ECObjects-Gtest" />
        <SubPart PartName="Gtest-Tools" Repository="BeGTest" PartFile="BeGTest"/>
        <Bindings>
          <Files Required="false" SubPartDirectory="Gtest/Logs">Delivery/Gtest/Logs/ECObjectsTest.log</Files>
        </Bindings>
    </Part>

    <!-- ********************** -->
    <!-- **** AndroidJUnit **** -->
    <!-- ********************** -->
    <Part Name="AndroidJUnit" DeferType="BuildUnitTests" BentleyBuildMakeFile="${SrcRoot}BeGTest/Android/MakeJUnitTestProject.mke" BentleyBuildMakeOptions="-dTEST_COLLECTION_PRODUCT=ECObjects-Tests -dUSE_STATIC_LIBRARIES=1 -dTEST_ANDROID_MIN_SDK_VERSION=19" OnlyPlatforms="Android*">
        <SubProduct ProductName="ECObjects-Tests"/>
        <SubPart PartName="AndroidJUnitTest-Tools" Repository="BeGTest" PartFile="BeGTest"/>
        <Bindings>
            <Directory ProductDirectoryName="AndroidJUnit-Project" SourceName="Delivery/ANJUP" />
        </Bindings>
    </Part>

    <Product Name="ECObjects-AndroidJUnit" >
        <SubPart PartName="AndroidJUnit" LibType="Static"/>
        <Directories DirectoryListName="AndroidJUnitProduct" Repository="BeGTest" PartFile="BeGTest"/>
    </Product>

    <Part Name="RunAndroidJUnitTest" DeferType="RunUnitTests" BentleyBuildMakeFile="${SrcRoot}BeGTest/Android/RunAndroidJUnitTest.mke" BentleyBuildMakeOptions="-dANDROIDJUNIT_PRODUCT=ECObjects-AndroidJUnit" OnlyPlatforms="Android*">
        <SubProduct ProductName="ECObjects-AndroidJUnit"/>
        <Bindings>
          <Files Required="false" SubPartDirectory="ANJU/Logs">Delivery/ANJU/Logs/ECObjects-AndroidJUnit.log</Files>
        </Bindings>
    </Part>

    <!-- ********************** -->
    <!-- **** iOSXCTest **** -->
    <!-- ********************** -->
    <Part Name="iOSXCTest" DeferType="BuildUnitTests" BentleyBuildMakeFile="${SrcRoot}BeGTest/iOS/MakeXCTestProject.mke" BentleyBuildMakeOptions="-dTEST_NAME=ECObjects -dTEST_COLLECTION_PRODUCT=ECObjects-Tests -dUSE_STATIC_LIBRARIES=1" OnlyPlatforms="iOS*">
        <SubProduct ProductName="ECObjects-Tests"/>
        <SubPart PartName="iOSXCTest-Tools" Repository="BeGTest" PartFile="BeGTest"/>
        <Bindings>
            <Directory ProductDirectoryName="iOSXCTestProject" SourceName="Delivery/iOSXCTest/ECObjects/Project" />
        </Bindings>
    </Part>

    <Product Name="ECObjects-iOSXCTest" >
        <SubPart PartName="iOSXCTest" LibType="Static"/>
        <Directories DirectoryListName="iOSXCTestProduct" Repository="BeGTest" PartFile="BeGTest"/>
    </Product>

    <Part Name="RuniOSXCTest" DeferType="RunUnitTests" BentleyBuildMakeFile="${SrcRoot}BeGTest/iOS/RunXCTestProject.mke" BentleyBuildMakeOptions="-dXCTEST_PRODUCT=ECObjects-iOSXCTest" OnlyPlatforms="iOS*">
        <SubProduct ProductName="ECObjects-iOSXCTest"/>
        <Bindings>
            <Files Required="false" SubPartDirectory="XCTest/Logs">Delivery/XCTest/Logs/ECObjects-iOSXCTest.log</Files>
        </Bindings>
    </Part>

    <!-- *********************************************************** -->
    <!-- **** UWP Microsoft::VisualStudio::CppUnitTestFramework **** -->
    <!-- *********************************************************** -->
    <!-- N.B. ApiNumber is important here because we must manually reference some DLLs, and thus need an accruate suffix to find them. -->
    <Part
        Name="UwpTest" DeferType="BuildUnitTests"
        BentleyBuildMakeFile="${SrcRoot}BeGTest/uwp/MakeUwpTestProject.mke"
        BentleyBuildMakeOptions="-dTEST_NAME=ECObjects -dTEST_COLLECTION_PRODUCT=ECObjects-Tests"
        OnlyPlatforms="WinRT*"
        ApiNumber="B02"
        >
        <SubProduct ProductName="ECObjects-Tests"/>
        <SubPart PartName="UwpTest-Tools" Repository="BeGTest" PartFile="BeGTest"/>
        <Bindings>
            <Directory ProductDirectoryName="UwpTestProject" SourceName="Delivery/ECObjectsUwpTest"/>
        </Bindings>
    </Part>

    <Product Name="ECObjects-UwpTest">
        <SubPart PartName="UwpTest"/>
        <Directories DirectoryListName="UwpTestProduct" Repository="BeGTest" PartFile="BeGTest"/>
    </Product>

    <Part
        Name="RunUwpTest"
        BentleyBuildMakeFile="${SrcRoot}BeGTest/uwp/RunUwpTestProject.mke"
        BentleyBuildMakeOptions="-dUWPTEST_PRODUCT=ECObjects-UwpTest"
        OnlyPlatforms="WinRT*"
        >
        <SubProduct ProductName="ECObjects-UwpTest"/>
        <Bindings>
            <Files Required="false" SubPartDirectory="UwpTest/Logs">Delivery/UwpTest/Logs/ECObjects-UwpTest.log</Files>
        </Bindings>
    </Part>

    <!-- Define a gtest program to run the PerformanceTests. -->
    <Product Name="ECObjects-PerformanceTests">
        <SubPart Repository="BeGTest" PartFile="BeGTest" PartName="Base" />
        <SubPart PartName="PerformanceTests"/>
        <Directories DirectoryListName="CollectionProduct" Repository="BeGTest"  PartFile="BeGTest"/>
    </Product>

    <Part Name="PerformanceGtest" BentleyBuildMakeFile="${SrcRoot}BeGTest/gtest/buildGTest.mke" BentleyBuildMakeOptions="-dTEST_NAME=ECObjectsPerformanceTests -dTEST_COLLECTION_PRODUCT=ECObjects-PerformanceTests" OnlyPlatforms="x86,x64,Linux*,MacOS*">
        <SubProduct ProductName="ECObjects-PerformanceTests"/>
        <SubPart PartName="Gtest-Tools" Repository="BeGTest" PartFile="BeGTest"/>
        <Bindings>
            <Files ProductDirectoryName="Gtest-NativeAssemblies">Delivery/Gtest/ECObjectsPerformanceTests/Assemblies/*</Files>
            <Directory ProductDirectoryName="Gtest-Assets" SourceName="Delivery/Gtest/ECObjectsPerformanceTests/Assets" />
        </Bindings>
    </Part>

    <!-- NuGet automatic packages generation -->
    <Part Name="ECObjectsPackage" BMakeFile="install\NuGetPacking.mke" >
        <RequiredRepository>bsitools-nuget</RequiredRepository>
        <SubPart PartName="ECObjectsNative" />
        <Bindings>
            <Files ProductDirectoryName="ECObjectsNuGet">Install\ecobjects.nupkg</Files>
        </Bindings>
    </Part>

    <Product Name="ECObjects-PerformanceGtest" >
        <SubPart PartName="PerformanceGtest"/>
        <Directories DirectoryListName="GtestProduct" Repository="BeGTest" PartFile="BeGTest"/>
    </Product>

    <Part Name="RunPerformanceGtest" DeferType="RunUnitTests" BentleyBuildMakeFile="${SrcRoot}BeGTest/gtest/RunGTest.mke" BentleyBuildMakeOptions="-dGTEST_EXE=$(OutputRootDir)Product/ECObjects-PerformanceGtest/ECObjectsPerformanceTests -dGTEST_OUTPUT_DIR=$(OutputRootDir)build/ECObjects" OnlyPlatforms="x86,x64,MacOs*,Linux*">
        <SubProduct ProductName="ECObjects-PerformanceGtest" />
        <SubPart PartName="Gtest-Tools" Repository="BeGTest" PartFile="BeGTest"/>
    </Part>

    <Product Name="ECObjectsStatic"> <!-- Only here to avoid putting directory list on ECObjectsTested -->
      <SubPart PartName="ECObjectsNative"  LibType="Static"/>
      <Directories DirectoryListName="ECObjects" />
    </Product>

    <Part Name="SchemaConverter" BentleyBuildMakeFile="tools/SchemaConverter/SchemaConverter.mke" ExcludePlatforms="Android*,Linux*,iOS*">
        <SubPart PartName="ECObjectsNative" />
        <Bindings>
            <Files ProductDirectoryName="SchemaConverterExe">
                Delivery/SchemaConverter.exe
                Delivery/SchemaConverter.logging.config.xml
            </Files>
        </Bindings>
    </Part>
    
    <Part Name="SchemaResourceGenerator" BentleyBuildMakeFile="tools/SchemaResourceGenerator/SchemaResourceGenerator.mke" ExcludePlatforms="Android*,Linux*,iOS*">
        <SubPart PartName="ECObjectsNative" />
        <Bindings>
            <Files ProductDirectoryName="SchemaResourceGeneratorExe">
                Delivery/SchemaResourceGenerator.exe
                Delivery/SchemaResourceGenerator.logging.config.xml
            </Files>
        </Bindings>
    </Part>
    
<!-- ///////////////////////////////////////////////////////////////////////////////////// -->
<!-- ////////////////////////////////// Products ///////////////////////////////////////// -->
<!-- ///////////////////////////////////////////////////////////////////////////////////// -->

    <ProductDirectoryList ListName="ECObjects">
        <ProductDirectory Name="Assemblies" Path=""/>
        <ProductDirectory Name="Assets"   RelativeTo="Assemblies" Path="Assets"/>
        <ProductDirectory Name="Assets"   RelativeTo="Assemblies" Path="Assets" LibType="static"/>
        <ProductDirectory Name="VendorNotices"  Path="Notices"/>
    </ProductDirectoryList>

    <Product Name="ECObjects">
        <SubPart PartName="ECObjectsNative"/>
        <SubPart PartName="PublishedApi_Doc" />
        <Directories DirectoryListName="ECObjects"/>
    </Product>

    <ProductDirectoryList ListName="SchemaConverter">
        <ProductDirectory Name="SchemaConverterExe"     Path=""/>
    </ProductDirectoryList>
    
    <ProductDirectoryList ListName="SchemaResourceGenerator">
        <ProductDirectory Name="SchemaResourceGeneratorExe"     Path=""/>
    </ProductDirectoryList>
    <Product Name="ECObjectsTools">
        <SubPart    PartName="SchemaConverter" />
        <SubPart    PartName="SchemaResourceGenerator" />
        <SubProduct ProductName="ECObjects"/>
        <Directories DirectoryListName="SchemaConverter" />
        <Directories DirectoryListName="SchemaResourceGenerator" />
        <Directories DirectoryListName="ECObjects" />
    </Product>
    
    <ProductDirectoryList ListName="ECObjectsTested">
    </ProductDirectoryList>
    <Product Name="ECObjectsTested" PrgOutputDir="ECObjects" SaveProduct="true" AddIn="true">
        <SubProduct ProductName="ECObjects" />
        <!-- SubProduct ProductName="ECObjectsStatic" /-->
        <SubProduct ProductName="ECObjects-Tests" />
        <SubPart PartName="RunGtest" />
        <Directories DirectoryListName="ECObjectsTested"/>
    </Product>

</BuildContext>
