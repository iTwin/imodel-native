#----------------------------------------------------------------------------------------
#
#  $Source: test/buildTestFixture.mki $
#
#  $Copyright: (c) 2013 Bentley Systems, Incorporated. All rights reserved. $
#
#----------------------------------------------------------------------------------------
baseDir =   $(_MakeFilePath)

%include mdl.mki

# We don't want to run the test from the build location because the dependencies are not there.
GUNITTEST_NOEXEC = 1

#----------------------------------------------------------------------
#       Create output directories
#----------------------------------------------------------------------
always:
    !~@mkdir $(o)
    !~@mkdir $(OutputRootDir)build/UnitTests/ecobjects/NonPublishedECObjectsUnitTests

#----------------------------------------------------------------------
#       Compile the unit tests
#----------------------------------------------------------------------
BEGTEST_NAME=$(programName)
BEGTEST_OUTPUT=$(OutputRootDir)build/$(BEGTEST_NAME)/
BEGTEST_DEPENDENCIES=$(baseDir)SeedData.prewire.mke
%include $(SrcBsiCommon)sharedmki/BuildUnitTests.mke

$(o)gtestmain.obj : $(SrcRoot)ecobjects/test/gtestmain.cpp

# TRICKY! All unit tests use ECTestFixture. That class is implemented by the following .obj. So, we always make sure that's built, too.
testFixtureObj = $(OutputRootDir)build/ECObjectsTest_NonPublished/ECObjectsTest_NonPublished/TestFixture.obj

$(testFixtureObj) : $(SrcRoot)ecobjects/test/NonPublished/TestFixture.cpp

#----------------------------------------------------------------------------------------
#   Link the executable
#----------------------------------------------------------------------------------------
%undef CPchOpts
%undef CCPchOpts

GUNITTEST_OUT       = $(o)
GUNITTEST_NAME      = $(programName)
GUNITTEST_DEST      = $(o)
GUNITTEST_NTLIBS    = advapi32.lib ole32.lib
GUNITTEST_LIBS      + $[@wildcard $(BuildContext)SubParts/Libs/*$(libext)]
GUNITTEST_PATH      = $(o) 
GUNITTEST_SYMB      = $(o)
GTEST_MAIN_IS_SUPPLIED = 1

%include $(BuildContext)SubParts/google_gtest_mki/gtestobj.mki

LOCAL_GUNITTEST_OBJS + $[@wildcard $(BEGTEST_OUTPUT)$(BEGTEST_NAME)/*.obj]
LOCAL_GUNITTEST_OBJS + $[@wildcard $(BuildContext)SubParts/Libs/*.lib]

LOCAL_GUNITTEST_OBJS + $(o)gtestmain.obj

# TRICKY! All unit tests use ECTestFixture. That class is implemented by the following .obj. So, we always link that in, too.
LOCAL_GUNITTEST_OBJS + $(testFixtureObj)

SORTED_LOCAL_GUNITTEST_OBJS =% $[@sort $(LOCAL_GUNITTEST_OBJS)]
LOCAL_GUNITTEST_OBJS = $(SORTED_LOCAL_GUNITTEST_OBJS)

%include $(SharedMki)gunittest.mki

always:
    @CreateSymLinks.py "$(BuildContext)Delivery\$(programName).exe=$(o)$(programName).exe"