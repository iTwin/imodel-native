<?xml version="1.0" encoding="utf-8"?>

<BuildContext xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="../bsicommon/build/PartFile.xsd">

    <ProductDirectoryList ListName="Bentley">
        <ProductDirectory Name="PublicAPI"/>
        <ProductDirectory Name="VendorAPI"/>
        <ProductDirectory Name="BentleyNativeAssemblies" Path="Dlls"/>
        <ProductDirectory Name="Libs"            Path="Libs"/>
        <ProductDirectory Name="TestBin"         Path="Dlls"/>
    </ProductDirectoryList>

    <!-- This part is designed to be the "ToolsetPart" that is run by bb once, before any other part. 
          The name of this part must match the ToolsetPart declaration in your buildstrategy. 
          For example, see DgnClientSdk.BuildStrategy.xml -->
    <Part Name="BootStrapToolset" BentleyBuildMakeFile="BootStrapToolset.mke"/>

    <Part Name="BentleyLib" PrgOutputDir="BentleyLib">
        <SubPart PartName="BentleyDll" />
    </Part>
  
    <Part Name="Base" BentleyBuildMakeFile="prewire.mke">
        <!-- BeTest.h includes <gtest/gtest.h> in some builds, and so Bentley depends on gtest, at least for include files. -->
        <SubPart PartName="BeGtest-Includes" Repository="BeGTest" PartFile="BeGTest" />
        <Bindings>
            <PublicAPI Domain="Bentley" />
            <PublicAPI Domain="Logging" />
            <PublicAPI Domain="BentleyManagedUtil" />
            <Files ProductDirectoryName="BentleyApiPublicMki" SubPartDirectory="PublicMki" Required="false">PublicMki/BentleyApi.mki</Files>
            <VendorNotices>
                Delivery/bentley-notice.txt
                Delivery/btree-notice.txt
                Delivery/btree-license.txt
                Delivery/bvector-notice.txt
                Delivery/bvector-license.txt
            </VendorNotices>
            <Directory SourceName="Dox/Pages/Bentley" SubPartDirectory="Dox/Pages/Bentley"/>
        </Bindings>
    </Part>

    <!-- NOTE: Graphite uses "G" as an ApiNumber (library suffix) to disambiguate from Vancouver libraries -->
    <Part Name="BentleyDll" BentleyBuildMakeFile="Bentley.mke" ApiNumber="G06" BMakeOptions="+dTMP_BUILD_STATIC">
        <SubPart PartName="Base"/>
        <SubPart PartName="BeIcu4cLibrary" PartFile="BeIcu4cLibrary" Repository="Libsrc-Icu4c"/>
        <Bindings>
            <Libs ProductDirectoryName="BentleyLibs" Required="false">Delivery/$(libprefix)Bentley$(libext)</Libs>
            <Assemblies ProductDirectoryName="BentleyNativeAssemblies">Delivery/$(shlibprefix)Bentley$(ApiNumber)$(shlibext)</Assemblies>
        </Bindings>
    </Part>

    <Part Name="PublishedApi" BentleyBuildMakeFile="${SrcRoot}bsicommon/sharedmki/PublishApi.mke" BMakeOptions="+dPUBLISHAPI_DELIVERY_DIR=Delivery/PublishedApi">
        <SubPart PartName="Base"/>
        <Bindings>
            <Directory SourceName="Delivery/PublishedApi" SubPartDirectory="PublishedApi/Bentley"/>
        </Bindings>
    </Part>

    <!-- ******************************** Unit Tests ************************************** -->
    <Part Name="PrewireForUnitTests" BentleyBuildMakeFile="Tests/Prewire.mke">
        <SubPart PartName="BentleyDll"/>
        <Bindings>
            <Files ProductDirectoryName="UnitTests-IgnoreList" ProductSubDirectory="Bentley" SubPartDirectory="UnitTests/Bentley"> Delivery/UnitTests/ignore_list.txt</Files>
        </Bindings>
    </Part>

    <Part Name="UnitTests-NonPublished" BentleyBuildMakeFile="Tests/BuildTests.mke" BentleyBuildMakeOptions="-dTestDir=NonPublished">
        <SubPart PartName="PrewireForUnitTests" />
        <Bindings>
            <Directory ProductDirectoryName="UnitTests-Objects" ProductSubDirectory="Bentley/NonPublished" SourceName="Delivery/UnitTests/Objects/NonPublished"/>
        </Bindings>
    </Part>

    <Part Name="UnitTests-Published" BentleyBuildMakeFile="Tests/BuildTests.mke" BentleyBuildMakeOptions="-dTestDir=Published -dUsePublishedApi">
        <SubPart PartName="PrewireForUnitTests" />
        <SubPart PartName="PublishedApi" />
        <Bindings>
            <Directory ProductDirectoryName="UnitTests-Objects" ProductSubDirectory="Bentley/Published" SourceName="Delivery/UnitTests/Objects/Published"/>
        </Bindings>
    </Part>

  <Part Name="UnitTests-Performance" BentleyBuildMakeFile="Tests/BuildTests.mke" BentleyBuildMakeOptions="-dTestDir=Performance">
    <SubPart PartName="PrewireForUnitTests" />
    <Bindings>
      <Directory ProductDirectoryName="UnitTests-Objects" ProductSubDirectory="Bentley/Performance" SourceName="Delivery/UnitTests/Objects/Performance"/>
    </Bindings>
  </Part>

    <!-- Define a test collection part. This is included in MobileDgn's TestsAggregate -->
    <Part Name="Tests">
        <SubPart PartName="UnitTests-NonPublished"/>
        <SubPart PartName="UnitTests-Published"/>
    </Part>

    <!-- Define a gtest program to run the tests. The Gtest and RunGtest parts are included in MobileDgn's Gtest-Aggregator and RunGtest-MobileDgnTests parts -->
    <Product Name="Bentley-Tests">
        <SubPart Repository="BeGTest" PartFile="BeGTest" PartName="Base" />
        <SubPart PartName="Tests"/>
        <Directories DirectoryListName="CollectionProduct" Repository="BeGTest"  PartFile="BeGTest"/>
    </Product>

    <Part Name="Gtest" BentleyBuildMakeFile="${SrcRoot}BeGTest/gtest/buildGTest.mke" BentleyBuildMakeOptions="-dTEST_NAME=BentleyTest -dTEST_COLLECTION_PRODUCT=Bentley-Tests" OnlyPlatforms="x86,x64,Linux*,MacOS*,Android*">
        <SubProduct ProductName="Bentley-Tests"/>
        <SubPart PartName="Gtest-Tools" Repository="BeGTest" PartFile="BeGTest"/>
        <Bindings>
            <Files ProductDirectoryName="Gtest-NativeAssemblies">Delivery/Gtest/BentleyTest/Assemblies/*</Files>
            <Directory ProductDirectoryName="Gtest-Assets" SourceName="Delivery/Gtest/BentleyTest/Assets" />
        </Bindings>
    </Part>

    <Product Name="Bentley-Gtest" >
        <SubPart PartName="Gtest"/>
        <Directories DirectoryListName="GtestProduct" Repository="BeGTest" PartFile="BeGTest"/>
    </Product>

    <Part Name="RunGtest" BentleyBuildMakeFile="${SrcRoot}BeGTest/gtest/RunGTest.mke" BentleyBuildMakeOptions="-dGTEST_EXE=$(OutputRootDir)Product/Bentley-Gtest/BentleyTest -dGTEST_OUTPUT_DIR=$(OutputRootDir)build/Bentley" OnlyPlatforms="x86,x64,MacOs*,Linux*">
        <SubProduct ProductName="Bentley-Gtest" />
        <SubPart PartName="Gtest-Tools" Repository="BeGTest" PartFile="BeGTest"/>
    </Part>

    <!--                ********************** -->
    <!--                **** AndroidJUnit **** -->
    <!--                ********************** -->
    <Part Name="AndroidJUnit" BentleyBuildMakeFile="${SrcRoot}BeGTest/Android/MakeJUnitTestProject.mke" BentleyBuildMakeOptions="-dTEST_NAME=Bentley -dTEST_COLLECTION_PRODUCT=Bentley-Tests -dUSE_STATIC_LIBRARIES=1 -dTEST_ANDROID_MIN_SDK_VERSION=19" OnlyPlatforms="Android*">
        <SubProduct ProductName="Bentley-Tests"/>
        <SubPart PartName="AndroidJUnitTest-Tools" Repository="BeGTest" PartFile="BeGTest"/>
        <Bindings>
            <Directory ProductDirectoryName="AndroidJUnit-Project" SourceName="Delivery/ANJU/Bentley/Project" />
        </Bindings>
    </Part>

    <Product Name="Bentley-AndroidJUnit" >
        <SubPart PartName="AndroidJUnit" LibType="Static"/>
        <Directories DirectoryListName="AndroidJUnitProduct" Repository="BeGTest" PartFile="BeGTest"/>
    </Product>

    <Part Name="RunAndroidJUnitTest" BentleyBuildMakeFile="${SrcRoot}BeGTest/Android/RunAndroidJUnitTest.mke" BentleyBuildMakeOptions="-dANDROIDJUNIT_PRODUCT=Bentley-AndroidJUnit" OnlyPlatforms="Android*">
        <SubProduct ProductName="Bentley-AndroidJUnit"/>
    </Part>
    
    <!--                ********************** -->
    <!--                **** iOSXCTest **** -->
    <!--                ********************** -->
    <Part Name="iOSXCTest" BentleyBuildMakeFile="${SrcRoot}BeGTest/iOS/MakeXCTestProject.mke" BentleyBuildMakeOptions="-dTEST_NAME=Bentley -dTEST_COLLECTION_PRODUCT=Bentley-Tests -dUSE_STATIC_LIBRARIES=1" OnlyPlatforms="iOS*">
        <SubProduct ProductName="Bentley-Tests"/>
        <SubPart PartName="iOSXCTest-Tools" Repository="BeGTest" PartFile="BeGTest"/>
        <Bindings>
            <Directory ProductDirectoryName="iOSXCTestProject" SourceName="Delivery/iOSXCTest/Bentley/Project" />
        </Bindings>
    </Part>

    <Product Name="Bentley-iOSXCTest" >
        <SubPart PartName="iOSXCTest" LibType="Static"/>
        <Directories DirectoryListName="iOSXCTestProduct" Repository="BeGTest" PartFile="BeGTest"/>
    </Product>

    <Part Name="RuniOSXCTest" BentleyBuildMakeFile="${SrcRoot}BeGTest/iOS/RunXCTestProject.mke" BentleyBuildMakeOptions="-dXCTEST_PRODUCT=Bentley-iOSXCTest" OnlyPlatforms="iOS*">
        <SubProduct ProductName="Bentley-iOSXCTest"/>
    </Part>

    <!-- *********************************************************** -->
    <!-- **** UWP Microsoft::VisualStudio::CppUnitTestFramework **** -->
    <!-- *********************************************************** -->
    <!-- N.B. ApiNumber is important here because we must manually reference some DLLs, and thus need an accruate suffix to find them. -->
    <Part
        Name="UwpTest"
        BentleyBuildMakeFile="${SrcRoot}BeGTest/uwp/MakeUwpTestProject.mke"
        BentleyBuildMakeOptions="-dTEST_NAME=Bentley -dTEST_COLLECTION_PRODUCT=Bentley-Tests"
        OnlyPlatforms="WinRT*"
        ApiNumber="G06"
        >
        <SubProduct ProductName="Bentley-Tests"/>
        <SubPart PartName="UwpTest-Tools" Repository="BeGTest" PartFile="BeGTest"/>
        <Bindings>
            <Directory ProductDirectoryName="UwpTestProject" SourceName="Delivery/BentleyUwpTest"/>
        </Bindings>
    </Part>

    <Product Name="Bentley-UwpTest">
        <SubPart PartName="UwpTest"/>
        <Directories DirectoryListName="UwpTestProduct" Repository="BeGTest" PartFile="BeGTest"/>
    </Product>

    <Part
        Name="RunUwpTest"
        BentleyBuildMakeFile="${SrcRoot}BeGTest/uwp/RunUwpTestProject.mke"
        BentleyBuildMakeOptions="-dUWPTEST_PRODUCT=Bentley-UwpTest"
        OnlyPlatforms="WinRT*"
        >
        <SubProduct ProductName="Bentley-UwpTest"/>
    </Part>

</BuildContext>
