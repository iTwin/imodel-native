#*--------------------------------------------------------------------------------------+
#
#     $Source: Tests/DgnProject/prewire.mke $
#
#  $Copyright: (c) 2015 Bentley Systems, Incorporated. All rights reserved. $
#
#--------------------------------------------------------------------------------------*/
%include mdl.mki

SrcDgnPlatform              = $(SrcRoot)DgnPlatform/
DgnPlatformPublicAPISrc     = $(SrcDgnPlatform)PublicAPI/
DgnHandlersAPISrc           = $(DgnPlatformPublicAPISrc)DgnPlatform/DgnHandlers/
baseDir                     = $(_makeFilePath)

$(BuildContext)Delivery/UnitTests/ECSchemas : $(baseDir)ECSchemas
    $(LinkFirstDepToFirstTargetAsDirectory)

$(BuildContext)Delivery/UnitTests/ignore_list.txt : $(baseDir)ignore_list.txt
    $(LinkFirstDepToFirstTarget)

$(BuildContext)Delivery/UnitTests/ScopedDgnHost.h : $(DgnHandlersAPISrc)UnitTests/ScopedDgnHost.h
    $(LinkFirstDepToFirstTarget)

#   -------------------------------------------------------------------------------------------
#   Compile .ts files to .js files, ready to be executed by script tests
#   -------------------------------------------------------------------------------------------
ScriptOutDir = $(OutputRootDir)build/DgnPlatform/UnitTests/Script/

always:
    !~@mkdir ${ScriptOutDir}

%ifndef BENTLEYCONFIG_NO_JAVASCRIPT

%if defined(winNT)
    TypeScriptCompile = $(BuildContext)SubParts/NodeJs/node.exe $(BuildContext)SubParts/TypeScript/tsc.js
%else
    TypeScriptCompile = $(BuildContext)SubParts/NodeJs/node $(BuildContext)SubParts/TypeScript/tsc.js
%endif

tsSourceFiles = $[@wildcard $(baseDir)*.ts] $[@wildcard $(BuildContext)SubParts/Script/*.d.ts]

$(ScriptOutDir)DgnScriptTest.js : $(tsSourceFiles)
    $(msg)
    $(TypeScriptCompile) $(tsSourceFiles) --target ES5 --noImplicitAny --removeComments --declaration $(DEBUG_PARMS) --out $(ScriptOutDir)DgnScriptTest.js
    ~time

%endif

$(BuildContext)Delivery/UnitTests/Script : $(ScriptOutDir)
    $(LinkFirstDepToFirstTargetAsDirectory)
