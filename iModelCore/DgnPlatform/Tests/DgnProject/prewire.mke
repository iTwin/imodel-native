#*--------------------------------------------------------------------------------------+
#
#     $Source: Tests/DgnProject/prewire.mke $
#
#  $Copyright: (c) 2016 Bentley Systems, Incorporated. All rights reserved. $
#
#--------------------------------------------------------------------------------------*/
%include mdl.mki

SrcDgnPlatform              = $(SrcRoot)DgnPlatform/
DgnPlatformPublicAPISrc     = $(SrcDgnPlatform)PublicAPI/
DgnPlatformAPISrc           = $(DgnPlatformPublicAPISrc)DgnPlatform/
baseDir                     = $(_makeFilePath)

$(BuildContext)Delivery/UnitTests/ECSchemas : $(baseDir)ECSchemas
    $(LinkFirstDepToFirstTargetAsDirectory)

$(BuildContext)Delivery/UnitTests/ignore_list.txt : $(baseDir)ignore_list.txt
    $(LinkFirstDepToFirstTarget)

$(BuildContext)Delivery/UnitTests/ScopedDgnHost.h : $(DgnPlatformAPISrc)UnitTests/ScopedDgnHost.h
    $(LinkFirstDepToFirstTarget)

$(BuildContext)Delivery/UnitTests/DgnDbTestUtils.h : $(DgnPlatformAPISrc)UnitTests/DgnDbTestUtils.h
    $(LinkFirstDepToFirstTarget)

#   -------------------------------------------------------------------------------------------
#   Compile .ts files to .js files, ready to be executed by script tests
#   -------------------------------------------------------------------------------------------
ScriptOutDir = $(OutputRootDir)build/DgnPlatform/UnitTests/Script/

always:
    !~@mkdir ${ScriptOutDir}

%ifndef BENTLEYCONFIG_NO_JAVASCRIPT

TypeScriptCompile = $(BuildContext)SubParts/NodeJs/node$(toolchainExeext) $(BuildContext)SubParts/TypeScript/tsc.js

#
#                   DgnScriptTest
#

tsSourceFiles = $[@wildcard $(baseDir)Published/DgnScriptTest/*.ts] $[@wildcard $(BuildContext)SubParts/Script/*.d.ts]

%if !defined(NDEBUG)
    DEBUG_PARMS = --sourceMap --sourceRoot $(baseDir)Published/DgnScriptTest --mapRoot ${ScriptOutDir}
%endif

$(ScriptOutDir)DgnScriptTest.js : $(tsSourceFiles)
    $(msg)
    $(TypeScriptCompile) $(tsSourceFiles) --target ES5 --noImplicitAny --removeComments --declaration $(DEBUG_PARMS) --out $@
    ~time

#
#                   ComponentModelTest
#
tsSourceFiles = $[@wildcard $(baseDir)Published/ComponentModelTest/*.ts] $[@wildcard $(BuildContext)SubParts/Script/*.d.ts]

%if !defined(NDEBUG)
    DEBUG_PARMS = --sourceMap --sourceRoot $(baseDir)Published/ComponentModelTest --mapRoot ${ScriptOutDir}
%endif

$(ScriptOutDir)ComponentModelTest.js : $(tsSourceFiles)
    $(msg)
    $(TypeScriptCompile) $(tsSourceFiles) --target ES5 --noImplicitAny --removeComments --declaration $(DEBUG_PARMS) --out $@
    ~time

%endif

$(BuildContext)Delivery/UnitTests/Script : $(ScriptOutDir)
    $(LinkFirstDepToFirstTargetAsDirectory)
