<?xml version="1.0" encoding="utf-8"?>

<BuildContext xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="../bsicommon/build/PartFile.xsd">

  <Part Name="MakeImodelJsAddonPackages" BentleyBuildMakeFile="imodeljs/nodejs/makeImodelJsAddonPackages.mke" >
    <SubProduct ProductName="iModelJsNodeAddon"/>
  </Part>

  <Product Name="iModelJsNodeAddon">
    <SubProduct ProductName="iModelJsNodeAddon-Windows" />
    <SubProduct ProductName="iModelJsNodeAddon-Linux" />
  </Product>

  <Product Name="iModelJsNodeAddon-Windows">
    <SubPart PartName="iModelJsNodeAddonLib-Windows" LibType="Dynamic" />
    <SubPart PartName="iModelJsNodeAddonLibElectron-Windows" LibType="Dynamic" />
    <Directories DirectoryListName="iModelJsNodeAddonDeliveryList" />
  </Product>

  <Product Name="iModelJsNodeAddon-Linux">
    <SubPart PartName="iModelJsNodeAddonLib-Linux" LibType="Static" />
    <Directories DirectoryListName="iModelJsNodeAddonDeliveryList" />
  </Product>

  <ProductDirectoryList ListName="iModelJsNodeAddonDeliveryList">
    <ProductDirectory Name="AddonRoot" Path="Addon" />
    <ProductDirectory Name="iModelJsNode_node_module" RelativeTo="AddonRoot"/>
    <ProductDirectory Name="iModelJsNode_node_module" RelativeTo="AddonRoot" LibType="Static" />
    <ProductDirectory Name="SupportingFilesRoot" Path="Support" />
    <ProductDirectory Name="Assemblies" Path="" RelativeTo="SupportingFilesRoot"/>
    <ProductDirectory Name="Assemblies" Deliver="false" LibType="Static"/>
    <ProductDirectory Name="Assets" Path="Assets" RelativeTo="SupportingFilesRoot"/>
    <ProductDirectory Name="Assets" Path="Assets" RelativeTo="SupportingFilesRoot" LibType="Static"/>

    <ProductDirectory Name="PresentationRules" Path="PresentationRules" RelativeTo="SupportingFilesRoot"/>
    <ProductDirectory Name="PresentationRules" Path="PresentationRules" RelativeTo="SupportingFilesRoot" LibType="Static"/>

    <ProductDirectory Name="VendorNotices"  RelativeTo="SupportingFilesRoot" Path="Notices"/>
    <ProductDirectory Name="VendorNotices"  RelativeTo="SupportingFilesRoot" Path="Notices" LibType="static"/>
  </ProductDirectoryList>

  <!-- Note - In the addon-creation parts below, the ProductSubDirectory name determines the name of the imodeljs-dgnplatform/addon subdirectory that the npm installer creates. 
      See copyNodeAddon.js. The runtime loadNodeAddon function then tries to match this subdirectory name against the version of node that is actually running. 
      So, you can use any naming schemes you want for the ingredients of the build, but you must use a name for the ProductSubDirectory that matches the expectations of copyNodeAddon.js.
      -->

  <Part Name="iModelJsNodeAddonLib-Windows" OnlyPlatforms="x64" ExcludeLibType="Static" BentleyBuildMakeFile="imodeljs/nodejs/addon.mke" BentleyBuildMakeOptions="-dNODE_GYP_VER=N_8_9_0" >
    <SubPart PartName="node-gyp-standalone_8_9_0" PartFile="nodejs" Repository="Thirdparty-nodejs"/>
    <SubPart PartName="iModelJsNodeAddonLibCommon"/>
    <Bindings>
      <Files ProductDirectoryName="iModelJsNode_node_module" ProductSubDirectory="N_8_9">
        Delivery/iModelJsNodeAddon/N_8_9_0/imodeljs.node,
        Delivery/iModelJsNodeAddon/N_8_9_0/package.json
      </Files>
      <Files ProductDirectoryName="Assets" ProductSubDirectory="PresentationRules">
        Delivery/PresentationRules/*.xml
      </Files>
    </Bindings>
  </Part>

  <!-- NB: Keep this version number consistent with nodejs:node-gyp-electron -->
  <Part Name="iModelJsNodeAddonLibElectron-Windows" OnlyPlatforms="x64" ExcludeLibType="Static" BentleyBuildMakeFile="imodeljs/nodejs/addon.mke" BentleyBuildMakeOptions="-dNODE_GYP_VER=E_1_6_11" >
    <SubPart PartName="node-gyp-electron_1_6_11" PartFile="nodejs" Repository="Thirdparty-nodejs"/>
    <SubPart PartName="iModelJsNodeAddonLibCommon"/>
    <Bindings>
      <!-- The ProductSubDirectory name determines the name of the imodeljs-dgnplatform/addon subdirectory, and that must match the version of electron node that is running. -->
      <Files ProductDirectoryName="iModelJsNode_node_module" ProductSubDirectory="E_1_6_11">
        Delivery/iModelJsNodeAddon/E_1_6_11/imodeljs.node,
        Delivery/iModelJsNodeAddon/E_1_6_11/package.json
      </Files>
      <Files ProductDirectoryName="Assets" ProductSubDirectory="PresentationRules">
        Delivery/PresentationRules/*.xml
      </Files>
    </Bindings>  </Part>

  <Part Name="iModelJsNodeAddonLib-Linux" OnlyPlatforms="Linux*" ExcludeLibType="Dynamic" BentleyBuildMakeFile="imodeljs/nodejs/addon.mke" BentleyBuildMakeOptions="-dNODE_GYP_VER=N_8_9_0">
    <SubPart PartName="node-gyp-standalone_8_9_0" PartFile="nodejs" Repository="Thirdparty-nodejs"/>
    <SubPart PartName="iModelJsNodeAddonLibCommon"/>
    <Bindings>
      <Files ProductDirectoryName="iModelJsNode_node_module" ProductSubDirectory="N_8_9">
        Delivery/iModelJsNodeAddon/N_8_9_0/imodeljs.node,
        Delivery/iModelJsNodeAddon/N_8_9_0/package.json
      </Files>
      <Files ProductDirectoryName="Assets" ProductSubDirectory="PresentationRules">
        Delivery/PresentationRules/*.xml
      </Files>	  
    </Bindings>
  </Part>

  <!-- This part builds our node native code addon -->
  <Part Name="iModelJsNodeAddonLibCommon">
    <SubPart PartName="DgnPlatformDLL" PartFile="DgnPlatform" Repository="DgnPlatform"/>
    <SubPart PartName="DgnPlatformSqlang" Repository="DgnPlatform" PartFile="DgnPlatform"/>
    <SubPart PartName="ECPresentation" PartFile="ECPresentation" Repository="ECPresentation"/>
    <SubPart PartName="ECObjectsNative"     PartFile="ECObjects"    Repository="ecobjects" />
    <SubPart PartName="RapidJson" PartFile="Libsrc-Nugets" Repository="bsicommon"/>
  </Part>

</BuildContext>
