#---------------------------------------------------------------------------------------+
#
#  Copyright (c) Bentley Systems, Incorporated. All rights reserved.
#
#---------------------------------------------------------------------------------------+

# %include mdl.mki - the include of BuildUnitTests.mke below does this, and would otherwise emit a warnings.

wsClientUnitTestsDir = $(SrcRoot)imodel02/iModelCore/WSClient/Tests/UnitTests/NonPublished/

#---------------------------------------------------------------------------------------+
#   Compile unit tests
#---------------------------------------------------------------------------------------+

BEGTEST_NAME = WSClientIntegrationTests
BEGTEST_INPUT = $(baseDir)
BEGTEST_OUTPUT = $(OutputRootDir)build/
BEGTEST_IGNORE= $(baseDir)ignore_list.txt

dirToSearch = $(wsClientUnitTestsDir)Utils/
%include cincapnd.mki
dirToSearch = $(OutRoot)Winx64/BuildContexts/WSClient/VendorAPI
%include cincapnd.mki
dirToSearch = $(OutRoot)Winx64/BuildContexts/WSClient/PublicAPI
%include cincapnd.mki

# Generate <prg.h> version file for tests
o = $(BEGTEST_OUTPUT)$(BEGTEST_NAME)/
%include $(SrcRoot)bsicommon/sharedmki/CreateBuildVersionHeader.mki 

%include $(SrcRoot)bsicommon/sharedmki/BuildUnitTests.mke
# $(o) is now $(BEGTEST_OUTPUT)$(BEGTEST_NAME)

#---------------------------------------------------------------------------------------+
#   Compile test utilities
#---------------------------------------------------------------------------------------+

# Compile rule
MultiCompileDepends = $(_MakeFileSpec)
%include MultiCppCompileRule.mki

# Sources to compile
$(o)StubInstances$(oext)            : $(wsClientUnitTestsDir)Utils/StubInstances.cpp ${MultiCompileDepends}

$(o)ValuePrinter$(oext)             : $(wsClientUnitTestsDir)Utils/ValuePrinter.cpp ${MultiCompileDepends}

$(o)WebServicesTestsHelper$(oext)   : $(wsClientUnitTestsDir)Utils/WebServicesTestsHelper.cpp ${MultiCompileDepends}

$(o)WSClientBaseTest$(oext)         : $(wsClientUnitTestsDir)Utils/WSClientBaseTest.cpp ${MultiCompileDepends}

$(o)CachingTestsHelper$(oext)       : $(wsClientUnitTestsDir)WebServices/Cache/CachingTestsHelper.cpp ${MultiCompileDepends}

%include MultiCppCompileGo.mki

#---------------------------------------------------------------------------------------+
#   Link test executable
#---------------------------------------------------------------------------------------+

%undef CPchOpts
%undef CCPchOpts

GUNITTEST_NAME      = $(BEGTEST_NAME)
GUNITTEST_NTLIBS    = advapi32.lib ole32.lib
GUNITTEST_OUT       = $(o)
GUNITTEST_DEST      = $(o)
GUNITTEST_PATH      = $(o) 
GUNITTEST_SYMB      = $(o)

GTEST_MAIN_IS_SUPPLIED = 1

LOCAL_GUNITTEST_OBJS + $[@wildcard $(o)*.obj]

LIB_DIR =  $(BuildContext)SubParts/Libs/

GUNITTEST_LIBS + $(LIB_DIR)$(libprefix)Bentley$(libext)
GUNITTEST_LIBS + $(LIB_DIR)$(libprefix)BeHttp$(libext)
GUNITTEST_LIBS + $(LIB_DIR)$(libprefix)BeSQLite$(libext)
GUNITTEST_LIBS + $(LIB_DIR)$(libprefix)BeSQLiteEC$(libext)
GUNITTEST_LIBS + $(LIB_DIR)$(libprefix)BeJsonCpp$(libext)
GUNITTEST_LIBS + $(LIB_DIR)$(libprefix)ECObjects$(libext)
GUNITTEST_LIBS + $(LIB_DIR)$(libprefix)Units$(libext)
GUNITTEST_LIBS + $(LIB_DIR)$(libprefix)BeCurl$(libext)
GUNITTEST_LIBS + $(LIB_DIR)$(libprefix)BeLibxml2$(libext)
GUNITTEST_LIBS + $(LIB_DIR)$(libprefix)WebServicesCache$(libext)
GUNITTEST_LIBS + $(LIB_DIR)$(libprefix)WebServicesClient$(libext)
GUNITTEST_LIBS + $(LIB_DIR)$(libprefix)BeIcu4c$(libext)
GUNITTEST_LIBS + $(LIB_DIR)$(libprefix)bentleylog4cxx$(libext)
GUNITTEST_LIBS + $(LIB_DIR)$(libprefix)CCApi$(libext)
GUNITTEST_LIBS + $(LIB_DIR)$(libprefix)gmock$(libext)
GUNITTEST_LIBS + $(LIB_DIR)$(libprefix)gtest$(libext)
GUNITTEST_LIBS + $(BuildContext)SubParts/StaticLibs/$(libprefix)liblog4cxx010$(libext)

# Don't run tests after build
GUNITTEST_NOEXEC = 1

%include $(SrcRoot)bsicommon/sharedmki/gunittest.mki

ApiNumber = M02

subparts:
    ~linkfile "$(BuildContext)Delivery/$(libprefix)BeIcu4cB02$(shlibext)=$(BuildContext)SubParts/Assemblies/$(libprefix)BeIcu4cB02$(shlibext)"
    ~linkfile "$(BuildContext)Delivery/$(libprefix)freetype2B02$(shlibext)=$(BuildContext)SubParts/Assemblies/$(libprefix)freetype2B02$(shlibext)"
    ~linkfile "$(BuildContext)Delivery/$(libprefix)BeOpenSSLB02$(shlibext)=$(BuildContext)SubParts/Assemblies/$(libprefix)BeOpenSSLB02$(shlibext)"
    ~linkfile "$(BuildContext)Delivery/$(libprefix)BeCurlB02$(shlibext)=$(BuildContext)SubParts/Assemblies/$(libprefix)BeCurlB02$(shlibext)"
    ~linkfile "$(BuildContext)Delivery/$(libprefix)BeLibxml2B02$(shlibext)=$(BuildContext)SubParts/Assemblies/$(libprefix)BeLibxml2B02$(shlibext)"
    ~linkfile "$(BuildContext)Delivery/$(libprefix)BaseGeoCoord$(ApiNumber)$(shlibext)=$(BuildContext)SubParts/Assemblies/$(libprefix)BaseGeoCoord$(ApiNumber)$(shlibext)"
    ~linkfile "$(BuildContext)Delivery/$(libprefix)Bentley$(ApiNumber)$(shlibext)=$(BuildContext)SubParts/Assemblies/$(libprefix)Bentley$(ApiNumber)$(shlibext)"
    ~linkfile "$(BuildContext)Delivery/$(libprefix)BeXml$(ApiNumber)$(shlibext)=$(BuildContext)SubParts/Assemblies/$(libprefix)BeXml$(ApiNumber)$(shlibext)"
    ~linkfile "$(BuildContext)Delivery/$(libprefix)BeSQLite$(ApiNumber)$(shlibext)=$(BuildContext)SubParts/Assemblies/$(libprefix)BeSQLite$(ApiNumber)$(shlibext)"
    ~linkfile "$(BuildContext)Delivery/$(libprefix)BentleyGeom$(ApiNumber)$(shlibext)=$(BuildContext)SubParts/Assemblies/$(libprefix)BentleyGeom$(ApiNumber)$(shlibext)"
    ~linkfile "$(BuildContext)Delivery/$(libprefix)BeFolly$(ApiNumber)$(shlibext)=$(BuildContext)SubParts/Assemblies/$(libprefix)BeFolly$(ApiNumber)$(shlibext)"
    ~linkfile "$(BuildContext)Delivery/$(libprefix)Units$(ApiNumber)$(shlibext)=$(BuildContext)SubParts/Assemblies/$(libprefix)Units$(ApiNumber)$(shlibext)"
    ~linkfile "$(BuildContext)Delivery/$(libprefix)BeHttp$(ApiNumber)$(shlibext)=$(BuildContext)SubParts/Assemblies/$(libprefix)BeHttp$(ApiNumber)$(shlibext)"
    ~linkfile "$(BuildContext)Delivery/$(libprefix)BentleyGeomSerialization$(ApiNumber)$(shlibext)=$(BuildContext)SubParts/Assemblies/$(libprefix)BentleyGeomSerialization$(ApiNumber)$(shlibext)"
    ~linkfile "$(BuildContext)Delivery/$(libprefix)BeSecurity$(ApiNumber)$(shlibext)=$(BuildContext)SubParts/Assemblies/$(libprefix)BeSecurity$(ApiNumber)$(shlibext)"
    ~linkfile "$(BuildContext)Delivery/$(libprefix)ECObjects$(ApiNumber)$(shlibext)=$(BuildContext)SubParts/Assemblies/$(libprefix)ECObjects$(ApiNumber)$(shlibext)"
    ~linkfile "$(BuildContext)Delivery/$(libprefix)BeSQLiteEC$(ApiNumber)$(shlibext)=$(BuildContext)SubParts/Assemblies/$(libprefix)BeSQLiteEC$(ApiNumber)$(shlibext)"
    ~linkfile "$(BuildContext)Delivery/$(libprefix)WebServicesClient$(ApiNumber)$(shlibext)=$(BuildContext)SubParts/Assemblies/$(libprefix)WebServicesClient$(ApiNumber)$(shlibext)"
    ~linkfile "$(BuildContext)Delivery/$(libprefix)WebServicesCache$(ApiNumber)$(shlibext)=$(BuildContext)SubParts/Assemblies/$(libprefix)WebServicesCache$(ApiNumber)$(shlibext)"
