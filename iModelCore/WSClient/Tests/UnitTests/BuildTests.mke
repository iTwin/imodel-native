#----------------------------------------------------------------------------------------
#
#  $Source: Tests/UnitTests/BuildTests.mke $
#
#  $Copyright: (c) 2018 Bentley Systems, Incorporated. All rights reserved. $
#
#----------------------------------------------------------------------------------------
%include mdl.mki

%ifndef TestDir
    %error must define TestDir
%endif

baseDir = $(_MakeFilePath)

CompileOptionsMki = $(baseDir)CompileOptions.mki
%include $(CompileOptionsMki)

%ifdef UsePublishedApi
    # Make sure macro has a value so it can be exported to the environment
    UsePublishedApi = 1
%endif

%ifdef BUILD_AGGREGATE_TESTS
    nameToDefine=BUILD_FOR_AGGREGATE_TESTS=1
    %include cdefapnd.mki
%endif

%ifdef ENABLE_DGNDBSERVER_UNIT_TESTS
    nameToDefine = DGNDBSERVER_UNIT_TESTS=1
    %include cdefapnd.mki
%endif

# Compile and Link the unit tests
BEGTEST_NAME  = $(TestDir)WebServices
BEGTEST_INPUT = $(baseDir)$(TestDir)/
BEGTEST_IGNORE= $(baseDir)ignore_list.txt
BEGTEST_OUTPUT=$(OutputRootDir)build/WebServices/UnitTests/
o = $(BEGTEST_OUTPUT)$(BEGTEST_NAME)/

%if $(TARGET_PLATFORM) != "WinRT"
    # Create precompiled headers
    PchCompiland        = $(baseDir)$(TestDir)/WSClientUnitTestsPch.cpp
    PchOutputDir        = $(o)

    # Export bmake macros to make them accessible during precompiled headers compilation.
    always:
        ~putenv CCompPDBName=$(BEGTEST_NAME)
        ~putenv UsePublishedApi=$(UsePublishedApi)

    %include $(SharedMki)PreCompileHeader.mki

    CCPchOpts = $(UsePrecompiledHeaderOptions)
    CPchOpts  = $(UsePrecompiledHeaderOptions)

    # Force the precompiled headers to be included at the top of each .cpp file.
    CCCompOpts + -FIWSClientUnitTestsPch.h
%endif

%include $(SrcRoot)bsicommon/sharedmki/DetectAndCompileUnitTests.mki

# Deliver 
$(BuildContext)Delivery/UnitTests/Objects/$(TestDir) : ${o}
    $(LinkFirstDepToFirstTargetAsDirectory)
