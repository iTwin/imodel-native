/*---------------------------------------------------------------------------------------------
* Copyright (c) Bentley Systems, Incorporated. All rights reserved.
* See COPYRIGHT.md in the repository root for full copyright notice.
*--------------------------------------------------------------------------------------------*/

#include <WebServices/Cache/Util/ECCustomAttributeHelper.h>

#include <Bentley/BeDebugLog.h>

USING_NAMESPACE_BENTLEY_WEBSERVICES

/*--------------------------------------------------------------------------------------+
* @bsimethod                                                    Vincas.Razma    09/2013
+---------------+---------------+---------------+---------------+---------------+------*/
ECValue ECCustomAttributeHelper::GetValue(IECCustomAttributeContainerCP caContainer, Utf8CP caName, Utf8CP caPropertyName)
    {
    ECValue value;
    if (nullptr != caContainer)
        {
        IECInstancePtr attribute = caContainer->GetCustomAttribute(caName);
        if (!attribute.IsNull())
            {
            attribute->GetValue(value, caPropertyName);
            }
        }
    return value;
    }

/*--------------------------------------------------------------------------------------+
* @bsimethod                                                    Vincas.Razma    09/2013
+---------------+---------------+---------------+---------------+---------------+------*/
int32_t ECCustomAttributeHelper::GetInteger(IECCustomAttributeContainerCP caContainer, Utf8CP caName, Utf8CP caPropertyName, int32_t defaultValue)
    {
    ECValue value = GetValue(caContainer, caName, caPropertyName);
    if (value.IsNull())
        {
        return defaultValue;
        }
    return value.GetInteger();
    }

/*--------------------------------------------------------------------------------------+
* @bsimethod                                                    Vincas.Razma    09/2013
+---------------+---------------+---------------+---------------+---------------+------*/
bool ECCustomAttributeHelper::GetBool(IECCustomAttributeContainerCP caContainer, Utf8CP caName, Utf8CP caPropertyName, bool defaultValue)
    {
    ECValue value = GetValue(caContainer, caName, caPropertyName);
    if (value.IsNull())
        {
        return defaultValue;
        }
    return value.GetBoolean();
    }

/*--------------------------------------------------------------------------------------+
* @bsimethod                                                    Vincas.Razma    09/2013
+---------------+---------------+---------------+---------------+---------------+------*/
Utf8String ECCustomAttributeHelper::GetString(IECCustomAttributeContainerCP caContainer, Utf8CP caName, Utf8CP caPropertyName)
    {
    Utf8String stringValue;
    ECValue value = GetValue(caContainer, caName, caPropertyName);
    if (!value.IsNull())
        {
        stringValue = value.GetUtf8CP();
        }
    return stringValue;
    }

/*--------------------------------------------------------------------------------------+
* @bsimethod                                                    Vincas.Razma    09/2013
+---------------+---------------+---------------+---------------+---------------+------*/
bvector<Utf8String> ECCustomAttributeHelper::GetStringArray(IECCustomAttributeContainerCP caContainer, Utf8CP caName, Utf8CP caPropertyName)
    {
    bvector<Utf8String> values;

    IECInstancePtr attribute;
    ECValue arrayValue;
    if (nullptr != caContainer)
        {
        attribute = caContainer->GetCustomAttribute(caName);
        if (!attribute.IsNull())
            {
            attribute->GetValue(arrayValue, caPropertyName);
            }
        }

    if (!arrayValue.IsNull())
        {
        for (uint32_t i = 0; i < arrayValue.GetArrayInfo().GetCount(); i++)
            {
            ECValue itemValue;
            attribute->GetValue(itemValue, caPropertyName, i);

            values.push_back(itemValue.GetUtf8CP());
            }
        }

    return values;
    }

/*--------------------------------------------------------------------------------------+
* @bsimethod                                                    Vincas.Razma    09/2013
+---------------+---------------+---------------+---------------+---------------+------*/
void ECCustomAttributeHelper::ValidatePropertyName(ECClassCP ecClass, Utf8StringR propertyName)
    {
    if (propertyName.empty())
        {
        return;
        }
    if (ecClass->GetPropertyP(propertyName.c_str()) == nullptr)
        {
        BeDebugLog(Utf8PrintfString("Custom attribute defines property name \"%s\" that does not exist in class \"%s\"",
            propertyName.c_str(), Utf8String(ecClass->GetName()).c_str()).c_str());
        BeAssert(false);
        propertyName.clear();
        }
    }

/*--------------------------------------------------------------------------------------+
* @bsimethod                                                    Vincas.Razma    09/2013
+---------------+---------------+---------------+---------------+---------------+------*/
Utf8String ECCustomAttributeHelper::GetPropertyName(ECClassCP ecClass, Utf8CP caName, Utf8CP caPropertyName)
    {
    Utf8String propertyName = GetString(ecClass, caName, caPropertyName);
    ValidatePropertyName(ecClass, propertyName);
    return propertyName;
    }

/*--------------------------------------------------------------------------------------+
* @bsimethod                                                    Vincas.Razma    10/2013
+---------------+---------------+---------------+---------------+---------------+------*/
bvector<Utf8String> ECCustomAttributeHelper::GetPropertyNameArray(ECClassCP ecClass, Utf8CP caName, Utf8CP caPropertyName)
    {
    bvector<Utf8String> properties;

    bvector<Utf8String> values = GetStringArray(ecClass, caName, caPropertyName);
    for (Utf8StringR propertyName : values)
        {
        ValidatePropertyName(ecClass, propertyName);

        if (!propertyName.empty())
            {
            properties.push_back(propertyName);
            }
        }

    return properties;
    }

/*--------------------------------------------------------------------------------------+
* @bsimethod                                                    Vincas.Razma    10/2013
+---------------+---------------+---------------+---------------+---------------+------*/
bset<Utf8String> ECCustomAttributeHelper::GetPropertyNameSet(ECClassCP ecClass, Utf8CP caName, Utf8CP caPropertyName)
    {
    bset<Utf8String> properties;

    bvector<Utf8String> values = GetStringArray(ecClass, caName, caPropertyName);
    for (Utf8StringR propertyName : values)
        {
        ValidatePropertyName(ecClass, propertyName);

        if (!propertyName.empty())
            {
            properties.insert(propertyName);
            }
        }

    return properties;
    }
