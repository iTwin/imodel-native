/*--------------------------------------------------------------------------------------+
|
|     $Source: Tests/IntegrationTests/Published/SaasClientIntegrationTests.cpp $
|
|  $Copyright: (c) 2019 Bentley Systems, Incorporated. All rights reserved. $
|
+--------------------------------------------------------------------------------------*/

#include "SaasClientIntegrationTests.h"
#include "TestsHelper.h"
#include "DummyPolicyHelper.h"

#include <Licensing/Utils/DateHelper.h>
#include <Licensing/Utils/SCVWritter.h>
#include "../../../Licensing/LicensingDb.h"
//#include "../Helpers/OIDC/OidcSignInManager.h"

//#include "../../../Licensing/Providers/IAuthHandlerProvider.h"
//#include "../../Licensing/Providers/IBuddiProvider.h"
//#include "../../Licensing/Providers/IPolicyProvider.h"
//#include "../../Licensing/Providers/IUlasProvider.h"

#include "../../../Licensing/Providers/BuddiProvider.h"
#include "../../../Licensing/Providers/UlasProvider.h"

#include <BeHttp/HttpClient.h>
#include <BeHttp/ProxyHttpHandler.h>
#include <BeSQLite/BeSQLite.h>
#include <BeSQLite/L10N.h>
#include <fstream>
#include <Licensing/Utils/InMemoryJsonLocalState.h>

#include <WebServices/Configuration/UrlProvider.h>
#include <WebServices/Connect/ConnectSignInManager.h>

#include  <OidcNativeClient/OidcNative.h>

#define TEST_PRODUCT_ID      "2545"
#define OIDC_CLIENT_ID "cplc-integration-tests-guwkmv6sxwn4ro05bvei7l1r2"
#define OIDC_SCOPES "openid email profile entitlement-policy-service-2576 ulas-log-location-2728 ulas-realtime-log-posting-2733"

USING_NAMESPACE_BENTLEY_LICENSING
USING_NAMESPACE_BENTLEY_LICENSING_INTEGRATION_TESTS
USING_NAMESPACE_BENTLEY_HTTP
USING_NAMESPACE_BENTLEY_WEBSERVICES
USING_NAMESPACE_BENTLEY_SQLITE

using namespace OidcInterop;

/*--------------------------------------------------------------------------------------+
* @bsimethod
+---------------+---------------+---------------+---------------+---------------+------*/
SaasClientIntegrationTests::SaasClientIntegrationTests() {}

/*--------------------------------------------------------------------------------------+
* @bsimethod
+---------------+---------------+---------------+---------------+---------------+------*/
void SaasClientIntegrationTests::TearDown() {}

/*--------------------------------------------------------------------------------------+
* @bsimethod
+---------------+---------------+---------------+---------------+---------------+------*/
void SaasClientIntegrationTests::SetUpTestCase()
    {
    // This is only an example of how to set logging severity and see info logs. Usually should be set more globally than in TestCase SetUp
    // NativeLogging::LoggingConfig::SetSeverity(LOGGER_NAMESPACE_BENTLEY_LICENSING, BentleyApi::NativeLogging::LOG_DEBUG);

    NativeLogging::LoggingConfig::SetSeverity(LOGGER_NAMESPACE_BENTLEY_LICENSING, BentleyApi::NativeLogging::LOG_INFO);
    NativeLogging::LoggingConfig::SetSeverity(LOGGER_NAMESPACE_BENTLEY_LICENSING, BentleyApi::NativeLogging::LOG_DEBUG);
    NativeLogging::LoggingConfig::SetSeverity(LOGGER_NAMESPACE_BENTLEY_LICENSING, BentleyApi::NativeLogging::LOG_TRACE);

    BeFileName asssetsDir;
    BeTest::GetHost().GetDgnPlatformAssetsDirectory(asssetsDir);
    HttpClient::Initialize(asssetsDir);

    BeFileName tmpDir;
    BeTest::GetHost().GetTempDir(tmpDir);
    BeSQLiteLib::Initialize(tmpDir);

    BeFileName path;
    BeTest::GetHost().GetDgnPlatformAssetsDirectory(path);
    path.AppendToPath(L"TestAssets/sqlang/DgnClientFx_en.sqlang.db3");

    ASSERT_EQ(SUCCESS, L10N::Initialize(BeSQLite::L10N::SqlangFiles(path)));
    }

SaasClientPtr SaasClientIntegrationTests::CreateTestSaasClient(int productId) const
    {
    InMemoryJsonLocalState* localState = new InMemoryJsonLocalState();
    UrlProvider::Initialize(UrlProvider::Environment::Qa, UrlProvider::DefaultTimeout, localState);

    auto proxy = ProxyHttpHandler::GetFiddlerProxyIfReachable();

    return SaasClient::Create
        (
        productId,
        "",
        proxy
        );
    }

SaasClientImplPtr SaasClientIntegrationTests::CreateTestSaasClientImpl(int productId) const
    {
    InMemoryJsonLocalState* localState = new InMemoryJsonLocalState();
    UrlProvider::Initialize(UrlProvider::Environment::Qa, UrlProvider::DefaultTimeout, localState);
    auto proxy = ProxyHttpHandler::GetFiddlerProxyIfReachable();

    IBuddiProviderPtr buddiProvider = std::make_shared<BuddiProvider>();
    IUlasProviderPtr ulasProvider = std::make_shared<UlasProvider>(buddiProvider, proxy);

    //auto oidcManager = OidcSignInManager();

    return std::make_shared<SaasClientImpl>
        (
        productId,
        "",
        ulasProvider
        );
    }

TEST_F(SaasClientIntegrationTests, DISABLED_Equality_Test)
    {
    // NOTE: statuses are cast to int so that if test fails, logs will show human-readable values (rather than byte representation of enumeration value)
    ASSERT_EQ((int)1, (int)1); // Mock policy should result in NotEntitled
    }

// Tests using the Client's Create method
TEST_F(SaasClientIntegrationTests, FactoryTrackUsage_Success)
    {
    auto client = CreateTestSaasClient(std::atoi(TEST_PRODUCT_ID));

    auto oidcToken = OIDCNative::IssueToken("qa2_devuser2@mailinator.com", "bentley", UrlProvider::Urls::IMSOpenID.Get().c_str(), OIDC_CLIENT_ID, OIDC_SCOPES);
    LOG.debugv("token issued: %s", Utf8CP(oidcToken));
    auto version = BeVersion(1, 0);
    Utf8String projectId = "00000000-0000-0000-0000-000000000000";

    EXPECT_NE(static_cast<int>(client->TrackUsage(oidcToken, version, projectId).get()), static_cast<int>(BentleyStatus::ERROR));
    }

TEST_F(SaasClientIntegrationTests, FactoryMarkFeature_Success)
    {
    auto client = CreateTestSaasClient(std::atoi(TEST_PRODUCT_ID));

    auto oidcToken = OIDCNative::IssueToken("qa2_devuser2@mailinator.com", "bentley", UrlProvider::Urls::IMSOpenID.Get().c_str(), OIDC_CLIENT_ID, OIDC_SCOPES);
    LOG.debugv("token issued: %s", Utf8CP(oidcToken));

    auto version = BeVersion(1, 0);
    Utf8String projectId = "00000000-0000-0000-0000-000000000000";
    Utf8String featureId = "e49af0e9-1d2b-4385-b5c5-ce50b07693d3"; // featureID must be a GUID

    FeatureUserDataMapPtr featureData = std::make_shared<FeatureUserDataMap>();

    featureData->AddAttribute("Manufacturer", "Bentley Systems, Inc.");
    featureData->AddAttribute("Website", "https://www.w3schools.com");
    featureData->AddAttribute("Title", "Mobile App");

    FeatureEvent featureEvent = FeatureEvent(featureId, version, projectId, featureData);

    EXPECT_NE(static_cast<int>(client->MarkFeature(oidcToken, featureEvent).get()), static_cast<int>(BentleyStatus::ERROR));
    }

// Tests using the a SAML token instead of OIDC
TEST_F(SaasClientIntegrationTests, DISABLED_FactoryTrackUsageSaml_Success)
    {
    auto client = CreateTestSaasClient(std::atoi(TEST_PRODUCT_ID));

    //auto oidcToken = OIDCNative::IssueToken("qa2_devuser2@mailinator.com", "bentley", UrlProvider::Urls::IMSOpenID.Get().c_str(), OIDC_CLIENT_ID, OIDC_SCOPES);
    //LOG.debugv("token issued: %s", Utf8CP(oidcToken));
    auto version = BeVersion(1, 0);
    Utf8String projectId = "00000000-0000-0000-0000-000000000000";

    // TODO: sign-in and get a saml token

    // need to update this to have a valid saml token
    Utf8String saml = "PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0idXRmLTE2Ij8+PHNhbWw6QXNzZXJ0aW9uIE1ham9yVmVyc2lvbj0iMSIgTWlub3JWZXJzaW9uPSIxIiBBc3NlcnRpb25JRD0iX2E2YWFlMzE2LTBjM2MtNDNkMi04OTc2LWEyMGZhYzFmYWVkZSIgSXNzdWVyPSJodHRwczovL3FhLWltcy5iZW50bGV5LmNvbS8iIElzc3VlSW5zdGFudD0iMjAxOS0wNi0yMVQxNTo0MDo0OC42NzBaIiB4bWxuczpzYW1sPSJ1cm46b2FzaXM6bmFtZXM6dGM6U0FNTDoxLjA6YXNzZXJ0aW9uIj48c2FtbDpDb25kaXRpb25zIE5vdEJlZm9yZT0iMjAxOS0wNi0yMVQxNTo0MDo0OC42NTRaIiBOb3RPbk9yQWZ0ZXI9IjIwMTktMDYtMjhUMTU6NDA6NDguNjU0WiI+PHNhbWw6QXVkaWVuY2VSZXN0cmljdGlvbkNvbmRpdGlvbj48c2FtbDpBdWRpZW5jZT5odHRwczovL2Rldi1jb25uZWN0LXVsYXN0bS5iZW50bGV5LmNvbS88L3NhbWw6QXVkaWVuY2U+PC9zYW1sOkF1ZGllbmNlUmVzdHJpY3Rpb25Db25kaXRpb24+PC9zYW1sOkNvbmRpdGlvbnM+PHNhbWw6QXR0cmlidXRlU3RhdGVtZW50PjxzYW1sOlN1YmplY3Q+PHNhbWw6TmFtZUlkZW50aWZpZXI+YmU3YjlmNGYtNWIxZS00YWY4LWJiMDUtNmUwNjBhNmE0OGRiPC9zYW1sOk5hbWVJZGVudGlmaWVyPjxzYW1sOlN1YmplY3RDb25maXJtYXRpb24+PHNhbWw6Q29uZmlybWF0aW9uTWV0aG9kPnVybjpvYXNpczpuYW1lczp0YzpTQU1MOjEuMDpjbTpob2xkZXItb2Yta2V5PC9zYW1sOkNvbmZpcm1hdGlvbk1ldGhvZD48S2V5SW5mbyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC8wOS94bWxkc2lnIyI+PHRydXN0OkJpbmFyeVNlY3JldCB4bWxuczp0cnVzdD0iaHR0cDovL2RvY3Mub2FzaXMtb3Blbi5vcmcvd3Mtc3gvd3MtdHJ1c3QvMjAwNTEyIj5TOWhwYnRMbk5Tb2dNSVIyM2xxTmdqb1JtcnF3YVZudk5jak1WNTgyMURFPTwvdHJ1c3Q6QmluYXJ5U2VjcmV0PjwvS2V5SW5mbz48L3NhbWw6U3ViamVjdENvbmZpcm1hdGlvbj48L3NhbWw6U3ViamVjdD48c2FtbDpBdHRyaWJ1dGUgQXR0cmlidXRlTmFtZT0ibmFtZSIgQXR0cmlidXRlTmFtZXNwYWNlPSJodHRwOi8vc2NoZW1hcy54bWxzb2FwLm9yZy93cy8yMDA1LzA1L2lkZW50aXR5L2NsYWltcyI+PHNhbWw6QXR0cmlidXRlVmFsdWU+amFzb24ud2ljaGVydEBiZW50bGV5LmNvbTwvc2FtbDpBdHRyaWJ1dGVWYWx1ZT48L3NhbWw6QXR0cmlidXRlPjxzYW1sOkF0dHJpYnV0ZSBBdHRyaWJ1dGVOYW1lPSJnaXZlbm5hbWUiIEF0dHJpYnV0ZU5hbWVzcGFjZT0iaHR0cDovL3NjaGVtYXMueG1sc29hcC5vcmcvd3MvMjAwNS8wNS9pZGVudGl0eS9jbGFpbXMiPjxzYW1sOkF0dHJpYnV0ZVZhbHVlPkphc29uPC9zYW1sOkF0dHJpYnV0ZVZhbHVlPjwvc2FtbDpBdHRyaWJ1dGU+PHNhbWw6QXR0cmlidXRlIEF0dHJpYnV0ZU5hbWU9InN1cm5hbWUiIEF0dHJpYnV0ZU5hbWVzcGFjZT0iaHR0cDovL3NjaGVtYXMueG1sc29hcC5vcmcvd3MvMjAwNS8wNS9pZGVudGl0eS9jbGFpbXMiPjxzYW1sOkF0dHJpYnV0ZVZhbHVlPldpY2hlcnQ8L3NhbWw6QXR0cmlidXRlVmFsdWU+PC9zYW1sOkF0dHJpYnV0ZT48c2FtbDpBdHRyaWJ1dGUgQXR0cmlidXRlTmFtZT0iZW1haWxhZGRyZXNzIiBBdHRyaWJ1dGVOYW1lc3BhY2U9Imh0dHA6Ly9zY2hlbWFzLnhtbHNvYXAub3JnL3dzLzIwMDUvMDUvaWRlbnRpdHkvY2xhaW1zIj48c2FtbDpBdHRyaWJ1dGVWYWx1ZT5KYXNvbi5XaWNoZXJ0QGJlbnRsZXkuY29tPC9zYW1sOkF0dHJpYnV0ZVZhbHVlPjwvc2FtbDpBdHRyaWJ1dGU+PHNhbWw6QXR0cmlidXRlIEF0dHJpYnV0ZU5hbWU9InJvbGUiIEF0dHJpYnV0ZU5hbWVzcGFjZT0iaHR0cDovL3NjaGVtYXMubWljcm9zb2Z0LmNvbS93cy8yMDA4LzA2L2lkZW50aXR5L2NsYWltcyI+PHNhbWw6QXR0cmlidXRlVmFsdWU+UHJvamVjdCBNYW5hZ2VyPC9zYW1sOkF0dHJpYnV0ZVZhbHVlPjxzYW1sOkF0dHJpYnV0ZVZhbHVlPkJFTlRMRVlfRU1QTE9ZRUU8L3NhbWw6QXR0cmlidXRlVmFsdWU+PHNhbWw6QXR0cmlidXRlVmFsdWU+U0lURV9BRE1JTklTVFJBVE9SPC9zYW1sOkF0dHJpYnV0ZVZhbHVlPjwvc2FtbDpBdHRyaWJ1dGU+PHNhbWw6QXR0cmlidXRlIEF0dHJpYnV0ZU5hbWU9InVsdGltYXRlc2l0ZSIgQXR0cmlidXRlTmFtZXNwYWNlPSJodHRwOi8vc2NoZW1hcy5iZW50bGV5LmNvbS93cy8yMDExLzAzL2lkZW50aXR5L2NsYWltcyI+PHNhbWw6QXR0cmlidXRlVmFsdWU+MTAwMTM4OTExNzwvc2FtbDpBdHRyaWJ1dGVWYWx1ZT48L3NhbWw6QXR0cmlidXRlPjxzYW1sOkF0dHJpYnV0ZSBBdHRyaWJ1dGVOYW1lPSJzYXBlbnRpdGxlbWVudCIgQXR0cmlidXRlTmFtZXNwYWNlPSJodHRwOi8vc2NoZW1hcy5iZW50bGV5LmNvbS93cy8yMDExLzAzL2lkZW50aXR5L2NsYWltcyI+PHNhbWw6QXR0cmlidXRlVmFsdWU+SU5URVJOQUw8L3NhbWw6QXR0cmlidXRlVmFsdWU+PHNhbWw6QXR0cmlidXRlVmFsdWU+QkVOVExFWV9MRUFSTjwvc2FtbDpBdHRyaWJ1dGVWYWx1ZT48c2FtbDpBdHRyaWJ1dGVWYWx1ZT5TRUxFQ1RfMjAwNjwvc2FtbDpBdHRyaWJ1dGVWYWx1ZT48L3NhbWw6QXR0cmlidXRlPjxzYW1sOkF0dHJpYnV0ZSBBdHRyaWJ1dGVOYW1lPSJlbnRpdGxlbWVudCIgQXR0cmlidXRlTmFtZXNwYWNlPSJodHRwOi8vc2NoZW1hcy5iZW50bGV5LmNvbS93cy8yMDExLzAzL2lkZW50aXR5L2NsYWltcyI+PHNhbWw6QXR0cmlidXRlVmFsdWU+QkVOVExFWV9FTVBMT1lFRTwvc2FtbDpBdHRyaWJ1dGVWYWx1ZT48c2FtbDpBdHRyaWJ1dGVWYWx1ZT5CRU5UTEVZX0xFQVJOPC9zYW1sOkF0dHJpYnV0ZVZhbHVlPjxzYW1sOkF0dHJpYnV0ZVZhbHVlPlNFTEVDVF8yMDA2PC9zYW1sOkF0dHJpYnV0ZVZhbHVlPjwvc2FtbDpBdHRyaWJ1dGU+PHNhbWw6QXR0cmlidXRlIEF0dHJpYnV0ZU5hbWU9ImNvdW50cnlpc28iIEF0dHJpYnV0ZU5hbWVzcGFjZT0iaHR0cDovL3NjaGVtYXMuYmVudGxleS5jb20vd3MvMjAxMS8wMy9pZGVudGl0eS9jbGFpbXMiPjxzYW1sOkF0dHJpYnV0ZVZhbHVlPlVTPC9zYW1sOkF0dHJpYnV0ZVZhbHVlPjwvc2FtbDpBdHRyaWJ1dGU+PHNhbWw6QXR0cmlidXRlIEF0dHJpYnV0ZU5hbWU9Imxhbmd1YWdlaXNvIiBBdHRyaWJ1dGVOYW1lc3BhY2U9Imh0dHA6Ly9zY2hlbWFzLmJlbnRsZXkuY29tL3dzLzIwMTEvMDMvaWRlbnRpdHkvY2xhaW1zIj48c2FtbDpBdHRyaWJ1dGVWYWx1ZT5FTjwvc2FtbDpBdHRyaWJ1dGVWYWx1ZT48L3NhbWw6QXR0cmlidXRlPjxzYW1sOkF0dHJpYnV0ZSBBdHRyaWJ1dGVOYW1lPSJpc21hcmtldGluZ3Byb3NwZWN0IiBBdHRyaWJ1dGVOYW1lc3BhY2U9Imh0dHA6Ly9zY2hlbWFzLmJlbnRsZXkuY29tL3dzLzIwMTEvMDMvaWRlbnRpdHkvY2xhaW1zIj48c2FtbDpBdHRyaWJ1dGVWYWx1ZT5mYWxzZTwvc2FtbDpBdHRyaWJ1dGVWYWx1ZT48L3NhbWw6QXR0cmlidXRlPjxzYW1sOkF0dHJpYnV0ZSBBdHRyaWJ1dGVOYW1lPSJpc2JlbnRsZXllbXBsb3llZSIgQXR0cmlidXRlTmFtZXNwYWNlPSJodHRwOi8vc2NoZW1hcy5iZW50bGV5LmNvbS93cy8yMDExLzAzL2lkZW50aXR5L2NsYWltcyI+PHNhbWw6QXR0cmlidXRlVmFsdWU+dHJ1ZTwvc2FtbDpBdHRyaWJ1dGVWYWx1ZT48L3NhbWw6QXR0cmlidXRlPjxzYW1sOkF0dHJpYnV0ZSBBdHRyaWJ1dGVOYW1lPSJiZWNvbW11bml0aWVzdXNlcm5hbWUiIEF0dHJpYnV0ZU5hbWVzcGFjZT0iaHR0cDovL3NjaGVtYXMuYmVudGxleS5jb20vd3MvMjAxMS8wMy9pZGVudGl0eS9jbGFpbXMiPjxzYW1sOkF0dHJpYnV0ZVZhbHVlPkJFN0I5RjRGLTVCMUUtNEFGOC1CQjA1LTZFMDYwQTZBNDhEQjwvc2FtbDpBdHRyaWJ1dGVWYWx1ZT48L3NhbWw6QXR0cmlidXRlPjxzYW1sOkF0dHJpYnV0ZSBBdHRyaWJ1dGVOYW1lPSJiZWNvbW11bml0aWVzZW1haWxhZGRyZXNzIiBBdHRyaWJ1dGVOYW1lc3BhY2U9Imh0dHA6Ly9zY2hlbWFzLmJlbnRsZXkuY29tL3dzLzIwMTEvMDMvaWRlbnRpdHkvY2xhaW1zIj48c2FtbDpBdHRyaWJ1dGVWYWx1ZT5KYXNvbi5XaWNoZXJ0QGJlbnRsZXkuY29tPC9zYW1sOkF0dHJpYnV0ZVZhbHVlPjwvc2FtbDpBdHRyaWJ1dGU+PHNhbWw6QXR0cmlidXRlIEF0dHJpYnV0ZU5hbWU9InVzZXJpZCIgQXR0cmlidXRlTmFtZXNwYWNlPSJodHRwOi8vc2NoZW1hcy5iZW50bGV5LmNvbS93cy8yMDExLzAzL2lkZW50aXR5L2NsYWltcyI+PHNhbWw6QXR0cmlidXRlVmFsdWU+YmU3YjlmNGYtNWIxZS00YWY4LWJiMDUtNmUwNjBhNmE0OGRiPC9zYW1sOkF0dHJpYnV0ZVZhbHVlPjwvc2FtbDpBdHRyaWJ1dGU+PHNhbWw6QXR0cmlidXRlIEF0dHJpYnV0ZU5hbWU9Im9yZ2FuaXphdGlvbiIgQXR0cmlidXRlTmFtZXNwYWNlPSJodHRwOi8vc2NoZW1hcy5iZW50bGV5LmNvbS93cy8yMDExLzAzL2lkZW50aXR5L2NsYWltcyI+PHNhbWw6QXR0cmlidXRlVmFsdWU+QmVudGxleSBTeXN0ZW1zIEluYzwvc2FtbDpBdHRyaWJ1dGVWYWx1ZT48L3NhbWw6QXR0cmlidXRlPjxzYW1sOkF0dHJpYnV0ZSBBdHRyaWJ1dGVOYW1lPSJoYXNfc2VsZWN0IiBBdHRyaWJ1dGVOYW1lc3BhY2U9Imh0dHA6Ly9zY2hlbWFzLmJlbnRsZXkuY29tL3dzLzIwMTEvMDMvaWRlbnRpdHkvY2xhaW1zIj48c2FtbDpBdHRyaWJ1dGVWYWx1ZT50cnVlPC9zYW1sOkF0dHJpYnV0ZVZhbHVlPjwvc2FtbDpBdHRyaWJ1dGU+PHNhbWw6QXR0cmlidXRlIEF0dHJpYnV0ZU5hbWU9Im9yZ2FuaXphdGlvbmlkIiBBdHRyaWJ1dGVOYW1lc3BhY2U9Imh0dHA6Ly9zY2hlbWFzLmJlbnRsZXkuY29tL3dzLzIwMTEvMDMvaWRlbnRpdHkvY2xhaW1zIj48c2FtbDpBdHRyaWJ1dGVWYWx1ZT5lODJhNTg0Yi05ZmFlLTQwOWYtOTU4MS1mZDE1NGY3YjllZjk8L3NhbWw6QXR0cmlidXRlVmFsdWU+PC9zYW1sOkF0dHJpYnV0ZT48c2FtbDpBdHRyaWJ1dGUgQXR0cmlidXRlTmFtZT0idWx0aW1hdGVpZCIgQXR0cmlidXRlTmFtZXNwYWNlPSJodHRwOi8vc2NoZW1hcy5iZW50bGV5LmNvbS93cy8yMDExLzAzL2lkZW50aXR5L2NsYWltcyI+PHNhbWw6QXR0cmlidXRlVmFsdWU+NzJhZGFkMzAtYzA3Yy00NjVkLWExZmUtMmYyZGZhYzk1MGE0PC9zYW1sOkF0dHJpYnV0ZVZhbHVlPjwvc2FtbDpBdHRyaWJ1dGU+PHNhbWw6QXR0cmlidXRlIEF0dHJpYnV0ZU5hbWU9InVsdGltYXRlcmVmZXJlbmNlaWQiIEF0dHJpYnV0ZU5hbWVzcGFjZT0iaHR0cDovL3NjaGVtYXMuYmVudGxleS5jb20vd3MvMjAxMS8wMy9pZGVudGl0eS9jbGFpbXMiPjxzYW1sOkF0dHJpYnV0ZVZhbHVlPjcyYWRhZDMwLWMwN2MtNDY1ZC1hMWZlLTJmMmRmYWM5NTBhNDwvc2FtbDpBdHRyaWJ1dGVWYWx1ZT48L3NhbWw6QXR0cmlidXRlPjxzYW1sOkF0dHJpYnV0ZSBBdHRyaWJ1dGVOYW1lPSJ1c2FnZWNvdW50cnlpc28iIEF0dHJpYnV0ZU5hbWVzcGFjZT0iaHR0cDovL3NjaGVtYXMuYmVudGxleS5jb20vd3MvMjAxMS8wMy9pZGVudGl0eS9jbGFpbXMiPjxzYW1sOkF0dHJpYnV0ZVZhbHVlPlVTPC9zYW1sOkF0dHJpYnV0ZVZhbHVlPjwvc2FtbDpBdHRyaWJ1dGU+PHNhbWw6QXR0cmlidXRlIEF0dHJpYnV0ZU5hbWU9ImFjdG9yIiBBdHRyaWJ1dGVOYW1lc3BhY2U9Imh0dHA6Ly9zY2hlbWFzLnhtbHNvYXAub3JnL3dzLzIwMDkvMDkvaWRlbnRpdHkvY2xhaW1zIj48c2FtbDpBdHRyaWJ1dGVWYWx1ZT4mbHQ7QWN0b3ImZ3Q7Jmx0O3NhbWw6QXR0cmlidXRlIEF0dHJpYnV0ZU5hbWU9Im5hbWUiIEF0dHJpYnV0ZU5hbWVzcGFjZT0iaHR0cDovL3NjaGVtYXMueG1sc29hcC5vcmcvd3MvMjAwNS8wNS9pZGVudGl0eS9jbGFpbXMiIGE6T3JpZ2luYWxJc3N1ZXI9Imh0dHBzOi8vcWEtaW1zLmJlbnRsZXkuY29tLyIgeG1sbnM6c2FtbD0idXJuOm9hc2lzOm5hbWVzOnRjOlNBTUw6MS4wOmFzc2VydGlvbiIgeG1sbnM6YT0iaHR0cDovL3NjaGVtYXMueG1sc29hcC5vcmcvd3MvMjAwOS8wOS9pZGVudGl0eS9jbGFpbXMiJmd0OyZsdDtzYW1sOkF0dHJpYnV0ZVZhbHVlJmd0O0NOPWltcy10b2tlbi1zaWduaW5nLmJlbnRsZXkuY29tLCBPVT1JVCwgTz1CZW50bGV5IFN5c3RlbXMgSW5jLCBMPUV4dG9uLCBTPVBBLCBDPVVTJmx0Oy9zYW1sOkF0dHJpYnV0ZVZhbHVlJmd0OyZsdDsvc2FtbDpBdHRyaWJ1dGUmZ3Q7Jmx0O3NhbWw6QXR0cmlidXRlIEF0dHJpYnV0ZU5hbWU9ImF1dGhlbnRpY2F0aW9uaWQiIEF0dHJpYnV0ZU5hbWVzcGFjZT0iaHR0cDovL3NjaGVtYXMuYmVudGxleS5jb20vd3MvMjAxMS8wMy9pZGVudGl0eS9jbGFpbXMiIGE6T3JpZ2luYWxJc3N1ZXI9Imh0dHBzOi8vcWEtaW1zLmJlbnRsZXkuY29tLyIgeG1sbnM6c2FtbD0idXJuOm9hc2lzOm5hbWVzOnRjOlNBTUw6MS4wOmFzc2VydGlvbiIgeG1sbnM6YT0iaHR0cDovL3NjaGVtYXMueG1sc29hcC5vcmcvd3MvMjAwOS8wOS9pZGVudGl0eS9jbGFpbXMiJmd0OyZsdDtzYW1sOkF0dHJpYnV0ZVZhbHVlJmd0Ozk5Njk2NTBiLWUzZGItNDVlNC05NmEwLTRmZTdmMjEyZmE3NiZsdDsvc2FtbDpBdHRyaWJ1dGVWYWx1ZSZndDsmbHQ7L3NhbWw6QXR0cmlidXRlJmd0OyZsdDsvQWN0b3ImZ3Q7PC9zYW1sOkF0dHJpYnV0ZVZhbHVlPjwvc2FtbDpBdHRyaWJ1dGU+PC9zYW1sOkF0dHJpYnV0ZVN0YXRlbWVudD48ZHM6U2lnbmF0dXJlIHhtbG5zOmRzPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwLzA5L3htbGRzaWcjIj48ZHM6U2lnbmVkSW5mbz48ZHM6Q2Fub25pY2FsaXphdGlvbk1ldGhvZCBBbGdvcml0aG09Imh0dHA6Ly93d3cudzMub3JnLzIwMDEvMTAveG1sLWV4Yy1jMTRuIyIgLz48ZHM6U2lnbmF0dXJlTWV0aG9kIEFsZ29yaXRobT0iaHR0cDovL3d3dy53My5vcmcvMjAwMS8wNC94bWxkc2lnLW1vcmUjcnNhLXNoYTI1NiIgLz48ZHM6UmVmZXJlbmNlIFVSST0iI19hNmFhZTMxNi0wYzNjLTQzZDItODk3Ni1hMjBmYWMxZmFlZGUiPjxkczpUcmFuc2Zvcm1zPjxkczpUcmFuc2Zvcm0gQWxnb3JpdGhtPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwLzA5L3htbGRzaWcjZW52ZWxvcGVkLXNpZ25hdHVyZSIgLz48ZHM6VHJhbnNmb3JtIEFsZ29yaXRobT0iaHR0cDovL3d3dy53My5vcmcvMjAwMS8xMC94bWwtZXhjLWMxNG4jIiAvPjwvZHM6VHJhbnNmb3Jtcz48ZHM6RGlnZXN0TWV0aG9kIEFsZ29yaXRobT0iaHR0cDovL3d3dy53My5vcmcvMjAwMS8wNC94bWxlbmMjc2hhMjU2IiAvPjxkczpEaWdlc3RWYWx1ZT5oOUdmNjVYMzFLZ0tjWUs4MkV4d01OUU1QMS9ZcDNrc0VXRm1JUUVKcVNNPTwvZHM6RGlnZXN0VmFsdWU+PC9kczpSZWZlcmVuY2U+PC9kczpTaWduZWRJbmZvPjxkczpTaWduYXR1cmVWYWx1ZT5FNCtiRVhwbExHYTFRVUFTR0F2N1N2ajRuTnh6NUhRRkhhTVlzUjB1ZjFoRUkzNkd2VDQvVktCVFkxR0llZzNyU3Rsa2E0ZFBIekZsRG9IQXlYc0xtTjBqWU1NZDlMSUJWTXpUTG11QVNLckpNQ3BURWVQQmQ3TzdMYWNud1VQcEx6NTlxc0ZPOXZqZ09jekpWelpMbCt5MjlaeU8vWVlsYkRqTlgvcWprRDlpS3pTQjhXejI3Q09RWnJFb1dFcG8zVlFUVmMzd2xKeWQ2ZzBBQ1RucGJIazZteXdUL3U5LyswemNlVjN2OVRFMWNTQzJzSUZrdlZFTHJPb0plMzF3UXpvUmRqNU04SCtob1drazh6bjVoTU5ETzJVVkozQzB6K29kVnh3Y3MyeU9KMHAva09OZlBrT3YwekNBZXIrNmo1OThGYU5FckJSQytTTGx0Rk9FK3c9PTwvZHM6U2lnbmF0dXJlVmFsdWU+PEtleUluZm8geG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvMDkveG1sZHNpZyMiPjxYNTA5RGF0YT48WDUwOUNlcnRpZmljYXRlPk1JSUZYakNDQkVhZ0F3SUJBZ0lUWHdBQU1BQW5ab1drT09DZkRnQUFBQUF3QURBTkJna3Foa2lHOXcwQkFRc0ZBREJNTVJNd0VRWUtDWkltaVpQeUxHUUJHUllEWTI5dE1SY3dGUVlLQ1pJbWlaUHlMR1FCR1JZSFltVnVkR3hsZVRFY01Cb0dBMVVFQXhNVFFtVnVkR3hsZVMxSmJuUmxjbTVoYkMxRFFUQWVGdzB4TnpBNE1qZ3hPVFEyTURkYUZ3MHlNakE0TWpjeE9UUTJNRGRhTUgweEN6QUpCZ05WQkFZVEFsVlRNUXN3Q1FZRFZRUUlFd0pRUVRFT01Bd0dBMVVFQnhNRlJYaDBiMjR4SERBYUJnTlZCQW9URTBKbGJuUnNaWGtnVTNsemRHVnRjeUJKYm1NeEN6QUpCZ05WQkFzVEFrbFVNU1l3SkFZRFZRUURFeDFwYlhNdGRHOXJaVzR0YzJsbmJtbHVaeTVpWlc1MGJHVjVMbU52YlRDQ0FTSXdEUVlKS29aSWh2Y05BUUVCQlFBRGdnRVBBRENDQVFvQ2dnRUJBTG5wWGFQVWpXZXZHeG5Ja1k5YkpzZGF0SW5JYm8yU3RTM3hBbVZYM2RkOXVHVUZ1N0hMNGNpSk1PbEhGbHdzQVNPR3JlTUdkSFZRbVBuRmdMMlc1ZWtnaHpzL1ZrL2FzWFNZeld0VndRZnRTMlZaWnFUY3VMcndhWU5Qem52NnZhTlBOVFRiVUk0a1hnQkNIMFMrcEEvdWxocUYwM2RDb3BSQ0I0QlIwei85cjFXcmt4WXpVRjJmS2hLaWZveUJhWDhUcXFFbnc2WktBeUNNRFZSTi9EbTdPUlZFRHcvL2lNTzB2dFhYakZQSDNLVjJFWm4wMitLNXBkcVdwa1Z6ZjlUU0NmRVFaTDJKb1lBZkNWQzZaNWdoNURqYStVVElmakp3NDVsVHk0VFBEK2l2VnBQY25pNldpbG42aTcwMU9DWVhNSzFXeGh3VTF2VitlZWFRdkRVQ0F3RUFBYU9DQWdZd2dnSUNNQXNHQTFVZER3UUVBd0lGb0RBZEJnTlZIUTRFRmdRVWFkdkhTZ0cyc3lodSsrdC9PbmtwT2F3cWhPUXdLQVlEVlIwUkJDRXdINElkYVcxekxYUnZhMlZ1TFhOcFoyNXBibWN1WW1WdWRHeGxlUzVqYjIwd0h3WURWUjBqQkJnd0ZvQVViamRzTlF4Sjd0SW5EMVJTMzlKOXg0Ly9adDB3VVFZRFZSMGZCRW93U0RCR29FU2dRb1pBYUhSMGNEb3ZMMlY0ZEhCeVpHTmhNREV1WW1WdWRHeGxlUzVqYjIwdlEyVnlkRVZ1Y205c2JDOUNaVzUwYkdWNUxVbHVkR1Z5Ym1Gc0xVTkJMbU55YkRDQnhRWUlLd1lCQlFVSEFRRUVnYmd3Z2JVd2diSUdDQ3NHQVFVRkJ6QUNob0dsYkdSaGNEb3ZMeTlEVGoxQ1pXNTBiR1Y1TFVsdWRHVnlibUZzTFVOQkxFTk9QVUZKUVN4RFRqMVFkV0pzYVdNbE1qQkxaWGtsTWpCVFpYSjJhV05sY3l4RFRqMVRaWEoyYVdObGN5eERUajFEYjI1bWFXZDFjbUYwYVc5dUxFUkRQV0p6YVhKdmIzUXNSRU05WTI5dFAyTkJRMlZ5ZEdsbWFXTmhkR1UvWW1GelpUOXZZbXBsWTNSRGJHRnpjejFqWlhKMGFXWnBZMkYwYVc5dVFYVjBhRzl5YVhSNU1Ed0dDU3NHQVFRQmdqY1ZCd1F2TUMwR0pTc0dBUVFCZ2pjVkNJWEhyRURmK1V1RHNaY2VnZXFWUW9leCtGd3hnWU9GS29HazBFZ0NBV1FDQVFZd0V3WURWUjBsQkF3d0NnWUlLd1lCQlFVSEF3RXdHd1lKS3dZQkJBR0NOeFVLQkE0d0REQUtCZ2dyQmdFRkJRY0RBVEFOQmdrcWhraUc5dzBCQVFzRkFBT0NBUUVBVnlFTTFZYmNRYnR4WHB0OXFoZVo0VklEYUNLbWh5ZjFQeXlxUlFxcXpaRjlLS3BiRW5WL1hSZjBxU1FOR080Q1U2SHdPcDV6cE9wQ0RYM3BLT0pZUDNOUkw2T2t2VTAxamlEZzZkOXY5RXlUZDZzcVZiRVVKN3BLa3ptR1drRUwxVVJYUEFaWTZUaUhTaHBNZGtDNStCR0xPU0lYWWNiZHAyYU1HUk1UNVk2ZSt2V2dndnk0QlVDMUNlZDltVUxBS01TSVFlRUg3NnRMWUt5TFE0NGZ0cWFZZXArcGlHRWR0RXphaDhTOWJzUzlkY2JpSW0reWVYaUNneU5Hdm1WMVN0ZWFLTG4rbzJyL2JVM0JBempBM3NsS0x6Wkc1dTI5NVNlUmg2K3hSeGJtNHRPQXEvczAydU43SnhuMjJHd1h2L2wrUlJocEs0Um1nUFZueWdtYlVBPT08L1g1MDlDZXJ0aWZpY2F0ZT48L1g1MDlEYXRhPjwvS2V5SW5mbz48L2RzOlNpZ25hdHVyZT48L3NhbWw6QXNzZXJ0aW9uPg==";

    EXPECT_NE(static_cast<int>(client->TrackUsage(saml, version, projectId, AuthType::SAML, -1, "", UsageType::Production, "").get()), static_cast<int>(BentleyStatus::ERROR));
    }

TEST_F(SaasClientIntegrationTests, DISABLED_FactoryMarkFeatureSaml_Success)
    {
    auto client = CreateTestSaasClient(std::atoi(TEST_PRODUCT_ID));

    // TODO: sign-in and get a saml token

    // need to update this to have a valid saml token
    Utf8String token = "PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0idXRmLTE2Ij8+PHNhbWw6QXNzZXJ0aW9uIE1ham9yVmVyc2lvbj0iMSIgTWlub3JWZXJzaW9uPSIxIiBBc3NlcnRpb25JRD0iX2E2YWFlMzE2LTBjM2MtNDNkMi04OTc2LWEyMGZhYzFmYWVkZSIgSXNzdWVyPSJodHRwczovL3FhLWltcy5iZW50bGV5LmNvbS8iIElzc3VlSW5zdGFudD0iMjAxOS0wNi0yMVQxNTo0MDo0OC42NzBaIiB4bWxuczpzYW1sPSJ1cm46b2FzaXM6bmFtZXM6dGM6U0FNTDoxLjA6YXNzZXJ0aW9uIj48c2FtbDpDb25kaXRpb25zIE5vdEJlZm9yZT0iMjAxOS0wNi0yMVQxNTo0MDo0OC42NTRaIiBOb3RPbk9yQWZ0ZXI9IjIwMTktMDYtMjhUMTU6NDA6NDguNjU0WiI+PHNhbWw6QXVkaWVuY2VSZXN0cmljdGlvbkNvbmRpdGlvbj48c2FtbDpBdWRpZW5jZT5odHRwczovL2Rldi1jb25uZWN0LXVsYXN0bS5iZW50bGV5LmNvbS88L3NhbWw6QXVkaWVuY2U+PC9zYW1sOkF1ZGllbmNlUmVzdHJpY3Rpb25Db25kaXRpb24+PC9zYW1sOkNvbmRpdGlvbnM+PHNhbWw6QXR0cmlidXRlU3RhdGVtZW50PjxzYW1sOlN1YmplY3Q+PHNhbWw6TmFtZUlkZW50aWZpZXI+YmU3YjlmNGYtNWIxZS00YWY4LWJiMDUtNmUwNjBhNmE0OGRiPC9zYW1sOk5hbWVJZGVudGlmaWVyPjxzYW1sOlN1YmplY3RDb25maXJtYXRpb24+PHNhbWw6Q29uZmlybWF0aW9uTWV0aG9kPnVybjpvYXNpczpuYW1lczp0YzpTQU1MOjEuMDpjbTpob2xkZXItb2Yta2V5PC9zYW1sOkNvbmZpcm1hdGlvbk1ldGhvZD48S2V5SW5mbyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC8wOS94bWxkc2lnIyI+PHRydXN0OkJpbmFyeVNlY3JldCB4bWxuczp0cnVzdD0iaHR0cDovL2RvY3Mub2FzaXMtb3Blbi5vcmcvd3Mtc3gvd3MtdHJ1c3QvMjAwNTEyIj5TOWhwYnRMbk5Tb2dNSVIyM2xxTmdqb1JtcnF3YVZudk5jak1WNTgyMURFPTwvdHJ1c3Q6QmluYXJ5U2VjcmV0PjwvS2V5SW5mbz48L3NhbWw6U3ViamVjdENvbmZpcm1hdGlvbj48L3NhbWw6U3ViamVjdD48c2FtbDpBdHRyaWJ1dGUgQXR0cmlidXRlTmFtZT0ibmFtZSIgQXR0cmlidXRlTmFtZXNwYWNlPSJodHRwOi8vc2NoZW1hcy54bWxzb2FwLm9yZy93cy8yMDA1LzA1L2lkZW50aXR5L2NsYWltcyI+PHNhbWw6QXR0cmlidXRlVmFsdWU+amFzb24ud2ljaGVydEBiZW50bGV5LmNvbTwvc2FtbDpBdHRyaWJ1dGVWYWx1ZT48L3NhbWw6QXR0cmlidXRlPjxzYW1sOkF0dHJpYnV0ZSBBdHRyaWJ1dGVOYW1lPSJnaXZlbm5hbWUiIEF0dHJpYnV0ZU5hbWVzcGFjZT0iaHR0cDovL3NjaGVtYXMueG1sc29hcC5vcmcvd3MvMjAwNS8wNS9pZGVudGl0eS9jbGFpbXMiPjxzYW1sOkF0dHJpYnV0ZVZhbHVlPkphc29uPC9zYW1sOkF0dHJpYnV0ZVZhbHVlPjwvc2FtbDpBdHRyaWJ1dGU+PHNhbWw6QXR0cmlidXRlIEF0dHJpYnV0ZU5hbWU9InN1cm5hbWUiIEF0dHJpYnV0ZU5hbWVzcGFjZT0iaHR0cDovL3NjaGVtYXMueG1sc29hcC5vcmcvd3MvMjAwNS8wNS9pZGVudGl0eS9jbGFpbXMiPjxzYW1sOkF0dHJpYnV0ZVZhbHVlPldpY2hlcnQ8L3NhbWw6QXR0cmlidXRlVmFsdWU+PC9zYW1sOkF0dHJpYnV0ZT48c2FtbDpBdHRyaWJ1dGUgQXR0cmlidXRlTmFtZT0iZW1haWxhZGRyZXNzIiBBdHRyaWJ1dGVOYW1lc3BhY2U9Imh0dHA6Ly9zY2hlbWFzLnhtbHNvYXAub3JnL3dzLzIwMDUvMDUvaWRlbnRpdHkvY2xhaW1zIj48c2FtbDpBdHRyaWJ1dGVWYWx1ZT5KYXNvbi5XaWNoZXJ0QGJlbnRsZXkuY29tPC9zYW1sOkF0dHJpYnV0ZVZhbHVlPjwvc2FtbDpBdHRyaWJ1dGU+PHNhbWw6QXR0cmlidXRlIEF0dHJpYnV0ZU5hbWU9InJvbGUiIEF0dHJpYnV0ZU5hbWVzcGFjZT0iaHR0cDovL3NjaGVtYXMubWljcm9zb2Z0LmNvbS93cy8yMDA4LzA2L2lkZW50aXR5L2NsYWltcyI+PHNhbWw6QXR0cmlidXRlVmFsdWU+UHJvamVjdCBNYW5hZ2VyPC9zYW1sOkF0dHJpYnV0ZVZhbHVlPjxzYW1sOkF0dHJpYnV0ZVZhbHVlPkJFTlRMRVlfRU1QTE9ZRUU8L3NhbWw6QXR0cmlidXRlVmFsdWU+PHNhbWw6QXR0cmlidXRlVmFsdWU+U0lURV9BRE1JTklTVFJBVE9SPC9zYW1sOkF0dHJpYnV0ZVZhbHVlPjwvc2FtbDpBdHRyaWJ1dGU+PHNhbWw6QXR0cmlidXRlIEF0dHJpYnV0ZU5hbWU9InVsdGltYXRlc2l0ZSIgQXR0cmlidXRlTmFtZXNwYWNlPSJodHRwOi8vc2NoZW1hcy5iZW50bGV5LmNvbS93cy8yMDExLzAzL2lkZW50aXR5L2NsYWltcyI+PHNhbWw6QXR0cmlidXRlVmFsdWU+MTAwMTM4OTExNzwvc2FtbDpBdHRyaWJ1dGVWYWx1ZT48L3NhbWw6QXR0cmlidXRlPjxzYW1sOkF0dHJpYnV0ZSBBdHRyaWJ1dGVOYW1lPSJzYXBlbnRpdGxlbWVudCIgQXR0cmlidXRlTmFtZXNwYWNlPSJodHRwOi8vc2NoZW1hcy5iZW50bGV5LmNvbS93cy8yMDExLzAzL2lkZW50aXR5L2NsYWltcyI+PHNhbWw6QXR0cmlidXRlVmFsdWU+SU5URVJOQUw8L3NhbWw6QXR0cmlidXRlVmFsdWU+PHNhbWw6QXR0cmlidXRlVmFsdWU+QkVOVExFWV9MRUFSTjwvc2FtbDpBdHRyaWJ1dGVWYWx1ZT48c2FtbDpBdHRyaWJ1dGVWYWx1ZT5TRUxFQ1RfMjAwNjwvc2FtbDpBdHRyaWJ1dGVWYWx1ZT48L3NhbWw6QXR0cmlidXRlPjxzYW1sOkF0dHJpYnV0ZSBBdHRyaWJ1dGVOYW1lPSJlbnRpdGxlbWVudCIgQXR0cmlidXRlTmFtZXNwYWNlPSJodHRwOi8vc2NoZW1hcy5iZW50bGV5LmNvbS93cy8yMDExLzAzL2lkZW50aXR5L2NsYWltcyI+PHNhbWw6QXR0cmlidXRlVmFsdWU+QkVOVExFWV9FTVBMT1lFRTwvc2FtbDpBdHRyaWJ1dGVWYWx1ZT48c2FtbDpBdHRyaWJ1dGVWYWx1ZT5CRU5UTEVZX0xFQVJOPC9zYW1sOkF0dHJpYnV0ZVZhbHVlPjxzYW1sOkF0dHJpYnV0ZVZhbHVlPlNFTEVDVF8yMDA2PC9zYW1sOkF0dHJpYnV0ZVZhbHVlPjwvc2FtbDpBdHRyaWJ1dGU+PHNhbWw6QXR0cmlidXRlIEF0dHJpYnV0ZU5hbWU9ImNvdW50cnlpc28iIEF0dHJpYnV0ZU5hbWVzcGFjZT0iaHR0cDovL3NjaGVtYXMuYmVudGxleS5jb20vd3MvMjAxMS8wMy9pZGVudGl0eS9jbGFpbXMiPjxzYW1sOkF0dHJpYnV0ZVZhbHVlPlVTPC9zYW1sOkF0dHJpYnV0ZVZhbHVlPjwvc2FtbDpBdHRyaWJ1dGU+PHNhbWw6QXR0cmlidXRlIEF0dHJpYnV0ZU5hbWU9Imxhbmd1YWdlaXNvIiBBdHRyaWJ1dGVOYW1lc3BhY2U9Imh0dHA6Ly9zY2hlbWFzLmJlbnRsZXkuY29tL3dzLzIwMTEvMDMvaWRlbnRpdHkvY2xhaW1zIj48c2FtbDpBdHRyaWJ1dGVWYWx1ZT5FTjwvc2FtbDpBdHRyaWJ1dGVWYWx1ZT48L3NhbWw6QXR0cmlidXRlPjxzYW1sOkF0dHJpYnV0ZSBBdHRyaWJ1dGVOYW1lPSJpc21hcmtldGluZ3Byb3NwZWN0IiBBdHRyaWJ1dGVOYW1lc3BhY2U9Imh0dHA6Ly9zY2hlbWFzLmJlbnRsZXkuY29tL3dzLzIwMTEvMDMvaWRlbnRpdHkvY2xhaW1zIj48c2FtbDpBdHRyaWJ1dGVWYWx1ZT5mYWxzZTwvc2FtbDpBdHRyaWJ1dGVWYWx1ZT48L3NhbWw6QXR0cmlidXRlPjxzYW1sOkF0dHJpYnV0ZSBBdHRyaWJ1dGVOYW1lPSJpc2JlbnRsZXllbXBsb3llZSIgQXR0cmlidXRlTmFtZXNwYWNlPSJodHRwOi8vc2NoZW1hcy5iZW50bGV5LmNvbS93cy8yMDExLzAzL2lkZW50aXR5L2NsYWltcyI+PHNhbWw6QXR0cmlidXRlVmFsdWU+dHJ1ZTwvc2FtbDpBdHRyaWJ1dGVWYWx1ZT48L3NhbWw6QXR0cmlidXRlPjxzYW1sOkF0dHJpYnV0ZSBBdHRyaWJ1dGVOYW1lPSJiZWNvbW11bml0aWVzdXNlcm5hbWUiIEF0dHJpYnV0ZU5hbWVzcGFjZT0iaHR0cDovL3NjaGVtYXMuYmVudGxleS5jb20vd3MvMjAxMS8wMy9pZGVudGl0eS9jbGFpbXMiPjxzYW1sOkF0dHJpYnV0ZVZhbHVlPkJFN0I5RjRGLTVCMUUtNEFGOC1CQjA1LTZFMDYwQTZBNDhEQjwvc2FtbDpBdHRyaWJ1dGVWYWx1ZT48L3NhbWw6QXR0cmlidXRlPjxzYW1sOkF0dHJpYnV0ZSBBdHRyaWJ1dGVOYW1lPSJiZWNvbW11bml0aWVzZW1haWxhZGRyZXNzIiBBdHRyaWJ1dGVOYW1lc3BhY2U9Imh0dHA6Ly9zY2hlbWFzLmJlbnRsZXkuY29tL3dzLzIwMTEvMDMvaWRlbnRpdHkvY2xhaW1zIj48c2FtbDpBdHRyaWJ1dGVWYWx1ZT5KYXNvbi5XaWNoZXJ0QGJlbnRsZXkuY29tPC9zYW1sOkF0dHJpYnV0ZVZhbHVlPjwvc2FtbDpBdHRyaWJ1dGU+PHNhbWw6QXR0cmlidXRlIEF0dHJpYnV0ZU5hbWU9InVzZXJpZCIgQXR0cmlidXRlTmFtZXNwYWNlPSJodHRwOi8vc2NoZW1hcy5iZW50bGV5LmNvbS93cy8yMDExLzAzL2lkZW50aXR5L2NsYWltcyI+PHNhbWw6QXR0cmlidXRlVmFsdWU+YmU3YjlmNGYtNWIxZS00YWY4LWJiMDUtNmUwNjBhNmE0OGRiPC9zYW1sOkF0dHJpYnV0ZVZhbHVlPjwvc2FtbDpBdHRyaWJ1dGU+PHNhbWw6QXR0cmlidXRlIEF0dHJpYnV0ZU5hbWU9Im9yZ2FuaXphdGlvbiIgQXR0cmlidXRlTmFtZXNwYWNlPSJodHRwOi8vc2NoZW1hcy5iZW50bGV5LmNvbS93cy8yMDExLzAzL2lkZW50aXR5L2NsYWltcyI+PHNhbWw6QXR0cmlidXRlVmFsdWU+QmVudGxleSBTeXN0ZW1zIEluYzwvc2FtbDpBdHRyaWJ1dGVWYWx1ZT48L3NhbWw6QXR0cmlidXRlPjxzYW1sOkF0dHJpYnV0ZSBBdHRyaWJ1dGVOYW1lPSJoYXNfc2VsZWN0IiBBdHRyaWJ1dGVOYW1lc3BhY2U9Imh0dHA6Ly9zY2hlbWFzLmJlbnRsZXkuY29tL3dzLzIwMTEvMDMvaWRlbnRpdHkvY2xhaW1zIj48c2FtbDpBdHRyaWJ1dGVWYWx1ZT50cnVlPC9zYW1sOkF0dHJpYnV0ZVZhbHVlPjwvc2FtbDpBdHRyaWJ1dGU+PHNhbWw6QXR0cmlidXRlIEF0dHJpYnV0ZU5hbWU9Im9yZ2FuaXphdGlvbmlkIiBBdHRyaWJ1dGVOYW1lc3BhY2U9Imh0dHA6Ly9zY2hlbWFzLmJlbnRsZXkuY29tL3dzLzIwMTEvMDMvaWRlbnRpdHkvY2xhaW1zIj48c2FtbDpBdHRyaWJ1dGVWYWx1ZT5lODJhNTg0Yi05ZmFlLTQwOWYtOTU4MS1mZDE1NGY3YjllZjk8L3NhbWw6QXR0cmlidXRlVmFsdWU+PC9zYW1sOkF0dHJpYnV0ZT48c2FtbDpBdHRyaWJ1dGUgQXR0cmlidXRlTmFtZT0idWx0aW1hdGVpZCIgQXR0cmlidXRlTmFtZXNwYWNlPSJodHRwOi8vc2NoZW1hcy5iZW50bGV5LmNvbS93cy8yMDExLzAzL2lkZW50aXR5L2NsYWltcyI+PHNhbWw6QXR0cmlidXRlVmFsdWU+NzJhZGFkMzAtYzA3Yy00NjVkLWExZmUtMmYyZGZhYzk1MGE0PC9zYW1sOkF0dHJpYnV0ZVZhbHVlPjwvc2FtbDpBdHRyaWJ1dGU+PHNhbWw6QXR0cmlidXRlIEF0dHJpYnV0ZU5hbWU9InVsdGltYXRlcmVmZXJlbmNlaWQiIEF0dHJpYnV0ZU5hbWVzcGFjZT0iaHR0cDovL3NjaGVtYXMuYmVudGxleS5jb20vd3MvMjAxMS8wMy9pZGVudGl0eS9jbGFpbXMiPjxzYW1sOkF0dHJpYnV0ZVZhbHVlPjcyYWRhZDMwLWMwN2MtNDY1ZC1hMWZlLTJmMmRmYWM5NTBhNDwvc2FtbDpBdHRyaWJ1dGVWYWx1ZT48L3NhbWw6QXR0cmlidXRlPjxzYW1sOkF0dHJpYnV0ZSBBdHRyaWJ1dGVOYW1lPSJ1c2FnZWNvdW50cnlpc28iIEF0dHJpYnV0ZU5hbWVzcGFjZT0iaHR0cDovL3NjaGVtYXMuYmVudGxleS5jb20vd3MvMjAxMS8wMy9pZGVudGl0eS9jbGFpbXMiPjxzYW1sOkF0dHJpYnV0ZVZhbHVlPlVTPC9zYW1sOkF0dHJpYnV0ZVZhbHVlPjwvc2FtbDpBdHRyaWJ1dGU+PHNhbWw6QXR0cmlidXRlIEF0dHJpYnV0ZU5hbWU9ImFjdG9yIiBBdHRyaWJ1dGVOYW1lc3BhY2U9Imh0dHA6Ly9zY2hlbWFzLnhtbHNvYXAub3JnL3dzLzIwMDkvMDkvaWRlbnRpdHkvY2xhaW1zIj48c2FtbDpBdHRyaWJ1dGVWYWx1ZT4mbHQ7QWN0b3ImZ3Q7Jmx0O3NhbWw6QXR0cmlidXRlIEF0dHJpYnV0ZU5hbWU9Im5hbWUiIEF0dHJpYnV0ZU5hbWVzcGFjZT0iaHR0cDovL3NjaGVtYXMueG1sc29hcC5vcmcvd3MvMjAwNS8wNS9pZGVudGl0eS9jbGFpbXMiIGE6T3JpZ2luYWxJc3N1ZXI9Imh0dHBzOi8vcWEtaW1zLmJlbnRsZXkuY29tLyIgeG1sbnM6c2FtbD0idXJuOm9hc2lzOm5hbWVzOnRjOlNBTUw6MS4wOmFzc2VydGlvbiIgeG1sbnM6YT0iaHR0cDovL3NjaGVtYXMueG1sc29hcC5vcmcvd3MvMjAwOS8wOS9pZGVudGl0eS9jbGFpbXMiJmd0OyZsdDtzYW1sOkF0dHJpYnV0ZVZhbHVlJmd0O0NOPWltcy10b2tlbi1zaWduaW5nLmJlbnRsZXkuY29tLCBPVT1JVCwgTz1CZW50bGV5IFN5c3RlbXMgSW5jLCBMPUV4dG9uLCBTPVBBLCBDPVVTJmx0Oy9zYW1sOkF0dHJpYnV0ZVZhbHVlJmd0OyZsdDsvc2FtbDpBdHRyaWJ1dGUmZ3Q7Jmx0O3NhbWw6QXR0cmlidXRlIEF0dHJpYnV0ZU5hbWU9ImF1dGhlbnRpY2F0aW9uaWQiIEF0dHJpYnV0ZU5hbWVzcGFjZT0iaHR0cDovL3NjaGVtYXMuYmVudGxleS5jb20vd3MvMjAxMS8wMy9pZGVudGl0eS9jbGFpbXMiIGE6T3JpZ2luYWxJc3N1ZXI9Imh0dHBzOi8vcWEtaW1zLmJlbnRsZXkuY29tLyIgeG1sbnM6c2FtbD0idXJuOm9hc2lzOm5hbWVzOnRjOlNBTUw6MS4wOmFzc2VydGlvbiIgeG1sbnM6YT0iaHR0cDovL3NjaGVtYXMueG1sc29hcC5vcmcvd3MvMjAwOS8wOS9pZGVudGl0eS9jbGFpbXMiJmd0OyZsdDtzYW1sOkF0dHJpYnV0ZVZhbHVlJmd0Ozk5Njk2NTBiLWUzZGItNDVlNC05NmEwLTRmZTdmMjEyZmE3NiZsdDsvc2FtbDpBdHRyaWJ1dGVWYWx1ZSZndDsmbHQ7L3NhbWw6QXR0cmlidXRlJmd0OyZsdDsvQWN0b3ImZ3Q7PC9zYW1sOkF0dHJpYnV0ZVZhbHVlPjwvc2FtbDpBdHRyaWJ1dGU+PC9zYW1sOkF0dHJpYnV0ZVN0YXRlbWVudD48ZHM6U2lnbmF0dXJlIHhtbG5zOmRzPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwLzA5L3htbGRzaWcjIj48ZHM6U2lnbmVkSW5mbz48ZHM6Q2Fub25pY2FsaXphdGlvbk1ldGhvZCBBbGdvcml0aG09Imh0dHA6Ly93d3cudzMub3JnLzIwMDEvMTAveG1sLWV4Yy1jMTRuIyIgLz48ZHM6U2lnbmF0dXJlTWV0aG9kIEFsZ29yaXRobT0iaHR0cDovL3d3dy53My5vcmcvMjAwMS8wNC94bWxkc2lnLW1vcmUjcnNhLXNoYTI1NiIgLz48ZHM6UmVmZXJlbmNlIFVSST0iI19hNmFhZTMxNi0wYzNjLTQzZDItODk3Ni1hMjBmYWMxZmFlZGUiPjxkczpUcmFuc2Zvcm1zPjxkczpUcmFuc2Zvcm0gQWxnb3JpdGhtPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwLzA5L3htbGRzaWcjZW52ZWxvcGVkLXNpZ25hdHVyZSIgLz48ZHM6VHJhbnNmb3JtIEFsZ29yaXRobT0iaHR0cDovL3d3dy53My5vcmcvMjAwMS8xMC94bWwtZXhjLWMxNG4jIiAvPjwvZHM6VHJhbnNmb3Jtcz48ZHM6RGlnZXN0TWV0aG9kIEFsZ29yaXRobT0iaHR0cDovL3d3dy53My5vcmcvMjAwMS8wNC94bWxlbmMjc2hhMjU2IiAvPjxkczpEaWdlc3RWYWx1ZT5oOUdmNjVYMzFLZ0tjWUs4MkV4d01OUU1QMS9ZcDNrc0VXRm1JUUVKcVNNPTwvZHM6RGlnZXN0VmFsdWU+PC9kczpSZWZlcmVuY2U+PC9kczpTaWduZWRJbmZvPjxkczpTaWduYXR1cmVWYWx1ZT5FNCtiRVhwbExHYTFRVUFTR0F2N1N2ajRuTnh6NUhRRkhhTVlzUjB1ZjFoRUkzNkd2VDQvVktCVFkxR0llZzNyU3Rsa2E0ZFBIekZsRG9IQXlYc0xtTjBqWU1NZDlMSUJWTXpUTG11QVNLckpNQ3BURWVQQmQ3TzdMYWNud1VQcEx6NTlxc0ZPOXZqZ09jekpWelpMbCt5MjlaeU8vWVlsYkRqTlgvcWprRDlpS3pTQjhXejI3Q09RWnJFb1dFcG8zVlFUVmMzd2xKeWQ2ZzBBQ1RucGJIazZteXdUL3U5LyswemNlVjN2OVRFMWNTQzJzSUZrdlZFTHJPb0plMzF3UXpvUmRqNU04SCtob1drazh6bjVoTU5ETzJVVkozQzB6K29kVnh3Y3MyeU9KMHAva09OZlBrT3YwekNBZXIrNmo1OThGYU5FckJSQytTTGx0Rk9FK3c9PTwvZHM6U2lnbmF0dXJlVmFsdWU+PEtleUluZm8geG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvMDkveG1sZHNpZyMiPjxYNTA5RGF0YT48WDUwOUNlcnRpZmljYXRlPk1JSUZYakNDQkVhZ0F3SUJBZ0lUWHdBQU1BQW5ab1drT09DZkRnQUFBQUF3QURBTkJna3Foa2lHOXcwQkFRc0ZBREJNTVJNd0VRWUtDWkltaVpQeUxHUUJHUllEWTI5dE1SY3dGUVlLQ1pJbWlaUHlMR1FCR1JZSFltVnVkR3hsZVRFY01Cb0dBMVVFQXhNVFFtVnVkR3hsZVMxSmJuUmxjbTVoYkMxRFFUQWVGdzB4TnpBNE1qZ3hPVFEyTURkYUZ3MHlNakE0TWpjeE9UUTJNRGRhTUgweEN6QUpCZ05WQkFZVEFsVlRNUXN3Q1FZRFZRUUlFd0pRUVRFT01Bd0dBMVVFQnhNRlJYaDBiMjR4SERBYUJnTlZCQW9URTBKbGJuUnNaWGtnVTNsemRHVnRjeUJKYm1NeEN6QUpCZ05WQkFzVEFrbFVNU1l3SkFZRFZRUURFeDFwYlhNdGRHOXJaVzR0YzJsbmJtbHVaeTVpWlc1MGJHVjVMbU52YlRDQ0FTSXdEUVlKS29aSWh2Y05BUUVCQlFBRGdnRVBBRENDQVFvQ2dnRUJBTG5wWGFQVWpXZXZHeG5Ja1k5YkpzZGF0SW5JYm8yU3RTM3hBbVZYM2RkOXVHVUZ1N0hMNGNpSk1PbEhGbHdzQVNPR3JlTUdkSFZRbVBuRmdMMlc1ZWtnaHpzL1ZrL2FzWFNZeld0VndRZnRTMlZaWnFUY3VMcndhWU5Qem52NnZhTlBOVFRiVUk0a1hnQkNIMFMrcEEvdWxocUYwM2RDb3BSQ0I0QlIwei85cjFXcmt4WXpVRjJmS2hLaWZveUJhWDhUcXFFbnc2WktBeUNNRFZSTi9EbTdPUlZFRHcvL2lNTzB2dFhYakZQSDNLVjJFWm4wMitLNXBkcVdwa1Z6ZjlUU0NmRVFaTDJKb1lBZkNWQzZaNWdoNURqYStVVElmakp3NDVsVHk0VFBEK2l2VnBQY25pNldpbG42aTcwMU9DWVhNSzFXeGh3VTF2VitlZWFRdkRVQ0F3RUFBYU9DQWdZd2dnSUNNQXNHQTFVZER3UUVBd0lGb0RBZEJnTlZIUTRFRmdRVWFkdkhTZ0cyc3lodSsrdC9PbmtwT2F3cWhPUXdLQVlEVlIwUkJDRXdINElkYVcxekxYUnZhMlZ1TFhOcFoyNXBibWN1WW1WdWRHeGxlUzVqYjIwd0h3WURWUjBqQkJnd0ZvQVViamRzTlF4Sjd0SW5EMVJTMzlKOXg0Ly9adDB3VVFZRFZSMGZCRW93U0RCR29FU2dRb1pBYUhSMGNEb3ZMMlY0ZEhCeVpHTmhNREV1WW1WdWRHeGxlUzVqYjIwdlEyVnlkRVZ1Y205c2JDOUNaVzUwYkdWNUxVbHVkR1Z5Ym1Gc0xVTkJMbU55YkRDQnhRWUlLd1lCQlFVSEFRRUVnYmd3Z2JVd2diSUdDQ3NHQVFVRkJ6QUNob0dsYkdSaGNEb3ZMeTlEVGoxQ1pXNTBiR1Y1TFVsdWRHVnlibUZzTFVOQkxFTk9QVUZKUVN4RFRqMVFkV0pzYVdNbE1qQkxaWGtsTWpCVFpYSjJhV05sY3l4RFRqMVRaWEoyYVdObGN5eERUajFEYjI1bWFXZDFjbUYwYVc5dUxFUkRQV0p6YVhKdmIzUXNSRU05WTI5dFAyTkJRMlZ5ZEdsbWFXTmhkR1UvWW1GelpUOXZZbXBsWTNSRGJHRnpjejFqWlhKMGFXWnBZMkYwYVc5dVFYVjBhRzl5YVhSNU1Ed0dDU3NHQVFRQmdqY1ZCd1F2TUMwR0pTc0dBUVFCZ2pjVkNJWEhyRURmK1V1RHNaY2VnZXFWUW9leCtGd3hnWU9GS29HazBFZ0NBV1FDQVFZd0V3WURWUjBsQkF3d0NnWUlLd1lCQlFVSEF3RXdHd1lKS3dZQkJBR0NOeFVLQkE0d0REQUtCZ2dyQmdFRkJRY0RBVEFOQmdrcWhraUc5dzBCQVFzRkFBT0NBUUVBVnlFTTFZYmNRYnR4WHB0OXFoZVo0VklEYUNLbWh5ZjFQeXlxUlFxcXpaRjlLS3BiRW5WL1hSZjBxU1FOR080Q1U2SHdPcDV6cE9wQ0RYM3BLT0pZUDNOUkw2T2t2VTAxamlEZzZkOXY5RXlUZDZzcVZiRVVKN3BLa3ptR1drRUwxVVJYUEFaWTZUaUhTaHBNZGtDNStCR0xPU0lYWWNiZHAyYU1HUk1UNVk2ZSt2V2dndnk0QlVDMUNlZDltVUxBS01TSVFlRUg3NnRMWUt5TFE0NGZ0cWFZZXArcGlHRWR0RXphaDhTOWJzUzlkY2JpSW0reWVYaUNneU5Hdm1WMVN0ZWFLTG4rbzJyL2JVM0JBempBM3NsS0x6Wkc1dTI5NVNlUmg2K3hSeGJtNHRPQXEvczAydU43SnhuMjJHd1h2L2wrUlJocEs0Um1nUFZueWdtYlVBPT08L1g1MDlDZXJ0aWZpY2F0ZT48L1g1MDlEYXRhPjwvS2V5SW5mbz48L2RzOlNpZ25hdHVyZT48L3NhbWw6QXNzZXJ0aW9uPg==";

    auto version = BeVersion(1, 0);
    Utf8String projectId = "00000000-0000-0000-0000-000000000000";
    Utf8String featureId = "e49af0e9-1d2b-4385-b5c5-ce50b07693d3"; // featureID must be a GUID

    FeatureUserDataMapPtr featureData = std::make_shared<FeatureUserDataMap>();

    featureData->AddAttribute("Manufacturer", "Bentley Systems, Inc.");
    featureData->AddAttribute("Website", "https://www.w3schools.com");
    featureData->AddAttribute("Title", "Mobile App");

    FeatureEvent featureEvent = FeatureEvent(featureId, version, projectId, featureData);

    EXPECT_NE(static_cast<int>(client->MarkFeature(token, featureEvent, AuthType::SAML, -1, "", UsageType::Production, "").get()), static_cast<int>(BentleyStatus::ERROR));
    }

// Tests using the Client's implementation
TEST_F(SaasClientIntegrationTests, TrackUsage_Success)
    {
    auto client = CreateTestSaasClientImpl(std::atoi(TEST_PRODUCT_ID));

    auto oidcToken = OIDCNative::IssueToken("qa2_devuser2@mailinator.com", "bentley", UrlProvider::Urls::IMSOpenID.Get().c_str(), OIDC_CLIENT_ID, OIDC_SCOPES);
    LOG.debugv("token issued: %s", Utf8CP(oidcToken));

    auto version = BeVersion(1, 0);
    Utf8String projectId = "00000000-0000-0000-0000-000000000000";

    EXPECT_NE(static_cast<int>(client->TrackUsage(oidcToken, version, projectId, AuthType::OIDC, std::atoi(TEST_PRODUCT_ID), "", UsageType::Production, "").get()), static_cast<int>(BentleyStatus::ERROR));
    }

TEST_F(SaasClientIntegrationTests, MarkFeature_Success)
    {
    auto client = CreateTestSaasClientImpl(std::atoi(TEST_PRODUCT_ID));

    auto oidcToken = OIDCNative::IssueToken("qa2_devuser2@mailinator.com", "bentley", UrlProvider::Urls::IMSOpenID.Get().c_str(), OIDC_CLIENT_ID, OIDC_SCOPES);
    LOG.debugv("token issued: %s", Utf8CP(oidcToken));

    auto version = BeVersion(1, 0);
    Utf8String projectId = "00000000-0000-0000-0000-000000000000";
    Utf8String featureId = "e49af0e9-1d2b-4385-b5c5-ce50b07693d3"; // featureID must be a GUID

    FeatureUserDataMapPtr featureData = std::make_shared<FeatureUserDataMap>();

    featureData->AddAttribute("Manufacturer", "Bentley Systems, Inc.");
    featureData->AddAttribute("Website", "https://www.w3schools.com");
    featureData->AddAttribute("Title", "Mobile App");

    FeatureEvent featureEvent = FeatureEvent(featureId, version, projectId, featureData);

    EXPECT_NE(static_cast<int>(client->MarkFeature(oidcToken, featureEvent, AuthType::OIDC, std::atoi(TEST_PRODUCT_ID), "", UsageType::Production, "").get()), static_cast<int>(BentleyStatus::ERROR));
    }
