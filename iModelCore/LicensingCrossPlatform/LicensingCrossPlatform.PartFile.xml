<?xml version="1.0" encoding="utf-8"?>

<BuildContext xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="../bsicommon/build/PartFile.xsd">

    <Part Name="PublicAPI" BentleyBuildMakeFile="DeliverPublicAPI.mke">
        <Bindings>
            <PublicAPI Domain="Licensing"/>
        </Bindings>
    </Part>

    <Part Name="LicensingNativeLib" BentleyBuildMakeFile="Licensing.mke" ApiNumber="M02">
        <SubPart PartName="WebServicesClient" PartFile="iModelCore/WSClient/WSClient" Repository="imodel02" />
        <SubPart PartName="BeSQLite" PartFile="iModelCore/BeSQLite/BeSQLite" Repository="imodel02" /> 
        <SubPart PartName="PublicAPI"/>
        <SubPart PartName="BeSecurity" PartFile="iModelCore/BeSecurity/BeSecurity" Repository="imodel02"/>
        <!--<SubPart PartName="NativeClient.Docs"/>-->

        <Bindings>
            <Libs>Delivery/$(libprefix)Licensing$(libext)</Libs>
            <Assemblies>Delivery/$(shlibprefix)Licensing$(ApiNumber)$(shlibext)</Assemblies>
        </Bindings>
    </Part>

    <Part Name="Licensing" OnlyPlatforms="x64,Linux*,MacOS*,iOSARM64,AndroidARM64">
        <SubPart PartName="LicensingNativeLib" />
    </Part>

    <!-- ******************************** Unit Tests ************************************** -->
    <Part Name="PrewireForUnitTests" DeferType="BuildUnitTests" BentleyBuildMakeFile="Tests/UnitTests/Prewire.mke">
        <Bindings>
            <Files ProductDirectoryName="UnitTests-IgnoreList" ProductSubDirectory="Licensing" SubPartDirectory="UnitTests/Licensing">Delivery/UnitTests/ignore_list.txt</Files>
        </Bindings>
    </Part>

    <Part Name="UnitTests" DeferType="BuildUnitTests" BentleyBuildMakeFile="Tests/UnitTests/BuildTests.mke" BentleyBuildMakeOptions="-dTestDir=NonPublished">
        <SubPart PartName="PrewireForUnitTests" />
        <SubPart PartName="Licensing" />

        <Bindings>
            <Directory ProductDirectoryName="UnitTests-Objects" ProductSubDirectory="Licensing/NonPublished" SourceName="Delivery/UnitTests/Objects/NonPublished"/>
        </Bindings>
    </Part>

    <Product Name="Licensing-UnitTests">
        <!-- just to ensure that integration tests build, can run manually as desired -->
        <SubProduct ProductName="Licensing-GtestIntegration"/>
        <SubPart Repository="imodel02" PartFile="iModelCore/BeGTest/BeGTest" PartName="Base" />
        <SubPart PartName="UnitTests"/>
        <Directories DirectoryListName="CollectionProduct" Repository="imodel02" PartFile="iModelCore/BeGTest/BeGTest"/>
    </Product>

    <Part Name="GtestUnit" DeferType="BuildUnitTests" BentleyBuildMakeFile="$(BuildContext)/SubParts/BeGTest/gtest/buildGtest.mke" BentleyBuildMakeOptions="-dTEST_NAME=LicensingUnitTest -dTEST_COLLECTION_PRODUCT=Licensing-UnitTests" OnlyPlatforms="x86,x64,Linux*,MacOS*">
        <SubProduct ProductName="Licensing-UnitTests"/>
        <SubPart PartName="Gtest-Tools" Repository="imodel02" PartFile="iModelCore/BeGTest/BeGTest"/>

        <Bindings>
            <Files ProductDirectoryName="Gtest-NativeAssemblies">Delivery/Gtest/LicensingUnitTest/Assemblies/*</Files>
            <Directory ProductDirectoryName="Gtest-Assets" SourceName="Delivery/Gtest/LicensingUnitTest/Assets" />
        </Bindings>
    </Part>

    <Part Name="RunGtestUnit" DeferType="RunUnitTests" BentleyBuildMakeFile="$(BuildContext)/SubParts/BeGTest/gtest/RunGtest.mke" BentleyBuildMakeOptions="-dGTEST_PRODUCT=Licensing-GtestUnit -dGTEST_NAME=LicensingUnitTest" OnlyPlatforms="x64,Linux*, MacOS*">
        <SubProduct ProductName="Licensing-GtestUnit" />
        <SubPart PartName="Gtest-Tools" Repository="imodel02" PartFile="iModelCore/BeGTest/BeGTest"/>

        <Bindings>
          <Files Required="false" SubPartDirectory="Gtest/Logs">Delivery/Gtest/Logs/LicensingUnitTest.log</Files>
        </Bindings>
    </Part>

    <Product Name="Licensing-GtestUnit" >
        <SubPart PartName="GtestUnit"/>
        <Directories DirectoryListName="GtestProduct" Repository="imodel02" PartFile="iModelCore/BeGTest/BeGTest"/>
    </Product>

    <!--<Part Name="NativeClient.Docs" BMakeFile="Licensing/docs.mke" OnlyPlatforms="x64">
        <RequiredRepository>bsitools-doxygen</RequiredRepository>
        <Bindings>
             The Files portion below should be commented out if part in use
             <Files ProductDirectoryName="LicenseClientCrossPlatform" IfNotPresent="Warn" Required="false">
                Delivery/NativeClient.chm
            </Files>
        </Bindings>
    </Part>-->

    <!-- ********************** -->
    <!-- **** AndroidJUnit **** -->
    <!-- ********************** -->
    <Part Name="AndroidJUnit" DeferType="BuildUnitTests" BentleyBuildMakeFile="$(BuildContext)/SubParts/BeGTest/Android//MakeJUnitTestProject.mke" BentleyBuildMakeOptions="-dTEST_NAME=LicensingUnitTest -dTEST_COLLECTION_PRODUCT=Licensing-UnitTests -dUSE_STATIC_LIBRARIES=1 -dTEST_ANDROID_MIN_SDK_VERSION=19" OnlyPlatforms="Android*">
        <SubProduct ProductName="Licensing-UnitTests"/>
        <SubPart PartName="AndroidJUnitTest-Tools" Repository="imodel02" PartFile="iModelCore/BeGTest/BeGTest"/>
        <Bindings>
            <Directory ProductDirectoryName="AndroidJUnit-Project" SourceName="Delivery/ANJUP" />
        </Bindings>
    </Part>

    <Product Name="Licensing-AndroidJUnit" >
        <SubPart PartName="AndroidJUnit" LibType="Static"/>
        <Directories DirectoryListName="AndroidJUnitProduct" Repository="imodel02" PartFile="iModelCore/BeGTest/BeGTest"/>
    </Product>

    <Part Name="RunAndroidJUnitTest" DeferType="RunUnitTests" BentleyBuildMakeFile="$(BuildContext)/SubParts/BeGTest/Android//RunAndroidJUnitTest.mke" BentleyBuildMakeOptions="-dANDROIDJUNIT_PRODUCT=Licensing-AndroidJUnit" OnlyPlatforms="Android*">
        <SubProduct ProductName="Licensing-AndroidJUnit"/>
        <Bindings>
            <Files SubPartDirectory="ANJU/Logs">Delivery/ANJU/Logs/Licensing-AndroidJUnit.log</Files>
        </Bindings>
    </Part>

    <!-- ********************** -->
    <!-- **** iOSXCTest **** -->
    <!-- ********************** -->
    <Part Name="iOSXCTest" DeferType="BuildUnitTests" BentleyBuildMakeFile="$(BuildContext)/SubParts/BeGTest/iOS//MakeXCTestProject.mke" BentleyBuildMakeOptions="-dTEST_NAME=LicensingUnitTest -dTEST_COLLECTION_PRODUCT=Licensing-UnitTests -dUSE_STATIC_LIBRARIES=1" OnlyPlatforms="iOS*">
        <SubProduct ProductName="Licensing-UnitTests"/>
        <SubPart PartName="iOSXCTest-Tools" Repository="imodel02" PartFile="iModelCore/BeGTest/BeGTest"/>
        <Bindings>
            <Directory ProductDirectoryName="iOSXCTestProject" SourceName="Delivery/iOSXCTest/LicensingUnitTest/Project" />
        </Bindings>
    </Part>

    <Product Name="Licensing-iOSXCTest" >
        <SubPart PartName="iOSXCTest" LibType="Static"/>
        <Directories DirectoryListName="iOSXCTestProduct" Repository="imodel02" PartFile="iModelCore/BeGTest/BeGTest"/>
    </Product>

    <Part Name="RuniOSXCTest" DeferType="RunUnitTests" BentleyBuildMakeFile="$(BuildContext)/SubParts/BeGTest/iOS//RunXCTestProject.mke" BentleyBuildMakeOptions="-dXCTEST_PRODUCT=Licensing-iOSXCTest" OnlyPlatforms="iOS*">
        <SubProduct ProductName="Licensing-iOSXCTest"/>
        <Bindings>
            <Files Required="false" SubPartDirectory="XCTest/Logs">Delivery/XCTest/Logs/Licensing-iOSXCTest.log</Files>
        </Bindings>
    </Part>

    <!-- *********************************************************** -->
    <!-- **** UWP Microsoft::VisualStudio::CppUnitTestFramework **** -->
    <!-- *********************************************************** -->
    <!-- N.B. ApiNumber is important here because we must manually reference some DLLs, and thus need an accruate suffix to find them. -->
    <Part
        Name="UwpTest"
        DeferType="BuildUnitTests"
        BentleyBuildMakeFile="$(BuildContext)/SubParts/BeGTest/uwp//MakeUwpTestProject.mke"
        BentleyBuildMakeOptions="-dTEST_NAME=LicensingUnitTest -dTEST_COLLECTION_PRODUCT=Licensing-UnitTests"
        OnlyPlatforms="WinRT*"
        ApiNumber="M02"
        >
        <SubProduct ProductName="Licensing-UnitTests"/>
        <SubPart PartName="UwpTest-Tools" Repository="imodel02" PartFile="iModelCore/BeGTest/BeGTest"/>
        <Bindings>
            <Directory ProductDirectoryName="UwpTestProject" SourceName="Delivery/LicensingUwpTest"/>
        </Bindings>
    </Part>

    <Product Name="Licensing-UwpTest">
        <SubPart PartName="UwpTest"/>
        <Directories DirectoryListName="UwpTestProduct" Repository="imodel02" PartFile="iModelCore/BeGTest/BeGTest"/>
    </Product>

    <Part
        Name="RunUwpTest"
        DeferType="RunUnitTests"
        BentleyBuildMakeFile="$(BuildContext)/SubParts/BeGTest/uwp//RunUwpTestProject.mke"
        BentleyBuildMakeOptions="-dUWPTEST_PRODUCT=Licensing-UwpTest"
        OnlyPlatforms="WinRT*"
        >
        <SubPart PartName="UwpTest-Tools" Repository="imodel02" PartFile="iModelCore/BeGTest/BeGTest"/>
        <SubProduct ProductName="Licensing-UwpTest"/>
        <Bindings>
            <Files Required="false" SubPartDirectory="UwpTest/Logs">Delivery/UwpTest/Logs/Licensing-UwpTest.log</Files>
        </Bindings>
    </Part>

    <!-- ******************************** Integration Tests ************************************** -->
    <Part Name="PrewireForIntegrationTests" DeferType="BuildUnitTests" BentleyBuildMakeFile="Tests/IntegrationTests/Prewire.mke">
        <Bindings>
            <Files ProductDirectoryName="UnitTests-IgnoreList" ProductSubDirectory="Licensing" SubPartDirectory="IntegrationTests">Delivery/IntegrationTests/ignore_list.txt</Files>
        </Bindings>
    </Part>
    
    <Part Name="IntegrationTests" DeferType="BuildUnitTests" BentleyBuildMakeFile="Tests/IntegrationTests/BuildTests.mke" BentleyBuildMakeOptions="-dTestDir=NonPublished">
        <SubPart PartName="PrewireForIntegrationTests" />
        <SubPart PartName="OidcNativeClient" />
        <SubPart PartName="Licensing" />
        <SubPart PartName="Gtest-Tools" Repository="imodel02" PartFile="iModelCore/BeGTest/BeGTest"/>
        <Bindings>
            <Directory ProductDirectoryName="UnitTests-Objects" ProductSubDirectory="Licensing/IntegrationTests/NonPublished" SourceName="Delivery/IntegrationTests/Objects/NonPublished"/>
        </Bindings>
    </Part>

    <Product Name="Licensing-IntegrationTests">
        <SubPart Repository="imodel02" PartFile="iModelCore/BeGTest/BeGTest" PartName="Base" />
        <SubPart PartName="IntegrationTests"/>
        <Directories DirectoryListName="CollectionProduct" Repository="imodel02" PartFile="iModelCore/BeGTest/BeGTest"/>
        <Directories DirectoryListName="Licensing-IntegrationTestsDirs"/>
    </Product>

    <ProductDirectoryList ListName="Licensing-IntegrationTestsDirs">
        <ProductDirectory Name="Gtest-NativeAssemblies" Deliver="false"/>
    </ProductDirectoryList>

    <Part Name="GtestIntegration" DeferType="BuildUnitTests" BentleyBuildMakeFile="${SrcRoot}imodel02/iModelCore/BeGTest/gtest/buildGtest.mke" BentleyBuildMakeOptions="-dTEST_NAME=LicensingIntegrationTest -dTEST_COLLECTION_PRODUCT=Licensing-IntegrationTests" OnlyPlatforms="x86,x64">
        <SubProduct ProductName="Licensing-IntegrationTests"/>
        <SubPart PartName="Gtest-Tools" Repository="imodel02" PartFile="iModelCore/BeGTest/BeGTest"/>

        <Bindings>
            <Files ProductDirectoryName="Gtest-NativeAssemblies">Delivery/Gtest/LicensingIntegrationTest/Assemblies/*</Files>
            <Directory ProductDirectoryName="Gtest-Assets" SourceName="Delivery/Gtest/LicensingIntegrationTest/Assets" />
        </Bindings>
    </Part>

    <Part Name="RunGtestIntegration" DeferType="RunUnitTests" BentleyBuildMakeFile="${SrcRoot}imodel02/iModelCore/BeGTest/gtest/RunGtest.mke" BentleyBuildMakeOptions="-dGTEST_PRODUCT=Licensing-GtestIntegration -dGTEST_NAME=LicensingIntegrationTest" OnlyPlatforms="x86,x64">
        <SubProduct ProductName="Licensing-GtestIntegration" />
        <SubPart PartName="Gtest-Tools" Repository="imodel02" PartFile="iModelCore/BeGTest/BeGTest"/>

        <Bindings>
          <Files Required="false" SubPartDirectory="Gtest/Logs">Delivery/Gtest/Logs/LicensingIntegrationTest.log</Files>
        </Bindings>
    </Part>    

    <Product Name="Licensing-GtestIntegration" >
        <SubPart PartName="GtestIntegration"/>
        <Directories DirectoryListName="GtestProduct" Repository="imodel02" PartFile="iModelCore/BeGTest/BeGTest"/>
    </Product>

    <!-- for OIDC tokens in Integration tests -->
    <Part Name="OidcNativeClient" DeferType="BuildUnitTests" OnlyPlatforms="x64" BentleyBuildMakeFile="Tests/IntegrationTests/OidcNativeClientPrewire.mke">
        <NuGetPackage>Testing.OidcNativeClient</NuGetPackage>
        <Bindings>
            <Libs>Nuget\native\OidcInterop$(libext)</Libs>
            <Assemblies>
                Nuget\native\HtmlAgilityPack$(shlibext)
                Nuget\native\IdentityModel$(shlibext)
                Nuget\native\IdentityModel.OidcClient$(shlibext)
                Nuget\native\Microsoft.Extensions.DependencyInjection.Abstractions$(shlibext)
                Nuget\native\Microsoft.Extensions.Logging.Abstractions$(shlibext)
                Nuget\native\Microsoft.Extensions.Logging$(shlibext)
                Nuget\native\Microsoft.IdentityModel.Logging$(shlibext)
                Nuget\native\Microsoft.IdentityModel.Tokens$(shlibext)
                Nuget\native\Newtonsoft.Json$(shlibext)
                Nuget\native\OidcClient$(shlibext)
                Nuget\native\OidcInterop$(shlibext)
                Nuget\native\System.IdentityModel.Tokens.Jwt$(shlibext)
                Nuget\native\System.Net.Http$(shlibext)
                Nuget\native\WebDriver$(shlibext)
            </Assemblies>
            <Files ProductDirectoryName="Gtest-NativeAssemblies">
                Delivery/chromedriver.exe
                Delivery/LicensingIntegrationTest.exe.config
            </Files>
        </Bindings>
    </Part>

    <Product Name="LicenseClientCrossPLatform" PrgOutputDir="LicenseClientCrossPlatform" SaveProduct="true" SaveTranskit="true">
        <SubPart PartName="Licensing"/>
        <Directories DirectoryListName="LicenseClientCrossPlatform"/>

        <SubProduct ProductName="Licensing-GtestUnit"/>
        <SubPart PartName="RunGtestUnit"/>

        <SubProduct ProductName="Licensing-GtestIntegration"/>
        <SubPart PartName="RunGtestIntegration"/>    
    </Product>



    <ProductDirectoryList ListName="LicenseClientCrossPlatform">
        <ProductDirectory Name="Assemblies" Deliver="true"/>
        <ProductDirectory Name="Assemblies" Deliver="true" LibType="Static"/>
        <ProductDirectory Name="Assets" Deliver="true"/>
        <ProductDirectory Name="VendorNotices" Deliver="false"/>
        <ProductDirectory Name="VendorNotices" Deliver="false" LibType="Static"/>
    </ProductDirectoryList>

</BuildContext>
