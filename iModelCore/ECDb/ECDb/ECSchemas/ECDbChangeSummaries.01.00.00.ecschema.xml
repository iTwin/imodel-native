<ECSchema schemaName="ECDbChangeSummaries" alias="change" version="01.00.00" description="ECDb Change Summaries" displayLabel="ECDb Change Summaries" xmlns="http://www.bentley.com/schemas/Bentley.ECXML.3.1">
    <ECSchemaReference name="ECDbMap" version="02.00.01" alias="ecdbmap"/>
      
    <ECEntityClass typeName="ChangeSummary" displayLabel="Summary">
        <ECCustomAttributes>
            <ClassMap xmlns="ECDbMap.02.01">
                <MapStrategy>TablePerHierarchy</MapStrategy>
                <TableSpace>changesummaries</TableSpace>
            </ClassMap>
        </ECCustomAttributes>
    </ECEntityClass>

    <ECEnumeration typeName="OpCode" backingTypeName="int" isStrict="true">
        <ECEnumerator value="1" displayLabel="Insert"/>
        <ECEnumerator value="2" displayLabel="Update"/>
        <ECEnumerator value="4" displayLabel="Delete"/>
    </ECEnumeration>

    <ECStructClass typeName="InstanceKey" displayLabel="InstanceKey" modifier="Sealed">
        <ECProperty propertyName="Id" typeName="long" />
        <ECProperty propertyName="ClassId" typeName="long" />
    </ECStructClass>
    
    <ECEntityClass typeName="InstanceChange" displayLabel="Instance Change"  description="Represents an instance change in a change summary">
        <ECCustomAttributes>
            <ClassMap xmlns="ECDbMap.02.01">
                <MapStrategy>TablePerHierarchy</MapStrategy>                 
                <TableSpace>changesummaries</TableSpace>
            </ClassMap>
            <DbIndexList xmlns="ECDbMap.02.01">
                <Indexes>
                    <DbIndex>
                        <Name>uix_change_InstanceChange_SummaryId_ChangedInstance</Name>
                        <IsUnique>True</IsUnique>
                        <Properties>
                            <string>Summary.Id</string>
                            <string>ChangedInstance.Id</string>
                            <string>ChangedInstance.ClassId</string>
                        </Properties>
                    </DbIndex>
                </Indexes>
            </DbIndexList>
        </ECCustomAttributes>
        <ECNavigationProperty propertyName="Summary" relationshipName="ChangeSummaryContainsInstanceChanges" direction="backward" >
            <ECCustomAttributes>
                <ForeignKeyConstraint xmlns="ECDbMap.02.01">
                    <OnDeleteAction>Cascade</OnDeleteAction>
                </ForeignKeyConstraint>
            </ECCustomAttributes>
        </ECNavigationProperty> 
        <ECStructProperty propertyName="ChangedInstance" typeName="InstanceKey" description="Key of the change instance"/>
        <ECProperty propertyName="OpCode" typeName="OpCode"/>
        <ECProperty propertyName="IsIndirect" typeName="bool" description="Change happened due to a foreign key action or trigger"/>
    </ECEntityClass>
    
    <ECEntityClass typeName="PropertyValueChange" displayLabel="Property Value Change" description="Represents an property value change of an instance change in a change summary">
        <ECCustomAttributes>
            <ClassMap xmlns="ECDbMap.02.01">
                <MapStrategy>TablePerHierarchy</MapStrategy>
                <TableSpace>changesummaries</TableSpace>
            </ClassMap>
            <DbIndexList xmlns="ECDbMap.02.01">
                <Indexes>
                    <DbIndex>
                        <Name>uix_change_PropertyValueChange_InstanceChangeId_AccessString</Name>
                        <IsUnique>True</IsUnique>
                        <Properties>
                            <string>InstanceChange.Id</string>
                            <string>AccessString</string>
                        </Properties>
                    </DbIndex>		
                </Indexes>
            </DbIndexList>            
        </ECCustomAttributes>
        <ECNavigationProperty propertyName="InstanceChange" relationshipName="InstanceChangeOwnsPropertyValueChanges" direction="backward">
            <ECCustomAttributes>
                <ForeignKeyConstraint xmlns="ECDbMap.02.01">
                    <OnDeleteAction>Cascade</OnDeleteAction>
                </ForeignKeyConstraint>
            </ECCustomAttributes>
        </ECNavigationProperty>
        <ECProperty propertyName="AccessString" typeName="string"/>
        <ECProperty propertyName="RawOldValue" typeName="binary" description="Untyped old value"/>
        <ECProperty propertyName="RawNewValue" typeName="binary" description="Untyped new value"/>
    </ECEntityClass>
    
    <ECRelationshipClass typeName="ChangeSummaryContainsInstanceChanges" modifier="Sealed" strength="embedding">
        <Source multiplicity="(1..1)" roleLabel="has" polymorphic="false">
            <Class class="ChangeSummary"/>
        </Source>
        <Target multiplicity="(0..*)" roleLabel="is contained in" polymorphic="false">
            <Class class="InstanceChange"/>
        </Target>
    </ECRelationshipClass>
    
    <ECRelationshipClass typeName="InstanceChangeOwnsPropertyValueChanges" modifier="Sealed" strength="embedding">
        <Source multiplicity="(1..1)" roleLabel="owns" polymorphic="false">
            <Class class="InstanceChange"/>
        </Source>
        <Target multiplicity="(0..*)" roleLabel="is contained in" polymorphic="false">
            <Class class="PropertyValueChange"/>
        </Target>
    </ECRelationshipClass>
</ECSchema>
