<?xml version="1.0" encoding="utf-8"?>

<BuildContext xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="../bsicommon/build/PartFile.xsd">

    <!-- Bind my own PublicAPI and VendorAPI into BuildContext. Note that this part does not cause any sub-part PublicAPIs to be bound. Also deliver my notices. -->
    <Part Name="PublicAPI" BentleyBuildMakeFile="ECDb.prewire.mke">
        <Bindings>
            <PublicAPI Domain="ECDb" />
        </Bindings>
    </Part>

    <Part Name="ECDb">
        <SubPart PartName="PublicAPI" />
        <SubPart PartName="ECDbLibrary" />
        <SubPart PartName="PublishedApi" />
        <SubPart PartName="ECDbPrepareDocGeneration" />
    </Part>

    <!-- NOTE: Graphite uses "G" as an ApiNumber (library suffix) to disambiguate from Vancouver libraries -->
    <Part Name="ECDbLibrary" BentleyBuildMakeFile="ECDb/ECDb.mke" ApiNumber="G">
        <SubPart PartName="PublicAPI" />
        <SubPart PartName="BeSQLite"        PartFile="BeSQLite"  Repository="BESQLite"/>
        <SubPart PartName="ECObjectsNative" PartFile="ecobjects" Repository="ecobjects" />
        <SubPart PartName="GeomlibsSerialization" PartFile="geomlibs" Repository="geomlibs" />
        <SubPart PartName="BeJsonCpp"       PartFile="BeJsonCpp" Repository="Libsrc-JsonCpp"/>
        <SubPart PartName="rapidjson"       PartFile="rapidjson" Repository="Libsrc-RapidJson"/>
        <Bindings>
            <Libs>Delivery/$(libprefix)BeSQLiteEC$(libext)</Libs>
            <Assemblies ProductDirectoryName="BentleyNativeAssemblies">Delivery/$(libprefix)BeSQLiteEC$(ApiNumber)$(shlibext)</Assemblies>
            <Files ProductDirectoryName="VendorNotices" Required="true">Delivery/openoffice-notice.txt</Files>
            <Files ProductDirectoryName="ECSchemas" ProductSubDirectory="ECSchemas/ECDb" SubPartDirectory="ECSchemas/ECDb">
                ECSchemas/ECDb/*.ecschema.xml
            </Files>
        </Bindings>
    </Part>

   
    <Part Name="ECDbPrepareDocGeneration" BentleyBuildMakeFile="ECDb/docs/preparedocgeneration.mke">
        <SubPart PartName="PublishedApi" />
        <SubPart PartName="ECDbExtractCodeSamples" />
        <SubPart PartName="ECDbBuildCodeSamples" />
        <SubPart PartName="StandardSchemas" PartFile="ECStandards"  Repository="ECStandards"/>
        <Bindings>
            <Directory SourceName="Docs/Source/ECDb" SubPartDirectory="Docs/Source/ECDb"/>
            <Directory SourceName="Docs/Images/ECDb" SubPartDirectory="Docs/Images/ECDb"/>
            <Directory SourceName="Docs/Files/ECDb" SubPartDirectory="Docs/Files/ECDb"/>
        </Bindings>
    </Part>

    <Part Name="ECDbExtractCodeSamples" BentleyBuildMakeFile="${SrcBsiCommon}build/Extractions.mke" BMakeOptions="-dEXTRACTIONS_SOURCE_DIR=$(SrcRoot)ECDb/ECDb/docs/samplecode -dEXTRACTIONS_OUTPUT_BUILD_SUBDIR=ECDb/docs/extractedsamplecode -dEXTRACTIONS_NO_PROVENANCE">
        <SubPart PartName="ECDbLibrary" />
        <SubPart PartName="PublishedApi" />
    </Part>

    <Part Name="ECDbBuildCodeSamples" BentleyBuildMakeFile="${SrcBsiCommon}build/BuildSampleCode.mke" BMakeOptions="-dBUILD_SAMPLE_CODE_SOURCE_DIR=$(SrcRoot)ECDb/ECDb/docs/samplecode -dBUILD_SAMPLE_CODE_SUB_DIR=ecdbsamplecode -dPolicyFile=$(SrcRoot)ECDb/ECDb/ECDbPolicy.mki">
        <SubPart PartName="ECDbLibrary" />
        <SubPart PartName="PublishedApi" />
    </Part>
  
    <!-- TRICKY: There are two sets of public APIs, BeSQLite and ECDb. There is only one published API for this repository, and it must do for both. 
         To avoid that we run the publishing twice this part cares for it and symlinks the same published API once under the name of BeSQLite and
         once under the name of ECDb-->
    <Part Name="PublishedApi" BentleyBuildMakeFile="${SrcBsiCommon}sharedmki/PublishApi.mke" BMakeOptions="+dPUBLISHAPI_DELIVERY_DIR=Delivery/PublishedApi +dPUBLISHAPI_VENDORAPI=json +dPUBLISHAPI_VENDORAPI2=rapidjson">
        <SubPart PartName="ECDbLibrary" />
        <Bindings>
            <Directory SourceName="Delivery/PublishedApi"  SubPartDirectory="PublishedApi/ECDb"/>
        </Bindings>
    </Part>

    <Part Name="PrewireForUnitTests" BentleyBuildMakeFile="Tests/Prewire.mke">
        <SubPart PartName="UnitTests-Documents-DgnDb" Repository="BeGTest" PartFile="BeGTest"/>
        <SubPart PartName="ECDb"/>
        <SubPart PartName="Zlib"                             PartFile="Zlib"         Repository="Libsrc-Compress" />
        <Bindings>
            <Files ProductDirectoryName="UnitTests-IgnoreList"     ProductSubDirectory="ECDb" SubPartDirectory="UnitTests/ECDb"> Delivery/UnitTests/ignore_list.txt</Files>
        </Bindings>
    </Part>

    <Part Name="BackDoorForUnitTests" BentleyBuildMakeFile="Tests/BuildTests.mke" BentleyBuildMakeOptions="-dTestDir=BackDoor -dIsBackDoor">
        <SubPart PartName="PrewireForUnitTests" />
        <Bindings>
            <Directory ProductDirectoryName="UnitTests-Objects"    ProductSubDirectory="ECDb/BackDoor" SourceName="Delivery/UnitTests/Objects/BackDoor"/>
        </Bindings>
    </Part>

    <Part Name="UnitTests-Performance" BentleyBuildMakeFile="Tests/BuildTests.mke" BentleyBuildMakeOptions="-dTestDir=Performance">
        <SubPart PartName="PrewireForUnitTests" />
        <SubPart PartName="PerformanceTestingHelpers" PartFile="BeSQLite" Repository="BeSQLite"/>
        <SubPart PartName="BackDoorForUnitTests"/>
        <Bindings>
            <Directory ProductDirectoryName="UnitTests-Objects"    ProductSubDirectory="ECDb/Performance" SourceName="Delivery/UnitTests/Objects/Performance"/>
        </Bindings>
    </Part>

    <Part Name="UnitTests-Published" BentleyBuildMakeFile="Tests/BuildTests.mke" BentleyBuildMakeOptions="-dTestDir=Published -dUsePublishedApi">
        <SubPart PartName="BackDoorForUnitTests" />
        <SubPart PartName="PublishedApi" />
        <Bindings>
            <Directory ProductDirectoryName="UnitTests-Objects"    ProductSubDirectory="ECDb/Published" SourceName="Delivery/UnitTests/Objects/Published"/>
        </Bindings>
    </Part>

    <!-- *** ********************************************************** *** -->
    <!-- *** WARNING: Numerous BuildStrategies point to this part! *** -->
    <!-- *** ********************************************************** *** -->
    <!-- If you move this part, you must fix up the BuildStrategies that point to it. -->
    <!-- TRICKY: Documents are only actually published for x64,x86 but we must do other processing for other platforms and other cases so no platforms can be excluded! -->
    <Part Name="UnitTests_Documents" BentleyBuildMakeFile="${SrcBsiCommon}sharedmki/PublishDocuments.mke" BMakeOptions="-dUNIT_TESTS_NAME=ECDbUnitTests -dUNIT_TESTS_DOCUMENTS_DIR=${SrcRoot}/DgnPlatformTest/DgnDbUnitTests/ -dUNIT_TESTS_DOCUMENTS_PREBUILTS_SUBDIR=DgnDb -dUNIT_TESTS_PUBLISH_CONFIG=${SrcRoot}/BeGTest/UnitTestPublisherConfiguration.xml">
        <SubPart PartName="LinkDgnDbPublisherIntoToolContext" PartFile="BeGTest" Repository="BeGTest" />
        <SubPart PartName="DgnDbUnitTestsData"/>
        <Bindings>
            <Directory SourceName="Delivery/UnitTests/Documents" SubPartDirectory="Documents/DgnDb" ProductDirectoryName="UnitTests_Documents_DgnDb" />
            <!-- Note: for BTest, use pre-published documents -->
        </Bindings>
    </Part>

    <Part Name="DgnDbUnitTestsData" OnlyPlatforms="x64,x86">
        <RequiredRepository>DgnDbUnitTestsData</RequiredRepository>
    </Part>

    <!-- Define the collection of all available tests. -->
    <Part Name="TestCollection-All">
        <SubPart PartName="UnitTests-Published" />
        <!--
        <SubPart PartName="UnitTests-Performance" />
        -->
    </Part>

    <!-- Define dynamic and static versions of the test collection -->
    <Part Name="TestCollection-All-Dynamic" OnlyPlatforms="x86,x64,Linux*,MacOS*,WinRT*">
        <SubPart PartName="TestCollection-All"/>
    </Part>

    <Part Name="TestCollection-All-Static" ExcludePlatforms="x86,x64,Linux*,MacOS*,WinRT*">
        <SubPart PartName="TestCollection-All" LibType="static" />
    </Part>
    
    <!-- Define a product for this test collection -->
    <Product Name="ECDb-TestCollection-All">
        <SubPart Repository="BeGTest" PartFile="BeGTest" PartName="Base" />
        <SubPart PartName="TestCollection-All-Dynamic"/>
        <SubPart PartName="TestCollection-All-Static" />
        <Directories DirectoryListName="CollectionProduct" Repository="BeGTest"  PartFile="BeGTest"/>
    </Product>

    <!--                *************** -->
    <!--                **** gtest **** -->
    <!--                *************** -->
    <Part Name="Gtest-TestCollection-All" BentleyBuildMakeFile="${SrcRoot}BeGTest/gtest/buildGTest.mke" BentleyBuildMakeOptions="-dTEST_NAME=ECDbTest -dTEST_COLLECTION_PRODUCT=ECDb-TestCollection-All" OnlyPlatforms="x86,x64,Linux*,MacOS*">
        <SubProduct ProductName="ECDb-TestCollection-All"/>
        <SubPart PartName="Gtest-Tools" Repository="BeGTest" PartFile="BeGTest"/>
        <Bindings>
            <Files ProductDirectoryName="Gtest-NativeAssemblies">Delivery/Gtest/ECDbTest/Assemblies/*</Files>
            <Directory ProductDirectoryName="Gtest-Assets" SourceName="Delivery/Gtest/ECDbTest/Assets" />
        </Bindings>
    </Part>

    <Product Name="Gtest-ECDbTest-TestCollection-All" >
        <SubPart PartName="Gtest-TestCollection-All"/>
        <Directories DirectoryListName="GtestProduct" Repository="BeGTest" PartFile="BeGTest"/>
    </Product>

    <Part Name="RunGtest-TestCollection-All" BentleyBuildMakeFile="${SrcRoot}BeGTest/gtest/RunGTest.mke" BentleyBuildMakeOptions="-dGTEST_EXE=$(OutputRootDir)Product/Gtest-ECDbTest-TestCollection-All/ECDbTest -dGTEST_OUTPUT_DIR=$(OutputRootDir)build/ECDb" OnlyPlatforms="x86,x64,MacOs*,Linux*">
        <SubProduct ProductName="Gtest-ECDbTest-TestCollection-All" />
        <SubPart PartName="Gtest-Tools" Repository="BeGTest" PartFile="BeGTest"/>
    </Part>

    <!-- //////////////////////////////////////////////////////////////////////////// -->
    <!-- // ECSqlConsole                                                           // -->
    <!-- //////////////////////////////////////////////////////////////////////////// -->

    <Product Name="ECSqlConsole" SaveProduct="true">
        <SubPart PartName="ECSqlConsoleExe" />
        <Directories DirectoryListName="ECSqlConsoleDirList" />
    </Product>

    <Part Name="ECSqlConsoleExe" BentleyBuildMakeFile="ECSqlConsole/ECSqlConsole.mke">
        <SubPart PartName="ECDb"/>
        <Bindings>
            <Files ProductDirectoryName="ECSqlConsole">Delivery/ECSqlConsole$(exeext)
                                                       Delivery/logging.config.xml</Files>
        </Bindings>
    </Part>

    <ProductDirectoryList ListName="ECSqlConsoleDirList" >
        <ProductDirectory Name="PublicAPI"                          Deliver="false"/>
        <ProductDirectory Name="PublicAPI"                          Deliver="false" LibType="static"/>
        <ProductDirectory Name="VendorAPI"                          Deliver="false"/>
        <ProductDirectory Name="VendorAPI"                          Deliver="false" LibType="static"/>
        <ProductDirectory Name="Libs"                               Deliver="false"/>
        <ProductDirectory Name="Libs"                               Deliver="false" LibType="static"/>
        <ProductDirectory Name="BentleyLibs"                        Deliver="false"/>
        <ProductDirectory Name="LoggingManagedAssemblies"           Deliver="false"/>
        <ProductDirectory Name="LoggingOptionalManagedAssemblies"   Deliver="false"/>
        <ProductDirectory Name="LoggingWorkspaceData"               Deliver="false"/>
        <ProductDirectory Name="MergeModules"                       Deliver="false"/>
        
        <ProductDirectory Name="ECSqlConsole"                       Path=""/>
        <ProductDirectory Name="bentleynativeassemblies"            Path=""/>
        <ProductDirectory Name="ecobjectsnativeassemblies"          Path=""/>
        <ProductDirectory Name="ecschemas"                          Path=""/>
        <ProductDirectory Name="geomnativeassemblies"               Path=""/>
        <ProductDirectory Name="loggingnativeassemblies"            Path=""/>
        <ProductDirectory Name="VendorNotices"                      Path="Notices"/>
        <ProductDirectory Name="VendorNotices"                      Path="Notices" LibType="static"/>
    </ProductDirectoryList>

</BuildContext>
