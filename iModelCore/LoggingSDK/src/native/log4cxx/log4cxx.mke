#--------------------------------------------------------------------------------------
#
#     $Source: src/native/log4cxx/log4cxx.mke $
#
#   $Copyright: (c) 2018 Bentley Systems, Incorporated. All rights reserved. $
#
#--------------------------------------------------------------------------------------
HAVE_PERMISSION_TO_COMPILE_AT_W3=1

%include mdl.mki
%include $(SrcRoot)imodel02/iModelCore/LoggingSDK/mki/LoggingSdkCommon.mki

#-----------------------------------------------------------------------
#       Project Setup
#-----------------------------------------------------------------------
appName         = bentleylog4cxx
programName     = $(appName)
baseDir         = $(_MakeFilePath)

always:
    !~@mkdir $(o)


#-----------------------------------------------------------------------
#       Include compile options and pw macros
#-----------------------------------------------------------------------
$(BuildContext)PublicAPI/BentleyLog4cxx : $(_MakeFilePath)PublicAPI
    $(LinkFirstDepToFirstTargetAsDirectory)

nameToDefine = BSILOG_LOG4CXX_EXPORTS
%include cdefapnd.mki

nameToDefine = UNICODE
%include cdefapnd.mki

nameToDefine = LOG4CXX_STATIC
%include cdefapnd.mki

dirToSearch = $(nativeIntDir)
%include cincapnd.mki

#Ignore unknown pragmas (i.e. pragma mark)
LLVMCommonCompOpts  + -Wno-unknown-pragmas

CCompPDBName = $(appName)

#-----------------------------------------------------------------------
#       Include Files
#-----------------------------------------------------------------------
Includes    =   $(baseDir)PublicAPI/log4cxx.h \
                $(baseDir)CustomAppenders/androidlogprintappender.h \
                $(BuildContext)PublicApi/Logging/bentleylogging.h

#-----------------------------------------------------------------------
#       Compile Source
#-----------------------------------------------------------------------
MultiCompileDepends=$(_MakeFileSpec) $(Includes)
%include MultiCppCompileRule.mki

$(o)log4cxx$(oext)     : $(baseDir)log4cxx.cpp       ${MultiCompileDepends}

%if $(TARGET_PLATFORM)=="Windows"
$(o)cinterface$(oext)  : $(baseDir)cinterface.cpp    ${MultiCompileDepends}

$(o)dllmain$(oext)     : $(baseDir)dllmain.cpp       ${MultiCompileDepends}
%endif

%if $(TARGET_PLATFORM)=="Android"
$(o)androidlogprintappender$(oext) : $(baseDir)CustomAppenders/androidlogprintappender.cpp ${MultiCompileDepends}
%endif

%include MultiCppCompileGo.mki
Objects =% $(MultiCompileObjectList)

#-----------------------------------------------------------------------
#   Create the Windows NT DLL from Objects
#-----------------------------------------------------------------------
LINKER_LIBRARIES =  $(BuildContextSubParts)StaticLibs/$(stlibprefix)liblog4cxx010$(stlibext) \
                    $(BuildContextSubParts)StaticLibs/$(stlibprefix)libapr$(stlibext) \
                    $(BuildContextSubParts)StaticLibs/$(stlibprefix)libaprutil$(stlibext) \
                    $(BuildContextSubParts)StaticLibs/$(stlibprefix)libexpat$(stlibext)

%if $(TARGET_PLATFORM)=="Windows"
LINKER_LIBRARIES   +   ws2_32.lib odbc32.lib advapi32.lib mswsock.lib Rpcrt4.lib
%endif

# Cannot use libsmtp in DgnDb due to licensing concerns.
#                        $(BuildContextSubParts)libs/libsmtp08.lib \

%include $(sharedMki)linklibrary.mki

#-----------------------------------------------------------------------
#   Copy the files required for the SDK
#-----------------------------------------------------------------------
$(BuildContextDelivery)log4j.dtd : $(ContextSubpartsLibs)log4j.dtd
    $(LinkFirstDepToFirstTarget)

