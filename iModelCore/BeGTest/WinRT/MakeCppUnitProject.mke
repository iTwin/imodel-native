#--------------------------------------------------------------------------------------
#
#     $Source: WinRT/MakeCppUnitProject.mke $
#
#  $Copyright: (c) 2015 Bentley Systems, Incorporated. All rights reserved. $
#
#--------------------------------------------------------------------------------------
%ifndef TEST_NAME
    %error Must define TEST_NAME as the name of the .exe to create
%endif

%ifndef TEST_COLLECTION_PRODUCT
    %error TEST_COLLECTION_PRODUCT must point to the product that contains the unit tests and their supporting libraries and assets
%endif

# Optional. TEST_FRAMEWORK_SQLANG - Full filepath of .db3 file to return as the "framework" sqlang file

%include mdl.mki

%if $(TARGET_PLATFORM)!="WinRT"
    %error This makefile should be used only when TARGET_PLATFORM is WinRT
%endif

baseDir             = $(_MakeFilePath)
o                   = $(OutputRootDir)build/BeTestWinRT/
tmp                 = $(o)tmp/
projectDir          = $(o)Project/

collectionProduct = $(OutputRootDir)Product/${TEST_COLLECTION_PRODUCT}/
collectionAssetsDir = $(collectionProduct)Assets/
collectionAssembliesDir = $(collectionProduct)Assemblies/
collectionLibsDir = $(collectionProduct)Libs/
collectionTestObjectsDir = $(collectionProduct)Objects/

%if defined (BMAKE_DELETE_ALL_TARGETS)
    always:
        $(rmdirRecursiveCmd) $(o)

    %return 
%else
    always:
        ~mkdir $(o)
        ~mkdir $(tmp)
        !~@putenv PYTHONPATH=$(PYTHONPATH)$(bsicommon_ospathsep)$(SrcBsiCommon)PublicSDK
%endif

%ifndef TEST_FRAMEWORK_SQLANG
    TEST_FRAMEWORK_SQLANG=DgnPlatform_en.sqlang.db3
%endif

always:
    !~@mkdir $(projectDir)gensrc
    > $(projectDir)gensrc/TEST_FRAMEWORK_SQLANG_DEF.h
\#define TEST_FRAMEWORK_SQLANG L"$(TEST_FRAMEWORK_SQLANG)"
    <

#--------------------------------------------------------------------------------------
# Copy the entire project structure (physical directories + symlinked files)
# The VS project file will be modified (and we don't want to check that in) so make a hard copy for it
# Also create a hard copy of the .sln so that there is no confusion over which vcxproj to open
#--------------------------------------------------------------------------------------
always:
    CopyWithSymlinks.py $(baseDir)VisualStudioProject/BeTestTest1 $(projectDir)
    !-$(deleteCmd) $(projectDir)BeTestTest1.vcxproj
    $(copyCmd) $(baseDir)VisualStudioProject/BeTestTest1/BeTestTest1.vcxproj $(projectDir)BeTestTest1.vcxproj
    !-$(deleteCmd) $(projectDir)BeTestTest1.sln
    $(copyCmd) $(baseDir)VisualStudioProject/BeTestTest1/BeTestTest1.sln $(projectDir)BeTestTest1.sln
    
#--------------------------------------------------------------------------------------
# CppUnit wrappers
#
#   GenerateCppUnitSource.py finds the unit tests that are linked into a known directory.
#   For each, it generates a .cpp file that defines OCUnit test case methods that call the run_TEST_... functions that invoke the unit tests.
#   Make this depend on the *UnitTests.list.h files - these change when a unit test is added or removed
#--------------------------------------------------------------------------------------
$(tmp)GenerateCppUnitSource.mki : $[@wildcard $(collectionTestObjectsDir)*UnitTests.list.h] $(baseDir)CppUnit.cpp.template $(_MakeFileSpec)
    $(msg)
    !@$(baseDir)GenerateCppUnitSource.py $(collectionTestObjectsDir) $(baseDir)CppUnit.cpp.template > $@
    ~time

%iffile $(tmp)GenerateCppUnitSource.mki
    %include $(tmp)GenerateCppUnitSource.mki

always:
    !-$(deleteCmd) $(tmp)GenerateCppUnitSource.mki
%endif

always:
    !~@mkdir $(tmp)

#--------------------------------------------------------------------------------------
# Update the .vcxproj file to reference all generated source files as compilables
#--------------------------------------------------------------------------------------
gensrc = $(o)Project/source/

always:
    >$(tmp)sourceFiles.list
    $[@wildcard $(gensrc)*.cpp]
    <
    $(baseDir)AddSourceFileReferencesToVSProject.py $(projectDir)BeTestTest1.vcxproj $(tmp)sourceFiles.list

#--------------------------------------------------------------------------------------
# Update the .vcxproj file to reference all assets and put them to project dir
#--------------------------------------------------------------------------------------
always:
    >$(tmp)deliverables.list
    $[@subst $(collectionAssetsDir) "" $[@wildcard $(collectionAssetsDir)*]]
    $[@subst $(collectionAssembliesDir) "" $[@wildcard $(collectionAssembliesDir)*]]
    <
    $(baseDir)AddAssetReferencesToVSProject.py $(projectDir)BeTestTest1.vcxproj $(tmp)deliverables.list
    CopyWithSymlinks.py $(collectionAssetsDir) $(projectDir)
    CopyWithSymlinks.py $(collectionAssembliesDir) $(projectDir)
    
#--------------------------------------------------------------------------------------
# Deliver a single DLL that contains the unit tests themselves
#--------------------------------------------------------------------------------------
unitTestObjs = $[@wildcard $(collectionTestObjectsDir)*$(oext)]

%warn $(collectionTestObjectsDir)
%warn $[@wildcard $(collectionTestObjectsDir)*$(oext)]

DLM_NAME            = UnitTests
DLM_DEST            = $(projectDir)
DLM_EXPORT_DEST     = $(projectDir)
DLM_EXTENSION       = $(shlibext)
DLM_OBJECT_FILES    = $(unitTestObjs)
DLM_EXPORT_OBJS     = $(unitTestObjs)
DLM_OBJECT_DEST     = $(o)
DLM_SYMB_DEST       = $(o)
DLM_MAP_DEST        = $(o)
DLM_NO_SIGN         = 1
DLM_NO_DEF          = 1
DLM_NO_DLS          = 1
DLM_NOENTRY         = 0
LINKER_LIBRARIES   =   $[@wildcard $(collectionLibsDir)*$(libext)]

%include dlmlink.mki

#--------------------------------------------------------------------------------------
# Libs used by the test runner itself
#--------------------------------------------------------------------------------------
$(projectDir)Bentley.lib : $(BuildContext)SubParts/Libs/Bentley.lib
    $(LinkFirstDepToFirstTarget)

$(projectDir)BentleyAllocator.lib : $(BuildContext)SubParts/Libs/BentleyAllocator.lib
    $(LinkFirstDepToFirstTarget)

$(projectDir)BeSQLite.lib : $(BuildContext)SubParts/Libs/BeSQLite.lib
    $(LinkFirstDepToFirstTarget)

#--------------------------------------------------------------------------------------
# Deliver header files that VS will need in order to compile the test wrappers
#--------------------------------------------------------------------------------------
$(projectDir)PublicApi : $(BuildContext)PublicApi
    $(LinkFirstDepToFirstTargetAsDirectory)

$(projectDir)VendorApi : $(BuildContext)VendorApi
    $(LinkFirstDepToFirstTargetAsDirectory)

#--------------------------------------------------------------------------------------
# Delivery
#--------------------------------------------------------------------------------------
$(BuildContext)Delivery/WinRTCppUnitTest/$(TEST_NAME)/Project : $(o)Project
    $(LinkFirstDepToFirstTargetAsDirectory)
