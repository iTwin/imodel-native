#--------------------------------------------------------------------------------------
#
#     $Source: nonport/android/BeSecurity/BeSecurityJar.mke $
#
#  $Copyright: (c) 2016 Bentley Systems, Incorporated. All rights reserved. $
#
#--------------------------------------------------------------------------------------
%include mdl.mki

#--------------------------------------------------------------------------------------
#   Check for environment dependencies
#--------------------------------------------------------------------------------------
%if $(TARGET_PLATFORM)!="Android"
    %error This makefile should be used only when TARGET_PLATFORM is Android
%endif

%if !defined (ANT_HOME)
    %error Must set ANT_HOME
%endif

%if !defined (ANDROID_SDK_ROOT)
    %error Must set ANDROID_SDK_ROOT
%endif

#--------------------------------------------------------------------------------------
#   Set variables to match default Gradle project structure
#--------------------------------------------------------------------------------------
buildOut                        = $(OutputRootDir)build/$(_MakeFileName)/
projectJavaSrcDir               = $(_MakeFilePath)BeSecurityProject/src/main/java/
outputJarBaseName               = besecurity.jar
outputJarFile                   = $(buildOut)$(outputJarBaseName)
comBentleyAndroidSecurityDir    = $(projectJavaSrcDir)com/bentley/android/security/

always:
    !~@mkdir $(buildOut)

#--------------------------------------------------------------------------------------
#   Prepare for building jar files with gradle
#--------------------------------------------------------------------------------------
sdkroot = $[@subst / \\\\ $(ANDROID_SDK_ROOT)]
ndkroot = $[@subst / \\\\ $(ANDROID_NDK_ROOT)]

%ifnofile $(_MakeFilePath)local.properties
    always:
        >$(_MakeFilePath)local.properties
        sdk.dir=$(sdkroot)
        ndk.dir=$(ndkroot)
        <
    %endif  

_gradleCmd = ${GRADLE_HOME}/bin/gradle assemble makeJar

_gradleOptions = --project-dir $(_MakeFilePath)                                 \
                 --project-prop buildDirectory=$(buildOut)                                

%warn Need to define "release" target (instead of "debug") for PRG!
#--------------------------------------------------------------------------------------
#   Use Gradle to build the BeSecurity jar file
#--------------------------------------------------------------------------------------
$(outputJarFile) : $(_MakeFileSpec) $[@wildcard $(comBentleyAndroidSecurityDir)*.java]
    $(msg)
    !-$(deleteCmd) $(outputJarFile)
    $(_gradleCmd) $(_gradleOptions)
    ~time
    
#--------------------------------------------------------------------------------------
#   The resulting jar file is needed for DgnClientSdk-based products
#--------------------------------------------------------------------------------------
$(BuildContext)Delivery/$(outputJarBaseName) : $(outputJarFile)
    $(LinkFirstDepToFirstTarget)
