name: Begin-Addon-Release-$(Date:yyyy.MM.dd)$(Rev:.r)

trigger:
  branches:
    include:
    - main
    - release/* #FIXME: double check logic still works for this
  paths:
    exclude:
    - iModelJsNodeAddon/package_version.txt

pr: none

variables:
- group: imodel-native secret variables

stages:
- stage: queue_bump_version
  displayName: Queue bump-version.yml
  jobs:
  - job: get_id_then_queue
    displayName: Get Build Id then Queue
    pool:
      vmImage: ubuntu-latest

    steps:
      - checkout: self
        persistCredentials: true
      - task: NodeTool@0
        inputs:
          versionSpec: '18.x'

      - bash: az devops configure --defaults organization=$(System.TeamFoundationCollectionUri) project=$(System.TeamProject)
        displayName: Setup Azure CLI

      - bash: |
            pr_title=$(gh pr view 361 --json title -q '.title') # FIXME: Temp for testing
            nativeBuildNum=$(echo "$pr_title" | grep -o '\[buildNum:[^]]*\]' | grep -oP '\[buildNum:\K[^]]+') # FIXME: Temp for testing
            itwinjsPR=$(echo "$pr_title" | grep -o '\[itwinjsPR:[^]]*\]' | grep -o '[0-9]\+') # FIXME: Temp for testing
            # Cannot use above method because trigger will no know what branch/PR triggered commit into main. 
            # nativeBuildNum=$(echo "$(Build.SourceVersionMessage)" | grep -o '\[buildNum:[^]]*\]' | grep -oP '\[buildNum:\K[^]]+')
            # itwinjsPR=$(echo "$(Build.SourceVersionMessage)" | grep -o '\[itwinjsPR:[^]]*\]' | grep -o '[0-9]\+')

            if [[ -z "$itwinjsPR" ]]; then
              iTwinjsBranchName='master'
            else
              iTwinjsBranchName=$(gh pr view $itwinjsPR --json headRefName  --repo iTwin/itwinjs-core -q '.headRefName')
            fi

            echo "##vso[task.setvariable variable=ITWINJS_BRANCH;isoutput=true]$iTwinjsBranchName"
            echo "##vso[task.setvariable variable=NATIVE_BUILD_NUM;isoutput=true]imodel-native-internal-$nativeBuildNum"

            noCi="[no ci]"
            if [[ $pr_title != *"$noCi"* ]]; then
              echo "##vso[task.setvariable variable=SKIP_ADDON;isoutput=true]true"
            fi
        env:
          GITHUB_TOKEN: $(GH_TOKEN)
        displayName: get build id from commit
        name: getBuildId

      - bash: |
          echo $(getBuildId.NATIVE_BUILD_ID)
          az pipelines run \
            --branch $(Build.SourceBranch) \
            --id  8467 \
            --parameters "NativeBuildNum=$(getBuildId.NATIVE_BUILD_NUM)" "BumpType=patch" "iTwinjsBranch=$(getBuildId.ITWINJS_BRANCH)"
        displayName: queue bump-version.yml
        env:
          AZURE_DEVOPS_EXT_PAT: $(System.AccessToken)
        condition: eq($(getBuildId.SKIP_ADDON), false)