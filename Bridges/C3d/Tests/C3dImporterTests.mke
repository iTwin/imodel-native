#---------------------------------------------------------------------------------------------
#  Copyright (c) Bentley Systems, Incorporated. All rights reserved.
#  See COPYRIGHT.md in the repository root for full copyright notice.
#---------------------------------------------------------------------------------------------
programName = C3dImporterTests
baseDir = $(_MakeFilePath)

DWGTOOLKIT = OpenDwg
VendorVersion = 200515

BEGTEST_INPUT=$(baseDir)

%include mdl.mki

TestDeliveryDir = $(ContextDeliveryDir)ImporterTests/
DwgVendorAPI    = $(BuildContext)VendorAPI/Teigha/
DwgTestsDir     = $(baseDir)../../Dwg/DwgConverter/Tests/

# We don't want to run the test from the build location because the dependencies are not there.
GUNITTEST_NOEXEC = 1

BEGTEST_NAME=$(programName)
BEGTEST_INPUT=$(baseDir)
BEGTEST_OUTPUT=$(OutputRootDir)build/C3dImporterTests/
%include $(SrcRoot)bsicommon/sharedmki/BeTestSelectHarness.mki

TestsHeaders = $(baseDir)C3dImporterTests.h $(baseDir)C3dImporterTestsFixture.h $(DwgTestsDir)DwgFileEditor.h

# Let all stand-alone tests share the same gtestmain and TestFixture objects.
o = $(BEGTEST_OUTPUT)

always:
    !~@mkdir $(o)

CCompOpts + -DDWGTOOLKIT_$(DWGTOOLKIT) -DVendorVersion=$(VendorVersion) -D_TOOLKIT_IN_DLL_ -DODA_NEED_TEMP_USING -DADT_DYNAMIC_BUILD -D_SILENCE_TR1_NAMESPACE_DEPRECATION_WARNING
CCompOpts + -I$(DwgVendorAPI) -I$(DwgVendorAPI)Kernel/Include/ -I$(DwgVendorAPI)Kernel/Extensions/ExServices/ -I$(DwgVendorAPI)Drawing/Include/ -I$(DwgVendorAPI)Architecture/ -I$(DwgVendorAPI)Civil/ -I$(DwgVendorAPI)FacetModeler/

MultiCompileDepends = $(_MakeFileSpec)
%include MultiCppCompileRule.mki

$(o)gtestmain.obj               : $(BEGTEST_INPUT)gtestmain.cpp $(TestsHeaders) ${MultiCompileDepends}

$(o)C3dImporterTests.obj        : $(BEGTEST_INPUT)C3dImporterTests.cpp $(TestsHeaders) ${MultiCompileDepends}

$(o)C3dImporterTestsFixture.obj : $(BEGTEST_INPUT)C3dImporterTestsFixture.cpp $(TestsHeaders) ${MultiCompileDepends}

$(o)DwgFileEditor.obj           : $(dwgTestsDir)DwgFileEditor.cpp $(TestsHeaders) ${MultiCompileDepends}

%include MultiCppCompileGo.mki

%undef CPchOpts
%undef CCPchOpts

GUNITTEST_OUT       = $(o)
GUNITTEST_NAME      = $(programName)
GUNITTEST_DEST      = $(o)
GUNITTEST_NTLIBS    = advapi32.lib ole32.lib ws2_32.lib Wininet.lib
GUNITTEST_PATH      = $(o)
GUNITTEST_SYMB      = $(o)
GTEST_MAIN_IS_SUPPLIED = 1

# This macro is used by gtestobj.mki
GUnitTestDir        = $(BuildContext)SubParts/google_gtest/
%include $(BuildContext)SubParts/google_gtest_mki/gtestobj.mki

LOCAL_GUNITTEST_OBJS + $(MultiCompileObjectList)
LOCAL_GUNITTEST_OBJS + $[@wildcard $(ContextSubpartsLibs)Be*.lib]
LOCAL_GUNITTEST_OBJS + $[@wildcard $(ContextSubpartsLibs)Dgn*.lib]
LOCAL_GUNITTEST_OBJS + $[@wildcard $(ContextSubpartsLibs)EC*.lib]
LOCAL_GUNITTEST_OBJS + $[@wildcard $(ContextSubpartsLibs)iModel*.lib]
LOCAL_GUNITTEST_OBJS + $[@wildcard $(ContextSubpartsLibs)Civil*.lib]
LOCAL_GUNITTEST_OBJS + $[@wildcard $(ContextSubpartsLibs)Road*.lib]
LOCAL_GUNITTEST_OBJS + $[@wildcard $(ContextSubpartsLibs)Teigha/TD_*.lib]
LOCAL_GUNITTEST_OBJS + $[@wildcard $(ContextSubpartsLibs)Teigha/Aec*.lib]
LOCAL_GUNITTEST_OBJS + $[@wildcard $(BuildContext)SubParts/Files/OpenDwg/*.lib]
LOCAL_GUNITTEST_OBJS + $(ContextSubpartsLibs)OpenDwgDbExchange.lib
LOCAL_GUNITTEST_OBJS + $(ContextSubpartsLibs)C3dImporter.lib
LOCAL_GUNITTEST_OBJS + $(ContextSubpartsLibs)Raster.lib

%include $(SharedMki)gunittest.mki

always:
    ~linkfile "$(TestDeliveryDir)$(programName).exe=$(o)$(programName).exe"

$(TestDeliveryDir)$(programName).logging.config.xml : $(baseDir)logging.config.xml
    $(LinkFirstDepToFirstTarget)

$(TestDeliveryDir)ignore_list.txt : $(baseDir)ignore_list.txt
    $(LinkFirstDepToFirstTarget)

$(TestDeliveryDir)TestData/ : $(baseDir)data/
    $(LinkFirstDepToFirstTargetAsDirectory)

# Create the sqlang database
SQLANG_OutputDb     = $(o)$(programName)_en-US.sqlang.db3
SQLANG_DeliveryDir  = $(TestDeliveryDir)
SQLANG_XliffWildcard=$(BuildContext)SubParts/xliffs/*.xliff
%include $(SrcRoot)bsicommon\sqlang\mki\XliffsToDb.mke
