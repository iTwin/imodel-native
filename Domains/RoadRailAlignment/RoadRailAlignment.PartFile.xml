<?xml version="1.0" encoding="utf-8"?>

<BuildContext xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="../../bsicommon/build/PartFile.xsd">

    <Part Name="RoadRailAlignment" BentleyBuildMakeFile="RoadRailAlignment.mke">
        <SubPart PartName="CivilBaseGeometry" PartFile="Domains/CivilGeometry/CivilBaseGeometry" Repository="imodel02"/> <!-- &&AG this is still WIP. Dependency to CivilBaseGeometry -->
        <SubPart PartName="PublicAPI"/>
        <SubPart PartName="LinearReferencing"            PartFile="Domains/LinearReferencing/LinearReferencing"         Repository="imodel02"/>
        <Bindings>
            <Libs Required="false">Delivery/$(libprefix)RoadRailAlignment$(libext)</Libs>
            <Assemblies Required="false">Delivery/$(shlibprefix)RoadRailAlignment$(shlibext)</Assemblies>
        </Bindings>
    </Part>

    <Part Name="PublicAPI" BentleyBuildMakeFile="RoadRailAlignment.prewire.mke">
        <SubPart PartName="RoadRailAlignmentSchema" PartFile="BisSchemas" Repository="BisSchemas"/>
        <Bindings>
            <PublicAPI Domain="RoadRailAlignment"/>
        </Bindings>
    </Part>

    <Part Name="RoadRailAlignmentPublishedApi" BentleyBuildMakeFile="${SrcRoot}bsicommon/sharedmki/PublishApi.mke"
          BMakeOptions="+dPUBLISHAPI_DELIVERY_DIR=Delivery/PublishedApi +dPUBLISHAPI_VENDORAPI2=rapidjson +dPUBLISHAPI_VENDORAPI3=folly" >
        <SubPart PartName="RoadRailAlignment"/>
        <Bindings>
            <Directory SourceName="Delivery/PublishedApi" SubPartDirectory="PublishedApi/RoadRailAlignment" ProductDirectoryName="PublishedApi" Required="false" />
        </Bindings>
    </Part>

    <Part Name="RoadRailAlignmentExtractions" DeferType="BuildDocs" BentleyBuildMakeFile="docs/RoadRailAlignmentExtractions.mke">
        <SubPart PartName="RoadRailAlignmentPublishedApi" />
        <Bindings>
            <Directory SourceName="Dox/Extractions/RoadRailAlignment" SubPartDirectory="Dox/Extractions/RoadRailAlignment" />
        </Bindings>
    </Part>

    <!-- ********************************************************************************************** -->
    <!-- Unit tests -->
    <!-- ********************************************************************************************** -->
    <Part Name="PrewireForUnitTests" BentleyBuildMakeFile="Tests/prewire.mke">
        <Bindings>
            <Files ProductDirectoryName="UnitTests-IgnoreList"  ProductSubDirectory="RoadRailAlignment" SubPartDirectory="UnitTests/RoadRailAlignment"> Delivery/UnitTests/ignore_list.txt</Files>
        </Bindings>
    </Part>

    <Part Name="BackdoorForUnitTests" BentleyBuildMakeFile="Tests/BuildTests.mke" BentleyBuildMakeOptions="-dTestDir=Backdoor">
        <SubPart PartName="RoadRailAlignment"/>
        <SubPart PartName="UnitsNative"                     PartFile="iModelCore/Units/Units"                     Repository="imodel02"/>
        <SubPart PartName="PrewireForUnitTests" />
        <Bindings>
            <Directory ProductDirectoryName="UnitTests-Objects"    ProductSubDirectory="RoadRailAlignment/Backdoor" SourceName="Delivery/UnitTests/Objects/Backdoor"/>
        </Bindings>
    </Part>

    <Part Name="UnitTests-NonPublished" BentleyBuildMakeFile="Tests/BuildTests.mke" BentleyBuildMakeOptions="-dTestDir=NonPublished">
        <SubPart PartName="BackdoorForUnitTests" />
        <Bindings>
            <Directory ProductDirectoryName="UnitTests-Objects"    ProductSubDirectory="RoadRailAlignment/NonPublished" SourceName="Delivery/UnitTests/Objects/NonPublished"/>
        </Bindings>
    </Part>

    <Part Name="UnitTests-Published" BentleyBuildMakeFile="Tests/BuildTests.mke" BentleyBuildMakeOptions="-dTestDir=Published">
        <SubPart PartName="BackdoorForUnitTests" />
        <Bindings>
            <Directory ProductDirectoryName="UnitTests-Objects"    ProductSubDirectory="RoadRailAlignment/Published" SourceName="Delivery/UnitTests/Objects/Published"/>
        </Bindings>
    </Part>

    <!-- Define the collection of all unit tests. -->
    <Part Name="Tests">
        <!-- Specify the unit tests to include in the test suite: -->
        <SubPart PartName="UnitTests-NonPublished"/>
        <SubPart PartName="UnitTests-Published"/>
    </Part>

    <Product Name="RoadRailAlignment-Tests">
        <!-- *** TRICKY: Must depend on a part in begtest repository, in order to use a productdirectorylist from there. -->
        <SubPart Repository="imodel02" PartFile="iModelCore/BeGTest/BeGTest" PartName="Base" />
        <SubPart PartName="Tests"/>
        <!-- Lay out the Tests test product according to the standard BeGTest layout: -->
        <Directories Repository="imodel02" PartFile="iModelCore/BeGTest/BeGTest" DirectoryListName="CollectionProduct"/>
        <Directories DirectoryListName="Tests"/>
    </Product>

    <ProductDirectoryList ListName="Tests">
        <ProductDirectory Name="ApplicationRoot" Path=""/>
    </ProductDirectoryList>

    <!-- Build a gtest exe to run the tests -->
    <Product Name="Gtest-RoadRailAlignment-Tests">
        <Directories DirectoryListName="GtestProduct" Repository="imodel02" PartFile="iModelCore/BeGTest/BeGTest"/>
        <SubPart PartName="Gtest"/>
    </Product>

    <Part Name="Gtest" BentleyBuildMakeFile="$(BuildContext)/SubParts/BeGTest/gtest/buildGTest.mke" BentleyBuildMakeOptions="-dTEST_NAME=RoadRailAlignmentTests -dTEST_COLLECTION_PRODUCT=RoadRailAlignment-Tests -dTEST_FRAMEWORK_SQLANG=RoadRailAlignment_en.sqlang.db3" OnlyPlatforms="x86,x64,MacOs*,Linux*">
        <SubProduct ProductName="RoadRailAlignment-Tests"/>
        <SubPart PartName="Gtest-Tools" Repository="imodel02" PartFile="iModelCore/BeGTest/BeGTest"/>
        <Bindings>
            <Files ProductDirectoryName="Gtest-NativeAssemblies">Delivery/Gtest/RoadRailAlignmentTests/Assemblies/*</Files>
            <Directory ProductDirectoryName="Gtest-Assets" SourceName="Delivery/Gtest/RoadRailAlignmentTests/Assets" />
        </Bindings>
    </Part>

    <Part Name="RunGtest" BentleyBuildMakeFile="$(BuildContext)/SubParts/BeGTest/gtest/RunGTest.mke" DeferType="RunUnitTests" BentleyBuildMakeOptions="-dGTEST_PRODUCT=Gtest-RoadRailAlignment-Tests -dGTEST_NAME=RoadRailAlignmentTests -dGTEST_SHOW_PROGRESS" OnlyPlatforms="x86,x64,MacOs*,Linux*">
        <SubProduct ProductName="Gtest-RoadRailAlignment-Tests" />
        <SubPart PartName="Gtest-Tools" Repository="imodel02" PartFile="iModelCore/BeGTest/BeGTest"/>
    </Part>
    
    <!-- iOS XCTest -->
    
    <Product Name="iOSXCTest-RoadRailAlignment-Tests">
        <SubPart PartName="iOSXCTest" LibType="Static" />
        <Directories DirectoryListName="iOSXCTestProduct" Repository="imodel02" PartFile="iModelCore/BeGTest/BeGTest" />
    </Product>
    
    <Part Name="iOSXCTest-Run" OnlyPlatforms="iOSARM*" BentleyBuildMakeFile="$(BuildContext)/SubParts/BeGTest/iOS//CheckLogfilesForFailures.mke" BentleyBuildMakeOptions="-dLogFilesDir=$(BuildContext)SubParts/XCTest/Logs" >
        <SubPart PartName="RuniOSXCTest" LibType="Static" />
    </Part>
    
    <Part Name="RuniOSXCTest" DeferType="RunUnitTests" BentleyBuildMakeFile="$(BuildContext)/SubParts/BeGTest/iOS//RunXCTestProject.mke" BentleyBuildMakeOptions="-dXCTEST_PRODUCT=iOSXCTest-RoadRailAlignment-Tests -dTEST_NAME=RoadRailAlignmentTests -dIOSXCTEST_SHOW_PROGRESS=1 -dUSE_STATIC_LIBRARIES=1" OnlyPlatforms="iOS*" >
        <SubProduct ProductName="iOSXCTest-RoadRailAlignment-Tests" />
        <Bindings>
            <Files Required="false" SubPartDirectory="XCTest/Logs">Delivery/XCTest/Logs/iOSXCTest-RoadRailAlignment-Tests.log</Files>
        </Bindings>
    </Part>
    
    <Part Name="iOSXCTest" DeferType="BuildUnitTests" BentleyBuildMakeFile="$(BuildContext)/SubParts/BeGTest/iOS//MakeXCTestProject.mke" BentleyBuildMakeOptions="-dTEST_NAME=RoadRailAlignmentTests -dTEST_COLLECTION_PRODUCT=RoadRailAlignment-Tests -dTEST_FRAMEWORK_SQLANG=RoadRailAlignment_en.sqlang.db3 -dUSE_STATIC_LIBRARIES=1" OnlyPlatforms="iOSARM*">
        <SubProduct ProductName="RoadRailAlignment-Tests" />
        <SubPart PartName="iOSXCTest-Tools" Repository="imodel02" PartFile="iModelCore/BeGTest/BeGTest" />
        <Bindings>
            <Directory ProductDirectoryName="iOSXCTestProject" SourceName="Delivery/iOSXCTest/RoadRailAlignmentTests/Project" />
        </Bindings>
    </Part>

    <!-- This part runs RoadRailAlignmentTests on platforms that support it. -->
    <Part Name="RoadRailAlignment-Tested">
        <SubPart PartName="RunGtest" />
        <SubPart PartName="RuniOSXCTest" LibType="Static" />
    </Part>

</BuildContext>
