<?xml version="1.0" encoding="utf-8"?>

<BuildContext xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="../../bsicommon/build/PartFile.xsd">

  <!-- //////////////////////////////////////////////////////////////////////////////////////////////////// -->
  <!-- CivilBaseGeometry consumable part -->
  <!-- //////////////////////////////////////////////////////////////////////////////////////////////////// -->
  <Part Name="CivilBaseGeometry">
    <SubPart PartName="CivilBaseGeometryNonStatic"/>
    <SubPart PartName="CivilBaseGeometryStatic"/>
  </Part>

  <Part Name="CivilBaseGeometryNonStatic" ExcludePlatforms="Android*,iOS*" Scope="Private">
    <SubPart PartName="CivilBaseGeometryDll"/>
  </Part>
  <Part Name="CivilBaseGeometryStatic" OnlyPlatforms="Android*,iOS*" Scope="Private">
    <SubPart PartName="CivilBaseGeometryDll" LibType="Static"/>
  </Part>

  
  <!-- Bind my own PublicAPI into BuildContext/PublicAPI. Note that this part does not cause any sub-part PublicAPIs to be bound. -->
  <Part Name="PublicAPI" BentleyBuildMakeFile="CivilBaseGeometry/prewire.mke" Scope="Private">
    <Bindings>
      <PublicAPI Domain="CivilBaseGeometry"/>
    </Bindings>
  </Part>

  <Part Name="CivilBaseGeometryDll" BentleyBuildMakeFile="CivilBaseGeometry/CivilBaseGeometry.mke" Scope="Private">
    <SubPart PartName="BentleyDll" PartFile="Bentley" Repository="Bentley" />
    <SubPart PartName="GeomDlls" PartFile="geomlibs" Repository="GeomLibs" />
    <SubPart PartName="GeomlibsSerialization" PartFile="geomlibs" Repository="GeomLibs"/>
    <SubPart PartName="PublicAPI"/>
    <Bindings>
      <Libs>Delivery/$(libprefix)CivilBaseGeometry$(libext)</Libs>
      <Assemblies>Delivery/$(shlibprefix)CivilBaseGeometry$(shlibext)</Assemblies>
    </Bindings>
  </Part>


  <Part Name="CivilBaseGeometryPublishedApi" BentleyBuildMakeFile="${SrcRoot}bsicommon/sharedmki/PublishApi.mke" BMakeOptions="+dPUBLISHAPI_DELIVERY_DIR=Delivery/PublishedApi">
    <SubPart PartName="CivilBaseGeometry" />
    <Bindings>
      <Directory SourceName="Delivery/PublishedApi" SubPartDirectory="PublishedApi/CivilBaseGeometry" ProductDirectoryName="PublishedApi" Required="false" />
    </Bindings>
  </Part>

  <!-- ********************************************************************************************** -->
  <!-- Unit tests -->
  <!-- ********************************************************************************************** -->
  <Part Name="PrewireForUnitTests" BentleyBuildMakeFile="CivilBaseGeometry/Tests/prewire.mke" Scope="Private">
    <SubPart PartName="CivilBaseGeometry"/>
    <Bindings>
      <Files ProductDirectoryName="UnitTests-IgnoreList"  ProductSubDirectory="CivilBaseGeometry" SubPartDirectory="UnitTests/CivilBaseGeometry"> Delivery/UnitTests/ignore_list.txt</Files>
    </Bindings>
  </Part>
  <Part Name="UnitTests-NonPublished" BentleyBuildMakeFile="CivilBaseGeometry/Tests/BuildTests.mke" BentleyBuildMakeOptions="-dTestDir=NonPublished" Scope="Private">
    <SubPart PartName="PrewireForUnitTests" />
    <Bindings>
      <Directory ProductDirectoryName="UnitTests-Objects" ProductSubDirectory="CivilBaseGeometry/NonPublished" SourceName="Delivery/UnitTests/Objects/NonPublished"/>
    </Bindings>
  </Part>

  <!-- Define the collection of all unit tests. -->
  <Part Name="Tests" Scope="Private">
    <SubPart PartName="UnitTests-NonPublished"/>
  </Part>

  <Product Name="CivilBaseGeometry-Tests" Scope="Private">
    <SubPart PartName="Base" Repository="BeGTest" PartFile="BeGTest"/>
    <SubPart PartName="Tests"/>
    <!-- Lay out the Tests test product according to the standard BeGTest layout: -->
    <Directories DirectoryListName="CollectionProduct" Repository="BeGTest" PartFile="BeGTest"/>
  </Product>

  <Part Name="CivilBaseGeometry-Gtest" BentleyBuildMakeFile="${SrcRoot}BeGTest/gtest/buildGTest.mke" BentleyBuildMakeOptions="
      -dTEST_NAME=CivilBaseGeometryTests
      -dTEST_COLLECTION_PRODUCT=CivilBaseGeometry-Tests" OnlyPlatforms="x64" Scope="Private">
    <SubProduct ProductName="CivilBaseGeometry-Tests"/>
    <SubPart PartName="Gtest-Tools" Repository="BeGTest" PartFile="BeGTest"/>
    <Bindings>
      <Files ProductDirectoryName="Gtest-NativeAssemblies">Delivery/Gtest/CivilBaseGeometryTests/Assemblies/*</Files>
      <Directory ProductDirectoryName="Gtest-Assets" SourceName="Delivery/Gtest/CivilBaseGeometryTests/Assets" />
    </Bindings>
  </Part>

  <!-- Build a gtest exe to run the tests -->
  <Product Name="CivilBaseGeometry-Gtest" Scope="Private">
      <SubPart PartName="CivilBaseGeometry-Gtest"/>
      <Directories DirectoryListName="GtestProduct" Repository="BeGTest" PartFile="BeGTest"/>
  </Product>

  <!-- This part runs the test on x64 -->
  <Part Name="RunGTest" DeferType="RunUnitTests" BentleyBuildMakeFile="${SrcRoot}BeGTest/gtest/RunGTest.mke" BentleyBuildMakeOptions="
    -dGTEST_PRODUCT=CivilBaseGeometry-Gtest
    -dGTEST_NAME=CivilBaseGeometryTests
    -dGTEST_SHOW_PROGRESS" Scope="Private" OnlyPlatforms="x64">
      <SubProduct ProductName="CivilBaseGeometry-Gtest" />
  </Part>

  <!--This part runs the test on x64 and produces a code coverage report -->
  <Part Name="CoveredGTest" DeferType="RunUnitTests" BentleyBuildMakeFile="CivilBaseGeometry/Tests/CodeCoverage.mke" BentleyBuildMakeOptions="
      -dProductName=CivilBaseGeometry
      -dCodeSourceDir=${SrcRoot}\Civil\Geometry\CivilBaseGeometry\
      -dFailIfCoverageNotMet=0
      -dMinimumCoverage=.6" OnlyPlatforms="x64" Scope="Private">
    <SubProduct ProductName="CivilBaseGeometry-Gtest" />
  </Part>
  
  <!-- iOS XCTest -->
  <Product Name="iOSXCTest-CivilBaseGeometry-Tests" Scope="Private">
    <SubPart PartName="iOSXCTest" LibType="Static" />
    <Directories DirectoryListName="iOSXCTestProduct" Repository="BeGTest" PartFile="BeGTest" />
  </Product>
    
  <Part Name="iOSXCTest-Run" OnlyPlatforms="iOSARM*" BentleyBuildMakeFile="${SrcRoot}BeGTest/iOS/CheckLogfilesForFailures.mke" BentleyBuildMakeOptions="
      -dLogFilesDir=$(BuildContext)SubParts/XCTest/Logs" Scope="Private" >
    <SubPart PartName="RuniOSXCTest" LibType="Static" />
  </Part>
    
  <Part Name="RuniOSXCTest" DeferType="RunUnitTests" BentleyBuildMakeFile="${SrcRoot}BeGTest/iOS/RunXCTestProject.mke" BentleyBuildMakeOptions="
      -dXCTEST_PRODUCT=iOSXCTest-CivilBaseGeometry-Tests
      -dTEST_NAME=CivilBaseGeometryTests
      -dIOSXCTEST_SHOW_PROGRESS=1
      -dUSE_STATIC_LIBRARIES=1" OnlyPlatforms="iOS*" Scope="Private">
    <SubProduct ProductName="iOSXCTest-CivilBaseGeometry-Tests" />
    <Bindings>
        <Files Required="false" SubPartDirectory="XCTest/Logs">Delivery/XCTest/Logs/iOSXCTest-CivilBaseGeometry-Tests.log</Files>
    </Bindings>
  </Part>
    
  <Part Name="iOSXCTest" DeferType="BuildUnitTests" BentleyBuildMakeFile="${SrcRoot}BeGTest/iOS/MakeXCTestProject.mke" BentleyBuildMakeOptions="
      -dTEST_NAME=CivilBaseGeometryTests
      -dTEST_COLLECTION_PRODUCT=CivilBaseGeometry-Tests
      -dUSE_STATIC_LIBRARIES=1" OnlyPlatforms="iOSARM*" Scope="Private">
    <SubProduct ProductName="CivilBaseGeometry-Tests" />
    <SubPart PartName="iOSXCTest-Tools" Repository="BeGTest" PartFile="BeGTest" />
    <Bindings>
      <Directory ProductDirectoryName="iOSXCTestProject" SourceName="Delivery/iOSXCTest/CivilBaseGeometryTests/Project" />
    </Bindings>
  </Part>

    <!-- This part runs CivilBaseGeometryTests on platforms that support it. -->
    <Part Name="CivilBaseGeometry-Tested" Scope="Private">
      <RequiredRepository>Bsitools-OpenCppCoverage</RequiredRepository>
      <SubPart PartName="RunGTest" />
      <SubPart PartName="RuniOSXCTest" LibType="Static" />
      <SubPart PartName="CoveredGTest" />
    </Part>
  
</BuildContext>
